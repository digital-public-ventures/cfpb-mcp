timestamp_utc: 2025-12-21T23:21:24.441759+00:00
python: /Users/jim/cfpb-mcp/.venv/bin/python
target: /Users/jim/cfpb-mcp

=== ruff check --fix ===
cmd: ruff check --fix /Users/jim/cfpb-mcp
exit_code: 1
--- stdout ---
ANN201 Missing return type annotation for public function `map_api_params_to_url_params`
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |
help: Add return type annotation

D103 Missing docstring in public function
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN001 Missing type annotation for function argument `api_params`
  --> citations_mapping.py:14:34
   |
14 | def map_api_params_to_url_params(api_params):
   |                                  ^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN201 Missing return type annotation for public function `demo_url_generation`
  --> scripts/demo_cfpb_ui.py:10:5
   |
10 | def demo_url_generation():
   |     ^^^^^^^^^^^^^^^^^^^
11 |     """Demonstrate URL generation for the official CFPB dashboard."""
12 |     print("=" * 70)
   |
help: Add return type annotation: `None`

INP001 File `scripts/run_tests.py` is part of an implicit namespace package. Add an `__init__.py`.
--> scripts/run_tests.py:1:1

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:17
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:33
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH100 `os.path.abspath()` should be replaced by `Path.resolve()`
  --> scripts/run_tests.py:21:49
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).resolve()`

PLR0911 Too many return statements (7 > 6)
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description="Run pytest suites for this repo (unit/integration/slow/contract/full)."
   |

D103 Missing docstring in public function
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description="Run pytest suites for this repo (unit/integration/slow/contract/full)."
   |

RUF005 Consider `[*default_args, "-m", "unit", *extra]` instead of concatenation
  --> scripts/run_tests.py:56:24
   |
55 |     if ns.suite == "unit":
56 |         return _pytest(default_args + ["-m", "unit"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
57 |
58 |     if ns.suite == "integration":
   |
help: Replace with `[*default_args, "-m", "unit", *extra]`

RUF005 Consider `[*default_args, "-m", "integration", *extra]` instead of concatenation
  --> scripts/run_tests.py:60:24
   |
58 |     if ns.suite == "integration":
59 |         # Includes anything under tests/ except slow/unit/contract.
60 |         return _pytest(default_args + ["-m", "integration"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |     if ns.suite == "slow":
   |
help: Replace with `[*default_args, "-m", "integration", *extra]`

RUF005 Consider `[*default_args, "-m", "slow", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:63:24
   |
62 |     if ns.suite == "slow":
63 |         return _pytest(default_args + ["-m", "slow", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |
65 |     if ns.suite == "contract":
   |
help: Replace with `[*default_args, "-m", "slow", "-rs", *extra]`

RUF005 Consider `[*default_args, "-m", "contract", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:66:24
   |
65 |     if ns.suite == "contract":
66 |         return _pytest(default_args + ["-m", "contract", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     if ns.suite == "full":
   |
help: Replace with `[*default_args, "-m", "contract", "-rs", *extra]`

RUF005 Consider `[*default_args, "-m", "unit", *extra]` instead of concatenation
  --> scripts/run_tests.py:70:22
   |
68 |     if ns.suite == "full":
69 |         # Run unit, then integration, then slow.
70 |         rc = _pytest(default_args + ["-m", "unit"] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
71 |         if rc != 0:
72 |             return rc
   |
help: Replace with `[*default_args, "-m", "unit", *extra]`

RUF005 Consider `[*default_args, "-m", "integration", *extra]` instead of concatenation
  --> scripts/run_tests.py:74:22
   |
72 |             return rc
73 |
74 |         rc = _pytest(default_args + ["-m", "integration"] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
75 |         if rc != 0:
76 |             return rc
   |
help: Replace with `[*default_args, "-m", "integration", *extra]`

RUF005 Consider `[*default_args, "-m", "slow", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:77:24
   |
75 |         if rc != 0:
76 |             return rc
77 |         return _pytest(default_args + ["-m", "slow", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |
79 |     _die(f"Unknown suite: {ns.suite}")
   |
help: Replace with `[*default_args, "-m", "slow", "-rs", *extra]`

INP001 File `tests/conftest.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/conftest.py:1:1

ARG001 Unused function argument: `config`
  --> tests/conftest.py:16:5
   |
15 | def pytest_collection_modifyitems(
16 |     config: pytest.Config, items: list[pytest.Item]
   |     ^^^^^^
17 | ) -> None:
18 |     """Apply suite markers based on file path.
   |

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/conftest.py:48:29
   |
46 |     try:
47 |         r = httpx.get(f"{url}/", timeout=5)
48 |         if r.status_code != 200:
   |                             ^^^
49 |             return False
50 |         payload = r.json()
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:59:15
   |
57 |     parsed = urlparse(url)
58 |     if parsed.scheme not in {"http", "https"}:
59 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     if not parsed.hostname or parsed.port is None:
61 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:59:26
   |
57 |     parsed = urlparse(url)
58 |     if parsed.scheme not in {"http", "https"}:
59 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     if not parsed.hostname or parsed.port is None:
61 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:61:15
   |
59 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
60 |     if not parsed.hostname or parsed.port is None:
61 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
62 |     return str(parsed.hostname), int(parsed.port)
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:61:26
   |
59 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
60 |     if not parsed.hostname or parsed.port is None:
61 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
62 |     return str(parsed.hostname), int(parsed.port)
   |
help: Assign to variable; remove f-string literal

C901 `server_url` is too complex (16 > 10)
  --> tests/conftest.py:66:5
   |
65 | @pytest.fixture(scope="session")
66 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
67 |     """Start uvicorn in a subprocess and return the base URL."""
68 |     configured_url = os.environ.get("TEST_SERVER_URL")
   |

PLR0912 Too many branches (17 > 12)
  --> tests/conftest.py:66:5
   |
65 | @pytest.fixture(scope="session")
66 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
67 |     """Start uvicorn in a subprocess and return the base URL."""
68 |     configured_url = os.environ.get("TEST_SERVER_URL")
   |

PLR0915 Too many statements (55 > 50)
  --> tests/conftest.py:66:5
   |
65 | @pytest.fixture(scope="session")
66 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
67 |     """Start uvicorn in a subprocess and return the base URL."""
68 |     configured_url = os.environ.get("TEST_SERVER_URL")
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:86:23
   |
84 |               host, port = _parse_host_port(url)
85 |               if host not in {"127.0.0.1", "localhost"}:
86 |                   raise RuntimeError(
   |  _______________________^
87 | |                     f"TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; "
88 | |                     "refusing to auto-start uvicorn."
89 | |                 )
   | |_________________^
90 |       else:
91 |           port = _pick_free_port()
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:87:21
   |
85 |               if host not in {"127.0.0.1", "localhost"}:
86 |                   raise RuntimeError(
87 | /                     f"TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; "
88 | |                     "refusing to auto-start uvicorn."
   | |_____________________________________________________^
89 |                   )
90 |       else:
   |
help: Assign to variable; remove f-string literal

SIM115 Use a context manager for opening files
   --> tests/conftest.py:105:16
    |
104 |     # Create a log file for the server process to avoid pipe buffer deadlocks
105 |     log_file = open("server_test.log", "w")
    |                ^^^^
106 |
107 |     proc = subprocess.Popen(
    |

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:105:16
    |
104 |     # Create a log file for the server process to avoid pipe buffer deadlocks
105 |     log_file = open("server_test.log", "w")
    |                ^^^^
106 |
107 |     proc = subprocess.Popen(
    |
help: Replace with `Path.open()`

S603 `subprocess` call: check for execution of untrusted input
   --> tests/conftest.py:107:12
    |
105 |     log_file = open("server_test.log", "w")
106 |
107 |     proc = subprocess.Popen(
    |            ^^^^^^^^^^^^^^^^
108 |         [
109 |             sys.executable,
    |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:120:13
    |
118 |             "warning",
119 |         ],
120 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |             ^^^^^^^^^^^^^^^
121 |         env=env,
122 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:120:29
    |
118 |             "warning",
119 |         ],
120 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |                             ^^^^^^^^^^^^^^^
121 |         env=env,
122 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:143:18
    |
141 |             # If it failed, read the log file
142 |             log_file.close()
143 |             with open("server_test.log") as f:
    |                  ^^^^
144 |                 output = f.read()
145 |             raise RuntimeError(
    |
help: Replace with `Path.open()`

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:145:19
    |
143 |               with open("server_test.log") as f:
144 |                   output = f.read()
145 |               raise RuntimeError(
    |  ___________________^
146 | |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
147 | |             )
    | |_____________^
148 |
149 |           # Final readiness check
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:146:17
    |
144 |                 output = f.read()
145 |             raise RuntimeError(
146 |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
147 |             )
    |
help: Assign to variable; remove f-string literal

E501 Line too long (122 > 120)
   --> tests/conftest.py:146:121
    |
144 |                 output = f.read()
145 |             raise RuntimeError(
146 |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
    |                                                                                                                         ^^
147 |             )
    |

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:151:19
    |
149 |           # Final readiness check
150 |           if not _is_server_ready(url):
151 |               raise RuntimeError(
    |  ___________________^
152 | |                 f"Server failed to become ready on {url}. Last error: {last_err}."
153 | |             )
    | |_____________^
154 |
155 |           yield url
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:152:17
    |
150 |         if not _is_server_ready(url):
151 |             raise RuntimeError(
152 |                 f"Server failed to become ready on {url}. Last error: {last_err}."
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
153 |             )
    |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
   --> tests/conftest.py:172:5
    |
171 | @pytest.fixture
172 | def client(server_url: str) -> Iterator[httpx.Client]:
    |     ^^^^^^
173 |     with httpx.Client(base_url=server_url, timeout=30) as c:
174 |         yield c
    |

INP001 File `tests/contract/test_anthropic_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_anthropic_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_anthropic_mcp_contract.py:22:16
   |
20 | def _load_dotenv_if_present() -> None:
21 |     """Load .env for local runs without requiring external tooling."""
22 |     env_path = os.path.join(os.getcwd(), ".env")
   |                ^^^^^^^^^^^^
23 |     if not os.path.exists(env_path):
24 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_anthropic_mcp_contract.py:22:29
   |
20 | def _load_dotenv_if_present() -> None:
21 |     """Load .env for local runs without requiring external tooling."""
22 |     env_path = os.path.join(os.getcwd(), ".env")
   |                             ^^^^^^^^^
23 |     if not os.path.exists(env_path):
24 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_anthropic_mcp_contract.py:23:12
   |
21 |     """Load .env for local runs without requiring external tooling."""
22 |     env_path = os.path.join(os.getcwd(), ".env")
23 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
24 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_anthropic_mcp_contract.py:27:14
   |
26 |     try:
27 |         with open(env_path, encoding="utf-8") as f:
   |              ^^^^
28 |             for raw_line in f:
29 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

ANN001 Missing type annotation for function argument `blocks`
  --> tests/contract/test_anthropic_mcp_contract.py:42:19
   |
42 | def _extract_text(blocks) -> str:
   |                   ^^^^^^
43 |     if not isinstance(blocks, list):
44 |         return str(blocks or "")
   |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `payload`
  --> tests/contract/test_anthropic_mcp_contract.py:52:32
   |
52 | def _tool_result_text(payload: Any) -> str:
   |                                ^^^
53 |     if payload is None:
54 |         return ""
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:89:5
   |
87 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
88 |     matches = re.findall(r"\b\d{4,9}\b", text or "")
89 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
   |     ^^^^^^
90 |     token = max(matches, key=len)
91 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:91:5
   |
89 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
90 |     token = max(matches, key=len)
91 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
92 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:91:12
   |
89 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
90 |     token = max(matches, key=len)
91 |     assert 4 <= len(token) <= 9
   |            ^
92 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:91:31
   |
89 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
90 |     token = max(matches, key=len)
91 |     assert 4 <= len(token) <= 9
   |                               ^
92 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_anthropic_mcp_contract.py:95:5
   |
95 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
96 |     if not isinstance(payload, dict):
97 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:119:8
    |
117 |     except ValueError:
118 |         return None
119 |     if 4 <= len(str(cid_int)) <= 9:
    |        ^
120 |         return cid_int
121 |     return None
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:119:34
    |
117 |     except ValueError:
118 |         return None
119 |     if 4 <= len(str(cid_int)) <= 9:
    |                                  ^
120 |         return cid_int
121 |     return None
    |

C901 `test_anthropic_mcp_tool_loop_smoke` is too complex (12 > 10)
   --> tests/contract/test_anthropic_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (62 > 50)
   --> tests/contract/test_anthropic_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_anthropic_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:141:121
    |
139 |     user_prompt = (
140 |         "I'm researching CFPB consumer complaints about loan forbearance. "
141 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
142 |         "the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. "
143 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_anthropic_mcp_contract.py:151:5
    |
150 |       # Connect using Streamable HTTP client
151 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
152 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
153 |               await mcp.initialize()
154 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

ERA001 Found commented-out code
   --> tests/contract/test_anthropic_mcp_contract.py:188:17
    |
186 |                 )
187 |
188 |                 # tool_uses = [c for c in resp.content if getattr(c, "type", None) == "tool_use"]
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
189 |                 tool_uses: list[ToolUseBlock] = [
190 |                     c for c in resp.content if isinstance(c, ToolUseBlock)
    |
help: Remove commented-out code

E501 Line too long (161 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:203:121
    |
201 | …
202 | …
203 | … now (complaint id, company, state if present, and a 2-3 sentence grounded summary).",
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
204 | …
205 | …
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:247:13
    |
245 |                 (m for m in reversed(messages) if m.get("role") == "assistant"), None
246 |             )
247 |             assert last_assistant is not None
    |             ^^^^^^
248 |             text = _extract_text(last_assistant.get("content"))
249 |             assert text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:249:13
    |
247 |             assert last_assistant is not None
248 |             text = _extract_text(last_assistant.get("content"))
249 |             assert text
    |             ^^^^^^
250 |             assert "MCP tools unavailable" not in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:250:13
    |
248 |             text = _extract_text(last_assistant.get("content"))
249 |             assert text
250 |             assert "MCP tools unavailable" not in text
    |             ^^^^^^
251 |
252 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:254:13
    |
252 |             final_text = text
253 |
254 |             assert complaint_id_from_tools is not None, (
    |             ^^^^^^
255 |                 "Expected the agent to obtain a complaint id via tools"
256 |             )
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:257:13
    |
255 |                 "Expected the agent to obtain a complaint id via tools"
256 |             )
257 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
258 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:257:20
    |
255 |                 "Expected the agent to obtain a complaint id via tools"
256 |             )
257 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
258 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:257:62
    |
255 |                 "Expected the agent to obtain a complaint id via tools"
256 |             )
257 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
258 |             assert str(complaint_id_from_tools) in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:258:13
    |
256 |             )
257 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
258 |             assert str(complaint_id_from_tools) in text
    |             ^^^^^^
259 |
260 |             # Keep the original "must contain a 4-9 digit integer" guard, but validate
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:263:13
    |
261 |             # it matches the tool-derived complaint id for stability.
262 |             complaint_id, _ = _extract_complaint_id_from_text(text)
263 |             assert complaint_id == complaint_id_from_tools
    |             ^^^^^^
264 |
265 |             doc_result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:272:5
    |
270 |             complaint_doc = _coerce_json(doc_payload) or doc_payload
271 |
272 |     assert final_text is not None
    |     ^^^^^^
273 |     assert complaint_id_from_tools is not None
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:273:5
    |
272 |     assert final_text is not None
273 |     assert complaint_id_from_tools is not None
    |     ^^^^^^
274 |
275 |     company = _extract_company_from_document(complaint_doc)
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:281:5
    |
279 |         )
280 |     first_word = company.split()[0].lower()
281 |     assert first_word in final_text.lower()
    |     ^^^^^^
    |

INP001 File `tests/contract/test_openai_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_openai_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_openai_mcp_contract.py:17:16
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), ".env")
   |                ^^^^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_openai_mcp_contract.py:17:29
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), ".env")
   |                             ^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_openai_mcp_contract.py:18:12
   |
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), ".env")
18 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
19 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_openai_mcp_contract.py:22:14
   |
21 |     try:
22 |         with open(env_path, encoding="utf-8") as f:
   |              ^^^^
23 |             for raw_line in f:
24 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:39:5
   |
37 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
38 |     matches = re.findall(r"\b\d{4,9}\b", text or "")
39 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
   |     ^^^^^^
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:41:5
   |
39 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:12
   |
39 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |            ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:31
   |
39 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |                               ^
42 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_openai_mcp_contract.py:63:5
   |
63 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |     if not isinstance(payload, dict):
65 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:8
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
88 |         return cid_int
89 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:34
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
88 |         return cid_int
89 |     return None
   |

C901 `test_openai_mcp_tool_loop_smoke` is too complex (20 > 10)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

PLR0912 Too many branches (21 > 12)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (82 > 50)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_openai_mcp_contract.py:139:121
    |
137 |     prompt = (
138 |         "I'm researching CFPB consumer complaints about loan forbearance. "
139 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
140 |         "the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. "
141 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_openai_mcp_contract.py:149:5
    |
147 |       tool_calls_seen = False
148 |
149 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
150 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
151 |               await mcp.initialize()
152 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:246:13
    |
245 |             text = (resp.output_text or "").strip()
246 |             assert text, "Expected a final answer"
    |             ^^^^^^
247 |             assert "MCP tools unavailable" not in text
248 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:247:13
    |
245 |             text = (resp.output_text or "").strip()
246 |             assert text, "Expected a final answer"
247 |             assert "MCP tools unavailable" not in text
    |             ^^^^^^
248 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:263:13
    |
261 |                 )
262 |
263 |             assert complaint_id_from_tools is not None, (
    |             ^^^^^^
264 |                 "Expected the agent to obtain a complaint id via tools"
265 |             )
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:266:13
    |
264 |                 "Expected the agent to obtain a complaint id via tools"
265 |             )
266 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
267 |
268 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:266:20
    |
264 |                 "Expected the agent to obtain a complaint id via tools"
265 |             )
266 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
267 |
268 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:266:62
    |
264 |                 "Expected the agent to obtain a complaint id via tools"
265 |             )
266 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
267 |
268 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:271:17
    |
269 |             if str(complaint_id_from_tools) in text:
270 |                 complaint_id_for_validation = complaint_id_from_tools
271 |                 assert complaint_id_from_text == complaint_id_from_tools
    |                 ^^^^^^
272 |             else:
273 |                 complaint_id_for_validation = complaint_id_from_text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:285:5
    |
283 |         pytest.skip(f"Complaint {complaint_id_from_tools} document missing company field")
284 |     first_word = company.split()[0].lower()
285 |     assert first_word in (final_text or "").lower()
    |     ^^^^^^
    |

INP001 File `tests/playwright_helpers.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/playwright_helpers.py:1:1

ANN201 Missing return type annotation for public function `fast_playwright_context`
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |
help: Add return type annotation

D103 Missing docstring in public function
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |

PLC0415 `import` should be at the top-level of a file
  --> tests/playwright_helpers.py:9:9
   |
 7 | async def fast_playwright_context():
 8 |     try:
 9 |         from playwright.async_api import async_playwright
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/playwright_helpers.py:11:15
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/playwright_helpers.py:11:28
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |
help: Assign to variable; remove f-string literal

ANN202 Missing return type annotation for private function `_block_heavy_assets`
  --> tests/playwright_helpers.py:17:19
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                   ^^^^^^^^^^^^^^^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |
help: Add return type annotation: `None`

ANN001 Missing type annotation for function argument `route`
  --> tests/playwright_helpers.py:17:39
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                       ^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |

ANN001 Missing type annotation for function argument `request`
  --> tests/playwright_helpers.py:17:46
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                              ^^^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |

INP001 File `tests/test_citations.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_citations.py:1:1

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> tests/test_citations.py:5:29
  |
3 | import asyncio
4 | import re
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from datetime import date
7 | from typing import Any
  |
help: Move into type-checking block

TRY003 Avoid specifying long messages outside the exception class
   --> tests/test_citations.py:133:11
    |
131 |         if match:
132 |             return int(match.group(1).replace(",", ""))
133 |     raise ValueError("Unable to locate matches-out-of count in UI text.")
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |

EM101 Exception must not use a string literal, assign to variable first
   --> tests/test_citations.py:133:22
    |
131 |         if match:
132 |             return int(match.group(1).replace(",", ""))
133 |     raise ValueError("Unable to locate matches-out-of count in UI text.")
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
help: Assign to variable; remove string literal

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
   --> tests/test_citations.py:140:32
    |
138 | ) -> int:
139 |     response = await client.get(BASE_URL, params=api_params)
140 |     if response.status_code != 200:
    |                                ^^^
141 |         pytest.fail(f"API call failed: {response.url} ({response.status_code})")
    |

D103 Missing docstring in public function
   --> tests/test_citations.py:155:11
    |
154 | @pytest.fixture(scope="module")
155 | async def api_client() -> httpx.AsyncClient:
    |           ^^^^^^^^^^
156 |     async with httpx.AsyncClient(timeout=20.0) as client:
157 |         yield client
    |

ANN201 Missing return type annotation for public function `ui_context`
   --> tests/test_citations.py:161:11
    |
160 | @pytest.fixture(scope="module")
161 | async def ui_context():
    |           ^^^^^^^^^^
162 |     try:
163 |         async with fast_playwright_context() as context:
    |
help: Add return type annotation

D103 Missing docstring in public function
   --> tests/test_citations.py:161:11
    |
160 | @pytest.fixture(scope="module")
161 | async def ui_context():
    |           ^^^^^^^^^^
162 |     try:
163 |         async with fast_playwright_context() as context:
    |

ANN201 Missing return type annotation for public function `test_map_api_params_to_url_params_examples`
   --> tests/test_citations.py:170:5
    |
169 | @pytest.mark.fast
170 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
171 |     api_params = {
172 |         "search_term": "mortgage",
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:170:5
    |
169 | @pytest.mark.fast
170 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
171 |     api_params = {
172 |         "search_term": "mortgage",
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:179:5
    |
177 |     }
178 |     mapped = map_api_params_to_url_params(api_params)
179 |     assert mapped["searchText"] == "mortgage"
    |     ^^^^^^
180 |     assert mapped["searchField"] == "all"
181 |     assert mapped["size"] == 25
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:180:5
    |
178 |     mapped = map_api_params_to_url_params(api_params)
179 |     assert mapped["searchText"] == "mortgage"
180 |     assert mapped["searchField"] == "all"
    |     ^^^^^^
181 |     assert mapped["size"] == 25
182 |     assert mapped["sort"] == "created_date_desc"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:181:5
    |
179 |     assert mapped["searchText"] == "mortgage"
180 |     assert mapped["searchField"] == "all"
181 |     assert mapped["size"] == 25
    |     ^^^^^^
182 |     assert mapped["sort"] == "created_date_desc"
    |

PLR2004 Magic value used in comparison, consider replacing `25` with a constant variable
   --> tests/test_citations.py:181:30
    |
179 |     assert mapped["searchText"] == "mortgage"
180 |     assert mapped["searchField"] == "all"
181 |     assert mapped["size"] == 25
    |                              ^^
182 |     assert mapped["sort"] == "created_date_desc"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:182:5
    |
180 |     assert mapped["searchField"] == "all"
181 |     assert mapped["size"] == 25
182 |     assert mapped["sort"] == "created_date_desc"
    |     ^^^^^^
183 |
184 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:186:5
    |
184 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
185 |     query = _parse_query(url)
186 |     assert query["page"] == ["1"]
    |     ^^^^^^
187 |
188 |     api_params = {
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:198:5
    |
196 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
197 |     query = _parse_query(url)
198 |     assert query["product"] == ["Credit card"]
    |     ^^^^^^
199 |     assert query["state"] == ["CA"]
200 |     assert query["date_received_min"] == ["2023-01-01"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:199:5
    |
197 |     query = _parse_query(url)
198 |     assert query["product"] == ["Credit card"]
199 |     assert query["state"] == ["CA"]
    |     ^^^^^^
200 |     assert query["date_received_min"] == ["2023-01-01"]
201 |     assert query["date_received_max"] == ["2023-12-31"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:200:5
    |
198 |     assert query["product"] == ["Credit card"]
199 |     assert query["state"] == ["CA"]
200 |     assert query["date_received_min"] == ["2023-01-01"]
    |     ^^^^^^
201 |     assert query["date_received_max"] == ["2023-12-31"]
202 |     assert query["page"] == ["2"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:201:5
    |
199 |     assert query["state"] == ["CA"]
200 |     assert query["date_received_min"] == ["2023-01-01"]
201 |     assert query["date_received_max"] == ["2023-12-31"]
    |     ^^^^^^
202 |     assert query["page"] == ["2"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:202:5
    |
200 |     assert query["date_received_min"] == ["2023-01-01"]
201 |     assert query["date_received_max"] == ["2023-12-31"]
202 |     assert query["page"] == ["2"]
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_trend_mapping_defaults`
   --> tests/test_citations.py:206:5
    |
205 | @pytest.mark.fast
206 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
207 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
208 |     query = _parse_query(url)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:206:5
    |
205 | @pytest.mark.fast
206 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
207 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
208 |     query = _parse_query(url)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:209:5
    |
207 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
208 |     query = _parse_query(url)
209 |     assert query["tab"] == ["Trends"]
    |     ^^^^^^
210 |     assert query["lens"] == ["product"]
211 |     assert query["dateInterval"] == ["Month"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:210:5
    |
208 |     query = _parse_query(url)
209 |     assert query["tab"] == ["Trends"]
210 |     assert query["lens"] == ["product"]
    |     ^^^^^^
211 |     assert query["dateInterval"] == ["Month"]
212 |     assert query["trend_depth"] == ["5"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:211:5
    |
209 |     assert query["tab"] == ["Trends"]
210 |     assert query["lens"] == ["product"]
211 |     assert query["dateInterval"] == ["Month"]
    |     ^^^^^^
212 |     assert query["trend_depth"] == ["5"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:212:5
    |
210 |     assert query["lens"] == ["product"]
211 |     assert query["dateInterval"] == ["Month"]
212 |     assert query["trend_depth"] == ["5"]
    |     ^^^^^^
213 |
214 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:215:5
    |
214 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
215 |     assert not validation.unknown_keys
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_default_date_window`
   --> tests/test_citations.py:219:5
    |
218 | @pytest.mark.fast
219 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
220 |     params = apply_default_dates({}, today=FIXED_TODAY)
221 |     assert params["date_received_min"] == "2011-12-01"
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:219:5
    |
218 | @pytest.mark.fast
219 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
220 |     params = apply_default_dates({}, today=FIXED_TODAY)
221 |     assert params["date_received_min"] == "2011-12-01"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:221:5
    |
219 | def test_default_date_window():
220 |     params = apply_default_dates({}, today=FIXED_TODAY)
221 |     assert params["date_received_min"] == "2011-12-01"
    |     ^^^^^^
222 |     assert params["date_received_max"] == "2025-10-31"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:222:5
    |
220 |     params = apply_default_dates({}, today=FIXED_TODAY)
221 |     assert params["date_received_min"] == "2011-12-01"
222 |     assert params["date_received_max"] == "2025-10-31"
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_ui_vs_api_counts`
   --> tests/test_citations.py:229:11
    |
227 | @pytest.mark.anyio
228 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
229 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
230 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
231 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:229:11
    |
227 | @pytest.mark.anyio
228 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
229 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
230 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
231 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_params`
   --> tests/test_citations.py:229:33
    |
227 | @pytest.mark.anyio
228 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
229 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                 ^^^^^^^^^^
230 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
231 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_client`
   --> tests/test_citations.py:229:45
    |
227 | @pytest.mark.anyio
228 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
229 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                             ^^^^^^^^^^
230 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
231 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `ui_context`
   --> tests/test_citations.py:229:57
    |
227 | @pytest.mark.anyio
228 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
229 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                                         ^^^^^^^^^^
230 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
231 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

SIM105 Use `contextlib.suppress(Exception)` instead of `try`-`except`-`pass`
   --> tests/test_citations.py:239:9
    |
237 |       try:
238 |           await page.goto(url, wait_until="domcontentloaded", timeout=60000)
239 | /         try:
240 | |             await page.wait_for_function(
241 | |                 "document.body && /matches out of/i.test(document.body.innerText)",
242 | |                 timeout=20000,
243 | |             )
244 | |         except Exception:
245 | |             pass
    | |________________^
246 |           ui_text = await page.inner_text("body")
247 |       finally:
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(Exception): ...`

S110 `try`-`except`-`pass` detected, consider logging the exception
   --> tests/test_citations.py:244:9
    |
242 |                   timeout=20000,
243 |               )
244 | /         except Exception:
245 | |             pass
    | |________________^
246 |           ui_text = await page.inner_text("body")
247 |       finally:
    |

BLE001 Do not catch blind exception: `Exception`
   --> tests/test_citations.py:244:16
    |
242 |                 timeout=20000,
243 |             )
244 |         except Exception:
    |                ^^^^^^^^^
245 |             pass
246 |         ui_text = await page.inner_text("body")
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:253:5
    |
251 |     ui_matches = _parse_ui_matches(ui_text)
252 |
253 |     assert api_total == ui_matches, (
    |     ^^^^^^
254 |         "API/UI match count mismatch: "
255 |         f"api_total={api_total} ui_matches={ui_matches} url={url}"
    |

INP001 File `tests/test_mcp_auth.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_auth.py:1:1

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/test_mcp_auth.py:30:29
   |
28 |     try:
29 |         r = httpx.get(f"{url}/", timeout=5)
30 |         if r.status_code != 200:
   |                             ^^^
31 |             return False
32 |         payload = r.json()
   |

S603 `subprocess` call: check for execution of untrusted input
  --> tests/test_mcp_auth.py:49:35
   |
47 |     env.update(env_overrides)
48 |
49 |     proc: subprocess.Popen[str] = subprocess.Popen(
   |                                   ^^^^^^^^^^^^^^^^
50 |         [
51 |             sys.executable,
   |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:62:13
   |
60 |             "warning",
61 |         ],
62 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |             ^^^^^^^^^^^^^^^
63 |         env=env,
64 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:62:29
   |
60 |             "warning",
61 |         ],
62 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |                             ^^^^^^^^^^^^^^^
63 |         env=env,
64 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

TRY301 Abstract `raise` to an inner function
  --> tests/test_mcp_auth.py:81:9
   |
79 |           if proc.stdout is not None:
80 |               output = proc.stdout.read() or ""
81 | /         raise RuntimeError(
82 | |             f"Auth test server failed to start on {url}. Output:\n{output}"
83 | |         )
   | |_________^
84 |       except Exception:
85 |           if proc.poll() is None:
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/test_mcp_auth.py:81:15
   |
79 |           if proc.stdout is not None:
80 |               output = proc.stdout.read() or ""
81 |           raise RuntimeError(
   |  _______________^
82 | |             f"Auth test server failed to start on {url}. Output:\n{output}"
83 | |         )
   | |_________^
84 |       except Exception:
85 |           if proc.poll() is None:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/test_mcp_auth.py:82:13
   |
80 |             output = proc.stdout.read() or ""
81 |         raise RuntimeError(
82 |             f"Auth test server failed to start on {url}. Output:\n{output}"
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
83 |         )
84 |     except Exception:
   |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
  --> tests/test_mcp_auth.py:96:5
   |
95 | @pytest.fixture(scope="module")
96 | def auth_server_url() -> Iterator[str]:
   |     ^^^^^^^^^^^^^^^
97 |     key = _dev_testing_api_key()
98 |     proc, url = _start_server(env_overrides={"CFPB_MCP_API_KEYS": key})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:112:5
    |
111 | @pytest.fixture(scope="module")
112 | def rate_limited_auth_server_url() -> Iterator[str]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
113 |     key = _dev_testing_api_key()
114 |     proc, url = _start_server(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:133:5
    |
133 | def test_mcp_http_requires_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:136:9
    |
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
    |         ^^^^^^
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:136:33
    |
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
    |                                 ^^^
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:137:9
    |
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |         ^^^^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:140:5
    |
140 | def test_mcp_http_allows_valid_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
141 |     key = _dev_testing_api_key()
142 |     with httpx.Client(timeout=5) as client:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:151:9
    |
149 |             json={"jsonrpc": "2.0", "id": 1, "method": "tools/list"},
150 |         )
151 |         assert r.status_code != 401
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:151:33
    |
149 |             json={"jsonrpc": "2.0", "id": 1, "method": "tools/list"},
150 |         )
151 |         assert r.status_code != 401
    |                                 ^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:154:5
    |
154 | def test_mcp_rate_limit_429(rate_limited_auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
155 |     key = _dev_testing_api_key()
156 |     with httpx.Client(timeout=5) as client:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:162:9
    |
160 |             json={},
161 |         )
162 |         assert r1.status_code != 401
    |         ^^^^^^
163 |         assert r1.status_code != 429
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:162:34
    |
160 |             json={},
161 |         )
162 |         assert r1.status_code != 401
    |                                  ^^^
163 |         assert r1.status_code != 429
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:163:9
    |
161 |         )
162 |         assert r1.status_code != 401
163 |         assert r1.status_code != 429
    |         ^^^^^^
164 |
165 |         r2 = client.post(
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:163:34
    |
161 |         )
162 |         assert r1.status_code != 401
163 |         assert r1.status_code != 429
    |                                  ^^^
164 |
165 |         r2 = client.post(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:170:9
    |
168 |             json={},
169 |         )
170 |         assert r2.status_code == 429
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:170:34
    |
168 |             json={},
169 |         )
170 |         assert r2.status_code == 429
    |                                  ^^^
    |

INP001 File `tests/test_mcp_endpoints.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_endpoints.py:1:1

PLR0911 Too many return statements (9 > 6)
  --> tests/test_mcp_endpoints.py:45:5
   |
45 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
46 |     if not isinstance(payload, dict):
47 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/test_mcp_endpoints.py:69:8
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
70 |         return cid_int
71 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/test_mcp_endpoints.py:69:34
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
70 |         return cid_int
71 |     return None
   |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/test_mcp_endpoints.py:78:5
   |
76 |   ) -> None:
77 |       mcp_url = f"{server_url}/mcp"
78 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
79 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
80 |               await mcp.initialize()
81 |               await action(mcp)
   |
help: Combine `with` statements

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:84:11
   |
84 | async def test_tools_list_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^^^^^
85 |     async def _run(mcp: ClientSession) -> None:
86 |         tools = await mcp.list_tools()
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:88:9
   |
86 |         tools = await mcp.list_tools()
87 |         tool_names = {tool.name for tool in tools.tools}
88 |         assert "search_complaints" in tool_names
   |         ^^^^^^
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:89:9
   |
87 |         tool_names = {tool.name for tool in tools.tools}
88 |         assert "search_complaints" in tool_names
89 |         assert "list_complaint_trends" in tool_names
   |         ^^^^^^
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:90:9
   |
88 |         assert "search_complaints" in tool_names
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
   |         ^^^^^^
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:91:9
   |
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
   |         ^^^^^^
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:92:9
   |
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
   |         ^^^^^^
93 |         assert "generate_cfpb_dashboard_url" in tool_names
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:93:9
   |
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
   |         ^^^^^^
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:94:9
   |
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |         ^^^^^^
95 |
96 |     await _with_mcp(server_url, _run)
   |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:99:11
    |
 99 | async def test_search_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
100 |     async def _run(mcp: ClientSession) -> None:
101 |         result = await mcp.call_tool("search_complaints", {"size": 1})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:103:9
    |
101 |         result = await mcp.call_tool("search_complaints", {"size": 1})
102 |         payload = _tool_payload(result)
103 |         assert isinstance(payload, dict)
    |         ^^^^^^
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:105:9
    |
103 |         assert isinstance(payload, dict)
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
    |         ^^^^^^
106 |         assert "hits" in data
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:106:9
    |
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
106 |         assert "hits" in data
    |         ^^^^^^
107 |
108 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:111:11
    |
111 | async def test_trends_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
112 |     async def _run(mcp: ClientSession) -> None:
113 |         result = await mcp.call_tool("list_complaint_trends", {"trend_depth": 5})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:115:9
    |
113 |         result = await mcp.call_tool("list_complaint_trends", {"trend_depth": 5})
114 |         payload = _tool_payload(result)
115 |         assert isinstance(payload, dict)
    |         ^^^^^^
116 |         data = payload.get("data")
117 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:117:9
    |
115 |         assert isinstance(payload, dict)
116 |         data = payload.get("data")
117 |         assert isinstance(data, dict)
    |         ^^^^^^
118 |
119 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:122:11
    |
122 | async def test_geo_states_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^
123 |     async def _run(mcp: ClientSession) -> None:
124 |         result = await mcp.call_tool("get_state_aggregations", {})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:126:9
    |
124 |         result = await mcp.call_tool("get_state_aggregations", {})
125 |         payload = _tool_payload(result)
126 |         assert isinstance(payload, dict)
    |         ^^^^^^
127 |         data = payload.get("data")
128 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:128:9
    |
126 |         assert isinstance(payload, dict)
127 |         data = payload.get("data")
128 |         assert isinstance(data, dict)
    |         ^^^^^^
129 |
130 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:134:11
    |
133 | @pytest.mark.parametrize("field", ["company", "zip_code"])
134 | async def test_suggest_smoke(server_url: str, field: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^
135 |     async def _run(mcp: ClientSession) -> None:
136 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:143:9
    |
141 |         if isinstance(payload, str):
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
    |         ^^^^^^
144 |         assert len(payload) <= 3
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:144:9
    |
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
144 |         assert len(payload) <= 3
    |         ^^^^^^
145 |
146 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> tests/test_mcp_endpoints.py:144:32
    |
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
144 |         assert len(payload) <= 3
    |                                ^
145 |
146 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:149:11
    |
149 | async def test_document_round_trip_from_search(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |     async def _run(mcp: ClientSession) -> None:
151 |         search_result = await mcp.call_tool("search_complaints", {"size": 1})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:154:9
    |
152 |         payload = _tool_payload(search_result)
153 |         complaint_id = _extract_complaint_id_from_search_payload(payload)
154 |         assert complaint_id is not None, "Expected a complaint id from search results"
    |         ^^^^^^
155 |
156 |         doc_result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:160:9
    |
158 |         )
159 |         doc_payload = _tool_payload(doc_result)
160 |         assert isinstance(doc_payload, dict)
    |         ^^^^^^
161 |
162 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:165:11
    |
165 | async def test_signals_overall_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
166 |     async def _run(mcp: ClientSession) -> None:
167 |         date_min, date_max, current_month_prefix = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:173:9
    |
171 |         )
172 |         payload = _tool_payload(result)
173 |         assert isinstance(payload, dict)
    |         ^^^^^^
174 |         overall = (payload.get("signals") or {}).get("overall")
175 |         assert isinstance(overall, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:175:9
    |
173 |         assert isinstance(payload, dict)
174 |         overall = (payload.get("signals") or {}).get("overall")
175 |         assert isinstance(overall, dict)
    |         ^^^^^^
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:177:9
    |
175 |         assert isinstance(overall, dict)
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
    |         ^^^^^^
178 |         assert not str(last_bucket.get("label", "")).startswith(current_month_prefix)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:178:9
    |
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
178 |         assert not str(last_bucket.get("label", "")).startswith(current_month_prefix)
    |         ^^^^^^
179 |
180 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:184:11
    |
183 | @pytest.mark.parametrize("group", ["product", "issue"])
184 | async def test_signals_group_smoke(server_url: str, group: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^
185 |     async def _run(mcp: ClientSession) -> None:
186 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:197:9
    |
195 |         )
196 |         payload = _tool_payload(result)
197 |         assert isinstance(payload, dict)
    |         ^^^^^^
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:199:9
    |
197 |         assert isinstance(payload, dict)
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
    |         ^^^^^^
200 |         assert len(results) <= 5
201 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:200:9
    |
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
200 |         assert len(results) <= 5
    |         ^^^^^^
201 |         if results:
202 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:200:32
    |
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
200 |         assert len(results) <= 5
    |                                ^
201 |         if results:
202 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:203:13
    |
201 |         if results:
202 |             row0 = results[0]
203 |             assert isinstance(row0, dict)
    |             ^^^^^^
204 |             assert "group" in row0
205 |             assert "signals" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:204:13
    |
202 |             row0 = results[0]
203 |             assert isinstance(row0, dict)
204 |             assert "group" in row0
    |             ^^^^^^
205 |             assert "signals" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:205:13
    |
203 |             assert isinstance(row0, dict)
204 |             assert "group" in row0
205 |             assert "signals" in row0
    |             ^^^^^^
206 |
207 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:210:11
    |
210 | async def test_signals_company_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
211 |     async def _run(mcp: ClientSession) -> None:
212 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:222:9
    |
220 |         )
221 |         payload = _tool_payload(result)
222 |         assert isinstance(payload, dict)
    |         ^^^^^^
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:224:9
    |
222 |         assert isinstance(payload, dict)
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
    |         ^^^^^^
225 |         assert len(results) <= 5
226 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:225:9
    |
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
225 |         assert len(results) <= 5
    |         ^^^^^^
226 |         if results:
227 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:225:32
    |
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
225 |         assert len(results) <= 5
    |                                ^
226 |         if results:
227 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:228:13
    |
226 |         if results:
227 |             row0 = results[0]
228 |             assert isinstance(row0, dict)
    |             ^^^^^^
229 |             assert "company" in row0
230 |             assert "computed" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:229:13
    |
227 |             row0 = results[0]
228 |             assert isinstance(row0, dict)
229 |             assert "company" in row0
    |             ^^^^^^
230 |             assert "computed" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:230:13
    |
228 |             assert isinstance(row0, dict)
229 |             assert "company" in row0
230 |             assert "computed" in row0
    |             ^^^^^^
231 |
232 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:235:11
    |
235 | async def test_generate_cfpb_dashboard_url(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     async def _run(mcp: ClientSession) -> None:
237 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:244:9
    |
242 |         if isinstance(payload, dict) and "result" in payload:
243 |             payload = payload["result"]
244 |         assert isinstance(payload, str)
    |         ^^^^^^
245 |         assert payload.startswith(
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:245:9
    |
243 |             payload = payload["result"]
244 |         assert isinstance(payload, str)
245 |         assert payload.startswith(
    |         ^^^^^^
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
247 |         )
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:248:9
    |
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
247 |         )
248 |         assert "searchText=foreclosure" in payload
    |         ^^^^^^
249 |
250 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:253:11
    |
253 | async def test_capture_cfpb_chart_screenshot(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
254 |     async def _run(mcp: ClientSession) -> None:
255 |         try:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:269:9
    |
267 |         if isinstance(payload, dict) and "result" in payload:
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
    |         ^^^^^^
270 |         assert len(payload) > 1000
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:270:9
    |
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
270 |         assert len(payload) > 1000
    |         ^^^^^^
271 |
272 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `1000` with a constant variable
   --> tests/test_mcp_endpoints.py:270:31
    |
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
270 |         assert len(payload) > 1000
    |                               ^^^^
271 |
272 |     await _with_mcp(server_url, _run)
    |

INP001 File `tests/transport/http/test_http_transport.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/transport/http/test_http_transport.py:1:1

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/transport/http/test_http_transport.py:12:5
   |
10 |       """Verify that the Streamable HTTP endpoint (POST /mcp) works."""
11 |       url = f"{server_url}/mcp"
12 | /     async with streamable_http_client(url) as (read_stream, write_stream, _):
13 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
14 |               await mcp.initialize()
15 |               tools = await mcp.list_tools()
   |
help: Combine `with` statements

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:17:13
   |
15 |             tools = await mcp.list_tools()
16 |             tool_names = {tool.name for tool in tools.tools}
17 |             assert "search_complaints" in tool_names
   |             ^^^^^^
   |

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:25:9
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |         ^^^^^^
   |

PLR2004 Magic value used in comparison, consider replacing `405` with a constant variable
  --> tests/transport/http/test_http_transport.py:25:40
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |                                        ^^^
   |

INP001 File `tests/unit/test_params.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/unit/test_params.py:1:1

D103 Missing docstring in public function
 --> tests/unit/test_params.py:6:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |     assert prune_params({"a": None, "b": "", "c": "  ", "d": "ok"}) == {"d": "ok"}
  |

S101 Use of `assert` detected
 --> tests/unit/test_params.py:7:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
7 |     assert prune_params({"a": None, "b": "", "c": "  ", "d": "ok"}) == {"d": "ok"}
  |     ^^^^^^
  |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:10:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     assert prune_params(
12 |         {"a": [], "b": [""], "c": [" ", None], "d": ["x", "", "y"]}
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:11:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
11 |     assert prune_params(
   |     ^^^^^^
12 |         {"a": [], "b": [""], "c": [" ", None], "d": ["x", "", "y"]}
13 |     ) == {"d": ["x", "y"]}
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:16:5
   |
16 | def test_prune_params_keeps_non_string_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
17 |     assert prune_params({"a": 0, "b": False, "c": True, "d": 3.14}) == {
18 |         "a": 0,
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:17:5
   |
16 | def test_prune_params_keeps_non_string_values() -> None:
17 |     assert prune_params({"a": 0, "b": False, "c": True, "d": 3.14}) == {
   |     ^^^^^^
18 |         "a": 0,
19 |         "b": "false",
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:25:5
   |
25 | def test_prune_params_normalizes_boolean_like_strings() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
26 |     assert prune_params({"a": "True", "b": "false", "c": ["FALSE", "ok"]}) == {
27 |         "a": "true",
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:26:5
   |
25 | def test_prune_params_normalizes_boolean_like_strings() -> None:
26 |     assert prune_params({"a": "True", "b": "false", "c": ["FALSE", "ok"]}) == {
   |     ^^^^^^
27 |         "a": "true",
28 |         "b": "false",
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:33:5
   |
33 | def test_build_params_filters_empty_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
34 |     params = build_params(
35 |         search_term="",
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:44:5
   |
43 |     # build_params returns already-pruned params
44 |     assert "search_term" not in params
   |     ^^^^^^
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:45:5
   |
43 |     # build_params returns already-pruned params
44 |     assert "search_term" not in params
45 |     assert "field" not in params
   |     ^^^^^^
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:46:5
   |
44 |     assert "search_term" not in params
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
   |     ^^^^^^
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:47:5
   |
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
   |     ^^^^^^
48 |     assert "state" not in params
49 |     assert "tags" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:48:5
   |
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
   |     ^^^^^^
49 |     assert "tags" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:49:5
   |
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
49 |     assert "tags" not in params
   |     ^^^^^^
   |

PT006 Wrong type passed to first argument of `pytest.mark.parametrize`; expected `tuple`
  --> tests/unit/test_params.py:53:5
   |
52 | @pytest.mark.parametrize(
53 |     "raw,expected",
   |     ^^^^^^^^^^^^^^
54 |     [
55 |         ({"x": "y"}, {"x": "y"}),
   |
help: Use a `tuple` for the first argument

D103 Missing docstring in public function
  --> tests/unit/test_params.py:60:5
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^
61 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `raw`
  --> tests/unit/test_params.py:60:29
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |                             ^^^
61 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `expected`
  --> tests/unit/test_params.py:60:34
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |                                  ^^^^^^^^
61 |     assert prune_params(raw) == expected
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:61:5
   |
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
61 |     assert prune_params(raw) == expected
   |     ^^^^^^
   |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> utils/deeplink_mapping.py:4:29
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                             ^^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> utils/deeplink_mapping.py:4:39
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                                       ^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

D101 Missing docstring in public class
   --> utils/deeplink_mapping.py:119:7
    |
118 | @dataclass(frozen=True)
119 | class ValidationResult:
    |       ^^^^^^^^^^^^^^^^
120 |     unknown_keys: tuple[str, ...]
121 |     allowed_keys: tuple[str, ...]
    |

PLR0911 Too many return statements (8 > 6)
   --> utils/deeplink_mapping.py:124:5
    |
124 | def _clean_value(value: Any) -> Any | None:
    |     ^^^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:124:25
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                         ^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `_clean_value`
   --> utils/deeplink_mapping.py:124:33
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                                 ^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:150:23
    |
150 | def _parse_int(value: Any) -> int | None:
    |                       ^^^
151 |     if value is None:
152 |         return None
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:175:5
    |
175 | def normalize_api_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^
176 |     normalized: dict[str, Any] = {}
177 |     for key, raw_value in api_params.items():
    |

DTZ011 `datetime.date.today()` used
   --> utils/deeplink_mapping.py:191:23
    |
189 | def _default_end_date(today: date | None = None) -> str:
190 |     """Return the last day of the month before (today - 30 days)."""
191 |     anchor = today or date.today()
    |                       ^^^^^^^^^^^^
192 |     cutoff = anchor - timedelta(days=30)
193 |     first_of_cutoff_month = cutoff.replace(day=1)
    |
help: Use `datetime.datetime.now(tz=...).date()` instead

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:210:5
    |
210 | def validate_api_params(api_params: Mapping[str, Any], allowed_keys: Iterable[str]) -> ValidationResult:
    |     ^^^^^^^^^^^^^^^^^^^
211 |     allowed = set(allowed_keys)
212 |     unknown = tuple(sorted(key for key in api_params if key not in allowed))
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:216:5
    |
216 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
217 |     url_params: dict[str, Any] = {}
218 |     normalized = normalize_api_params(api_params)
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:243:5
    |
243 | def build_deeplink_url(
    |     ^^^^^^^^^^^^^^^^^^
244 |     api_params: Mapping[str, Any],
245 |     *,
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:263:5
    |
263 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
264 |     api_params: dict[str, Any] = {}
265 |     for key, raw_value in url_params.items():
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:287:5
    |
287 | def url_to_api_params(url: str) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^
288 |     parsed = urlparse(url)
289 |     query = parse_qs(parsed.query)
    |

Found 305 errors (32 fixed, 273 remaining).
No fixes available (26 hidden fixes can be enabled with the `--unsafe-fixes` option).

=== ruff format ===
cmd: ruff format /Users/jim/cfpb-mcp
exit_code: 0
--- stdout ---
11 files reformatted, 5 files left unchanged

=== ruff check ===
cmd: ruff check /Users/jim/cfpb-mcp
exit_code: 1
--- stdout ---
ANN201 Missing return type annotation for public function `map_api_params_to_url_params`
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |
help: Add return type annotation

D103 Missing docstring in public function
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN001 Missing type annotation for function argument `api_params`
  --> citations_mapping.py:14:34
   |
14 | def map_api_params_to_url_params(api_params):
   |                                  ^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN201 Missing return type annotation for public function `demo_url_generation`
  --> scripts/demo_cfpb_ui.py:10:5
   |
10 | def demo_url_generation():
   |     ^^^^^^^^^^^^^^^^^^^
11 |     """Demonstrate URL generation for the official CFPB dashboard."""
12 |     print('=' * 70)
   |
help: Add return type annotation: `None`

INP001 File `scripts/run_tests.py` is part of an implicit namespace package. Add an `__init__.py`.
--> scripts/run_tests.py:1:1

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:17
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:33
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH100 `os.path.abspath()` should be replaced by `Path.resolve()`
  --> scripts/run_tests.py:21:49
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).resolve()`

PLR0911 Too many return statements (7 > 6)
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

D103 Missing docstring in public function
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:56:24
   |
55 |     if ns.suite == 'unit':
56 |         return _pytest(default_args + ['-m', 'unit'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
57 |
58 |     if ns.suite == 'integration':
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:60:24
   |
58 |     if ns.suite == 'integration':
59 |         # Includes anything under tests/ except slow/unit/contract.
60 |         return _pytest(default_args + ['-m', 'integration'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |     if ns.suite == 'slow':
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:63:24
   |
62 |     if ns.suite == 'slow':
63 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |
65 |     if ns.suite == 'contract':
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'contract', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:66:24
   |
65 |     if ns.suite == 'contract':
66 |         return _pytest(default_args + ['-m', 'contract', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     if ns.suite == 'full':
   |
help: Replace with `[*default_args, '-m', 'contract', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:70:22
   |
68 |     if ns.suite == 'full':
69 |         # Run unit, then integration, then slow.
70 |         rc = _pytest(default_args + ['-m', 'unit'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
71 |         if rc != 0:
72 |             return rc
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:74:22
   |
72 |             return rc
73 |
74 |         rc = _pytest(default_args + ['-m', 'integration'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
75 |         if rc != 0:
76 |             return rc
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:77:24
   |
75 |         if rc != 0:
76 |             return rc
77 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |
79 |     _die(f'Unknown suite: {ns.suite}')
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

INP001 File `tests/conftest.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/conftest.py:1:1

ARG001 Unused function argument: `config`
  --> tests/conftest.py:15:35
   |
15 | def pytest_collection_modifyitems(config: pytest.Config, items: list[pytest.Item]) -> None:
   |                                   ^^^^^^
16 |     """Apply suite markers based on file path.
   |

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/conftest.py:46:29
   |
44 |     try:
45 |         r = httpx.get(f'{url}/', timeout=5)
46 |         if r.status_code != 200:
   |                             ^^^
47 |             return False
48 |         payload = r.json()
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:57:15
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:57:26
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:59:15
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:59:26
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |
help: Assign to variable; remove f-string literal

C901 `server_url` is too complex (16 > 10)
  --> tests/conftest.py:64:5
   |
63 | @pytest.fixture(scope='session')
64 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
65 |     """Start uvicorn in a subprocess and return the base URL."""
66 |     configured_url = os.environ.get('TEST_SERVER_URL')
   |

PLR0912 Too many branches (17 > 12)
  --> tests/conftest.py:64:5
   |
63 | @pytest.fixture(scope='session')
64 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
65 |     """Start uvicorn in a subprocess and return the base URL."""
66 |     configured_url = os.environ.get('TEST_SERVER_URL')
   |

PLR0915 Too many statements (55 > 50)
  --> tests/conftest.py:64:5
   |
63 | @pytest.fixture(scope='session')
64 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
65 |     """Start uvicorn in a subprocess and return the base URL."""
66 |     configured_url = os.environ.get('TEST_SERVER_URL')
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:84:23
   |
82 |               host, port = _parse_host_port(url)
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
   |  _______________________^
85 | |                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
87 | |                 )
   | |_________________^
88 |       else:
89 |           port = _pick_free_port()
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:85:21
   |
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
85 | /                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
   | |_____________________________________________________^
87 |                   )
88 |       else:
   |
help: Assign to variable; remove f-string literal

SIM115 Use a context manager for opening files
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |
help: Replace with `Path.open()`

S603 `subprocess` call: check for execution of untrusted input
   --> tests/conftest.py:105:12
    |
103 |     log_file = open('server_test.log', 'w')
104 |
105 |     proc = subprocess.Popen(
    |            ^^^^^^^^^^^^^^^^
106 |         [
107 |             sys.executable,
    |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:13
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:29
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |                             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:141:18
    |
139 |             # If it failed, read the log file
140 |             log_file.close()
141 |             with open('server_test.log') as f:
    |                  ^^^^
142 |                 output = f.read()
143 |             raise RuntimeError(
    |
help: Replace with `Path.open()`

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:143:19
    |
141 |               with open('server_test.log') as f:
142 |                   output = f.read()
143 |               raise RuntimeError(
    |  ___________________^
144 | |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
145 | |             )
    | |_____________^
146 |
147 |           # Final readiness check
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:144:17
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
145 |             )
    |
help: Assign to variable; remove f-string literal

E501 Line too long (122 > 120)
   --> tests/conftest.py:144:121
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                                                                                                                         ^^
145 |             )
    |

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:149:19
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:149:32
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
   --> tests/conftest.py:168:5
    |
167 | @pytest.fixture
168 | def client(server_url: str) -> Iterator[httpx.Client]:
    |     ^^^^^^
169 |     with httpx.Client(base_url=server_url, timeout=30) as c:
170 |         yield c
    |

INP001 File `tests/contract/test_anthropic_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_anthropic_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_anthropic_mcp_contract.py:23:16
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_anthropic_mcp_contract.py:23:29
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_anthropic_mcp_contract.py:24:12
   |
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
24 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
25 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_anthropic_mcp_contract.py:28:14
   |
27 |     try:
28 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
29 |             for raw_line in f:
30 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

ANN001 Missing type annotation for function argument `blocks`
  --> tests/contract/test_anthropic_mcp_contract.py:43:19
   |
43 | def _extract_text(blocks) -> str:
   |                   ^^^^^^
44 |     if not isinstance(blocks, list):
45 |         return str(blocks or '')
   |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `payload`
  --> tests/contract/test_anthropic_mcp_contract.py:53:32
   |
53 | def _tool_result_text(payload: Any) -> str:
   |                                ^^^
54 |     if payload is None:
55 |         return ''
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:90:5
   |
88 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
89 |     matches = re.findall(r'\b\d{4,9}\b', text or '')
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
   |     ^^^^^^
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:92:5
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:12
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |            ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:31
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |                               ^
93 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_anthropic_mcp_contract.py:96:5
   |
96 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
97 |     if not isinstance(payload, dict):
98 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:8
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |        ^
121 |         return cid_int
122 |     return None
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:34
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |                                  ^
121 |         return cid_int
122 |     return None
    |

C901 `test_anthropic_mcp_tool_loop_smoke` is too complex (12 > 10)
   --> tests/contract/test_anthropic_mcp_contract.py:128:11
    |
126 | @pytest.mark.fast
127 | @pytest.mark.anyio
128 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (62 > 50)
   --> tests/contract/test_anthropic_mcp_contract.py:128:11
    |
126 | @pytest.mark.fast
127 | @pytest.mark.anyio
128 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_anthropic_mcp_contract.py:128:11
    |
126 | @pytest.mark.fast
127 | @pytest.mark.anyio
128 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:143:121
    |
141 |     user_prompt = (
142 |         "I'm researching CFPB consumer complaints about loan forbearance. "
143 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
144 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
145 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_anthropic_mcp_contract.py:153:5
    |
152 |       # Connect using Streamable HTTP client
153 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
154 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
155 |               await mcp.initialize()
156 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

ERA001 Found commented-out code
   --> tests/contract/test_anthropic_mcp_contract.py:184:17
    |
182 |                 messages.append(cast('MessageParam', {'role': 'assistant', 'content': resp.content}))
183 |
184 |                 # tool_uses = [c for c in resp.content if getattr(c, "type", None) == "tool_use"]
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
185 |                 tool_uses: list[ToolUseBlock] = [c for c in resp.content if isinstance(c, ToolUseBlock)]
    |
help: Remove commented-out code

E501 Line too long (161 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:197:121
    |
195 | …
196 | …
197 | … now (complaint id, company, state if present, and a 2-3 sentence grounded summary).',
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
198 | …
199 | …
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:235:13
    |
234 |             last_assistant = next((m for m in reversed(messages) if m.get('role') == 'assistant'), None)
235 |             assert last_assistant is not None
    |             ^^^^^^
236 |             text = _extract_text(last_assistant.get('content'))
237 |             assert text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:237:13
    |
235 |             assert last_assistant is not None
236 |             text = _extract_text(last_assistant.get('content'))
237 |             assert text
    |             ^^^^^^
238 |             assert 'MCP tools unavailable' not in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:238:13
    |
236 |             text = _extract_text(last_assistant.get('content'))
237 |             assert text
238 |             assert 'MCP tools unavailable' not in text
    |             ^^^^^^
239 |
240 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:242:13
    |
240 |             final_text = text
241 |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
    |             ^^^^^^
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
244 |             assert str(complaint_id_from_tools) in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:243:13
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
244 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:20
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
244 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:62
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
244 |             assert str(complaint_id_from_tools) in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:244:13
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
244 |             assert str(complaint_id_from_tools) in text
    |             ^^^^^^
245 |
246 |             # Keep the original "must contain a 4-9 digit integer" guard, but validate
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:249:13
    |
247 |             # it matches the tool-derived complaint id for stability.
248 |             complaint_id, _ = _extract_complaint_id_from_text(text)
249 |             assert complaint_id == complaint_id_from_tools
    |             ^^^^^^
250 |
251 |             doc_result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:258:5
    |
256 |             complaint_doc = _coerce_json(doc_payload) or doc_payload
257 |
258 |     assert final_text is not None
    |     ^^^^^^
259 |     assert complaint_id_from_tools is not None
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:259:5
    |
258 |     assert final_text is not None
259 |     assert complaint_id_from_tools is not None
    |     ^^^^^^
260 |
261 |     company = _extract_company_from_document(complaint_doc)
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:265:5
    |
263 |         pytest.skip(f'Complaint {complaint_id_from_tools} document missing company field')
264 |     first_word = company.split()[0].lower()
265 |     assert first_word in final_text.lower()
    |     ^^^^^^
    |

INP001 File `tests/contract/test_openai_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_openai_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_openai_mcp_contract.py:17:16
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_openai_mcp_contract.py:17:29
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_openai_mcp_contract.py:18:12
   |
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
18 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
19 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_openai_mcp_contract.py:22:14
   |
21 |     try:
22 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
23 |             for raw_line in f:
24 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:39:5
   |
37 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
38 |     matches = re.findall(r'\b\d{4,9}\b', text or '')
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
   |     ^^^^^^
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:41:5
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:12
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |            ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:31
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |                               ^
42 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_openai_mcp_contract.py:63:5
   |
63 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |     if not isinstance(payload, dict):
65 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:8
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
88 |         return cid_int
89 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:34
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
88 |         return cid_int
89 |     return None
   |

C901 `test_openai_mcp_tool_loop_smoke` is too complex (20 > 10)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

PLR0912 Too many branches (21 > 12)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (82 > 50)
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_openai_mcp_contract.py:139:121
    |
137 |     prompt = (
138 |         "I'm researching CFPB consumer complaints about loan forbearance. "
139 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
140 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
141 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_openai_mcp_contract.py:149:5
    |
147 |       tool_calls_seen = False
148 |
149 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
150 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
151 |               await mcp.initialize()
152 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:246:13
    |
245 |             text = (resp.output_text or '').strip()
246 |             assert text, 'Expected a final answer'
    |             ^^^^^^
247 |             assert 'MCP tools unavailable' not in text
248 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:247:13
    |
245 |             text = (resp.output_text or '').strip()
246 |             assert text, 'Expected a final answer'
247 |             assert 'MCP tools unavailable' not in text
    |             ^^^^^^
248 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:261:13
    |
259 |                 complaint_id_from_tools = _extract_complaint_id_from_search_payload(search_payload)
260 |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
    |             ^^^^^^
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:262:13
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:20
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:62
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:267:17
    |
265 |             if str(complaint_id_from_tools) in text:
266 |                 complaint_id_for_validation = complaint_id_from_tools
267 |                 assert complaint_id_from_text == complaint_id_from_tools
    |                 ^^^^^^
268 |             else:
269 |                 complaint_id_for_validation = complaint_id_from_text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:281:5
    |
279 |         pytest.skip(f'Complaint {complaint_id_from_tools} document missing company field')
280 |     first_word = company.split()[0].lower()
281 |     assert first_word in (final_text or '').lower()
    |     ^^^^^^
    |

INP001 File `tests/playwright_helpers.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/playwright_helpers.py:1:1

ANN201 Missing return type annotation for public function `fast_playwright_context`
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |
help: Add return type annotation

D103 Missing docstring in public function
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |

PLC0415 `import` should be at the top-level of a file
  --> tests/playwright_helpers.py:9:9
   |
 7 | async def fast_playwright_context():
 8 |     try:
 9 |         from playwright.async_api import async_playwright
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/playwright_helpers.py:11:15
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/playwright_helpers.py:11:28
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |
help: Assign to variable; remove f-string literal

ANN202 Missing return type annotation for private function `_block_heavy_assets`
  --> tests/playwright_helpers.py:17:19
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                   ^^^^^^^^^^^^^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |
help: Add return type annotation: `None`

ANN001 Missing type annotation for function argument `route`
  --> tests/playwright_helpers.py:17:39
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                       ^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

ANN001 Missing type annotation for function argument `request`
  --> tests/playwright_helpers.py:17:46
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                              ^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

INP001 File `tests/test_citations.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_citations.py:1:1

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> tests/test_citations.py:5:29
  |
3 | import asyncio
4 | import re
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from datetime import date
7 | from typing import Any
  |
help: Move into type-checking block

TRY003 Avoid specifying long messages outside the exception class
   --> tests/test_citations.py:133:11
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |

EM101 Exception must not use a string literal, assign to variable first
   --> tests/test_citations.py:133:22
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
help: Assign to variable; remove string literal

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
   --> tests/test_citations.py:138:32
    |
136 | async def _fetch_api_total(client: httpx.AsyncClient, api_params: Mapping[str, Any]) -> int:
137 |     response = await client.get(BASE_URL, params=api_params)
138 |     if response.status_code != 200:
    |                                ^^^
139 |         pytest.fail(f'API call failed: {response.url} ({response.status_code})')
    |

D103 Missing docstring in public function
   --> tests/test_citations.py:153:11
    |
152 | @pytest.fixture(scope='module')
153 | async def api_client() -> httpx.AsyncClient:
    |           ^^^^^^^^^^
154 |     async with httpx.AsyncClient(timeout=20.0) as client:
155 |         yield client
    |

ANN201 Missing return type annotation for public function `ui_context`
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |
help: Add return type annotation

D103 Missing docstring in public function
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |

ANN201 Missing return type annotation for public function `test_map_api_params_to_url_params_examples`
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:177:5
    |
175 |     }
176 |     mapped = map_api_params_to_url_params(api_params)
177 |     assert mapped['searchText'] == 'mortgage'
    |     ^^^^^^
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:178:5
    |
176 |     mapped = map_api_params_to_url_params(api_params)
177 |     assert mapped['searchText'] == 'mortgage'
178 |     assert mapped['searchField'] == 'all'
    |     ^^^^^^
179 |     assert mapped['size'] == 25
180 |     assert mapped['sort'] == 'created_date_desc'
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:179:5
    |
177 |     assert mapped['searchText'] == 'mortgage'
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
    |     ^^^^^^
180 |     assert mapped['sort'] == 'created_date_desc'
    |

PLR2004 Magic value used in comparison, consider replacing `25` with a constant variable
   --> tests/test_citations.py:179:30
    |
177 |     assert mapped['searchText'] == 'mortgage'
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
    |                              ^^
180 |     assert mapped['sort'] == 'created_date_desc'
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:180:5
    |
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
180 |     assert mapped['sort'] == 'created_date_desc'
    |     ^^^^^^
181 |
182 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:184:5
    |
182 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
183 |     query = _parse_query(url)
184 |     assert query['page'] == ['1']
    |     ^^^^^^
185 |
186 |     api_params = {
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:196:5
    |
194 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
195 |     query = _parse_query(url)
196 |     assert query['product'] == ['Credit card']
    |     ^^^^^^
197 |     assert query['state'] == ['CA']
198 |     assert query['date_received_min'] == ['2023-01-01']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:197:5
    |
195 |     query = _parse_query(url)
196 |     assert query['product'] == ['Credit card']
197 |     assert query['state'] == ['CA']
    |     ^^^^^^
198 |     assert query['date_received_min'] == ['2023-01-01']
199 |     assert query['date_received_max'] == ['2023-12-31']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:198:5
    |
196 |     assert query['product'] == ['Credit card']
197 |     assert query['state'] == ['CA']
198 |     assert query['date_received_min'] == ['2023-01-01']
    |     ^^^^^^
199 |     assert query['date_received_max'] == ['2023-12-31']
200 |     assert query['page'] == ['2']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:199:5
    |
197 |     assert query['state'] == ['CA']
198 |     assert query['date_received_min'] == ['2023-01-01']
199 |     assert query['date_received_max'] == ['2023-12-31']
    |     ^^^^^^
200 |     assert query['page'] == ['2']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:200:5
    |
198 |     assert query['date_received_min'] == ['2023-01-01']
199 |     assert query['date_received_max'] == ['2023-12-31']
200 |     assert query['page'] == ['2']
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_trend_mapping_defaults`
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:207:5
    |
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
207 |     assert query['tab'] == ['Trends']
    |     ^^^^^^
208 |     assert query['lens'] == ['product']
209 |     assert query['dateInterval'] == ['Month']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:208:5
    |
206 |     query = _parse_query(url)
207 |     assert query['tab'] == ['Trends']
208 |     assert query['lens'] == ['product']
    |     ^^^^^^
209 |     assert query['dateInterval'] == ['Month']
210 |     assert query['trend_depth'] == ['5']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:209:5
    |
207 |     assert query['tab'] == ['Trends']
208 |     assert query['lens'] == ['product']
209 |     assert query['dateInterval'] == ['Month']
    |     ^^^^^^
210 |     assert query['trend_depth'] == ['5']
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:210:5
    |
208 |     assert query['lens'] == ['product']
209 |     assert query['dateInterval'] == ['Month']
210 |     assert query['trend_depth'] == ['5']
    |     ^^^^^^
211 |
212 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:213:5
    |
212 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
213 |     assert not validation.unknown_keys
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_default_date_window`
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:219:5
    |
217 | def test_default_date_window():
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |     ^^^^^^
220 |     assert params['date_received_max'] == '2025-10-31'
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:220:5
    |
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
220 |     assert params['date_received_max'] == '2025-10-31'
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_ui_vs_api_counts`
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_params`
   --> tests/test_citations.py:227:33
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                 ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_client`
   --> tests/test_citations.py:227:45
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                             ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `ui_context`
   --> tests/test_citations.py:227:57
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                                         ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

SIM105 Use `contextlib.suppress(Exception)` instead of `try`-`except`-`pass`
   --> tests/test_citations.py:235:9
    |
233 |       try:
234 |           await page.goto(url, wait_until='domcontentloaded', timeout=60000)
235 | /         try:
236 | |             await page.wait_for_function(
237 | |                 'document.body && /matches out of/i.test(document.body.innerText)',
238 | |                 timeout=20000,
239 | |             )
240 | |         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(Exception): ...`

S110 `try`-`except`-`pass` detected, consider logging the exception
   --> tests/test_citations.py:240:9
    |
238 |                   timeout=20000,
239 |               )
240 | /         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |

BLE001 Do not catch blind exception: `Exception`
   --> tests/test_citations.py:240:16
    |
238 |                 timeout=20000,
239 |             )
240 |         except Exception:
    |                ^^^^^^^^^
241 |             pass
242 |         ui_text = await page.inner_text('body')
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:249:5
    |
247 |     ui_matches = _parse_ui_matches(ui_text)
248 |
249 |     assert api_total == ui_matches, (
    |     ^^^^^^
250 |         f'API/UI match count mismatch: api_total={api_total} ui_matches={ui_matches} url={url}'
251 |     )
    |

INP001 File `tests/test_mcp_auth.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_auth.py:1:1

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/test_mcp_auth.py:30:29
   |
28 |     try:
29 |         r = httpx.get(f'{url}/', timeout=5)
30 |         if r.status_code != 200:
   |                             ^^^
31 |             return False
32 |         payload = r.json()
   |

S603 `subprocess` call: check for execution of untrusted input
  --> tests/test_mcp_auth.py:47:35
   |
45 |     env.update(env_overrides)
46 |
47 |     proc: subprocess.Popen[str] = subprocess.Popen(
   |                                   ^^^^^^^^^^^^^^^^
48 |         [
49 |             sys.executable,
   |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:13
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:29
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |                             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

TRY301 Abstract `raise` to an inner function
  --> tests/test_mcp_auth.py:79:9
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/test_mcp_auth.py:79:15
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/test_mcp_auth.py:79:28
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
  --> tests/test_mcp_auth.py:92:5
   |
91 | @pytest.fixture(scope='module')
92 | def auth_server_url() -> Iterator[str]:
   |     ^^^^^^^^^^^^^^^
93 |     key = _dev_testing_api_key()
94 |     proc, url = _start_server(env_overrides={'CFPB_MCP_API_KEYS': key})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:108:5
    |
107 | @pytest.fixture(scope='module')
108 | def rate_limited_auth_server_url() -> Iterator[str]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
109 |     key = _dev_testing_api_key()
110 |     proc, url = _start_server(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:129:5
    |
129 | def test_mcp_http_requires_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:132:9
    |
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
132 |         assert r.status_code == 401
    |         ^^^^^^
133 |         assert (r.headers.get('content-type') or '').startswith('application/json')
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:132:33
    |
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
132 |         assert r.status_code == 401
    |                                 ^^^
133 |         assert (r.headers.get('content-type') or '').startswith('application/json')
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:133:9
    |
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
132 |         assert r.status_code == 401
133 |         assert (r.headers.get('content-type') or '').startswith('application/json')
    |         ^^^^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:136:5
    |
136 | def test_mcp_http_allows_valid_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
137 |     key = _dev_testing_api_key()
138 |     with httpx.Client(timeout=5) as client:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:147:9
    |
145 |             json={'jsonrpc': '2.0', 'id': 1, 'method': 'tools/list'},
146 |         )
147 |         assert r.status_code != 401
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:147:33
    |
145 |             json={'jsonrpc': '2.0', 'id': 1, 'method': 'tools/list'},
146 |         )
147 |         assert r.status_code != 401
    |                                 ^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:150:5
    |
150 | def test_mcp_rate_limit_429(rate_limited_auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
151 |     key = _dev_testing_api_key()
152 |     with httpx.Client(timeout=5) as client:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:158:9
    |
156 |             json={},
157 |         )
158 |         assert r1.status_code != 401
    |         ^^^^^^
159 |         assert r1.status_code != 429
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:158:34
    |
156 |             json={},
157 |         )
158 |         assert r1.status_code != 401
    |                                  ^^^
159 |         assert r1.status_code != 429
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:159:9
    |
157 |         )
158 |         assert r1.status_code != 401
159 |         assert r1.status_code != 429
    |         ^^^^^^
160 |
161 |         r2 = client.post(
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:159:34
    |
157 |         )
158 |         assert r1.status_code != 401
159 |         assert r1.status_code != 429
    |                                  ^^^
160 |
161 |         r2 = client.post(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:166:9
    |
164 |             json={},
165 |         )
166 |         assert r2.status_code == 429
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:166:34
    |
164 |             json={},
165 |         )
166 |         assert r2.status_code == 429
    |                                  ^^^
    |

INP001 File `tests/test_mcp_endpoints.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_endpoints.py:1:1

PLR0911 Too many return statements (9 > 6)
  --> tests/test_mcp_endpoints.py:45:5
   |
45 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
46 |     if not isinstance(payload, dict):
47 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/test_mcp_endpoints.py:69:8
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
70 |         return cid_int
71 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/test_mcp_endpoints.py:69:34
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
70 |         return cid_int
71 |     return None
   |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/test_mcp_endpoints.py:76:5
   |
74 |   async def _with_mcp(server_url: str, action: Callable[[ClientSession], Awaitable[None]]) -> None:
75 |       mcp_url = f'{server_url}/mcp'
76 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
77 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
78 |               await mcp.initialize()
79 |               await action(mcp)
   |
help: Combine `with` statements

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:82:11
   |
82 | async def test_tools_list_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^^^^^
83 |     async def _run(mcp: ClientSession) -> None:
84 |         tools = await mcp.list_tools()
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:86:9
   |
84 |         tools = await mcp.list_tools()
85 |         tool_names = {tool.name for tool in tools.tools}
86 |         assert 'search_complaints' in tool_names
   |         ^^^^^^
87 |         assert 'list_complaint_trends' in tool_names
88 |         assert 'get_state_aggregations' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:87:9
   |
85 |         tool_names = {tool.name for tool in tools.tools}
86 |         assert 'search_complaints' in tool_names
87 |         assert 'list_complaint_trends' in tool_names
   |         ^^^^^^
88 |         assert 'get_state_aggregations' in tool_names
89 |         assert 'suggest_filter_values' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:88:9
   |
86 |         assert 'search_complaints' in tool_names
87 |         assert 'list_complaint_trends' in tool_names
88 |         assert 'get_state_aggregations' in tool_names
   |         ^^^^^^
89 |         assert 'suggest_filter_values' in tool_names
90 |         assert 'get_complaint_document' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:89:9
   |
87 |         assert 'list_complaint_trends' in tool_names
88 |         assert 'get_state_aggregations' in tool_names
89 |         assert 'suggest_filter_values' in tool_names
   |         ^^^^^^
90 |         assert 'get_complaint_document' in tool_names
91 |         assert 'generate_cfpb_dashboard_url' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:90:9
   |
88 |         assert 'get_state_aggregations' in tool_names
89 |         assert 'suggest_filter_values' in tool_names
90 |         assert 'get_complaint_document' in tool_names
   |         ^^^^^^
91 |         assert 'generate_cfpb_dashboard_url' in tool_names
92 |         assert 'capture_cfpb_chart_screenshot' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:91:9
   |
89 |         assert 'suggest_filter_values' in tool_names
90 |         assert 'get_complaint_document' in tool_names
91 |         assert 'generate_cfpb_dashboard_url' in tool_names
   |         ^^^^^^
92 |         assert 'capture_cfpb_chart_screenshot' in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:92:9
   |
90 |         assert 'get_complaint_document' in tool_names
91 |         assert 'generate_cfpb_dashboard_url' in tool_names
92 |         assert 'capture_cfpb_chart_screenshot' in tool_names
   |         ^^^^^^
93 |
94 |     await _with_mcp(server_url, _run)
   |

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:97:11
   |
97 | async def test_search_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^
98 |     async def _run(mcp: ClientSession) -> None:
99 |         result = await mcp.call_tool('search_complaints', {'size': 1})
   |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:101:9
    |
 99 |         result = await mcp.call_tool('search_complaints', {'size': 1})
100 |         payload = _tool_payload(result)
101 |         assert isinstance(payload, dict)
    |         ^^^^^^
102 |         data = payload.get('data')
103 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:103:9
    |
101 |         assert isinstance(payload, dict)
102 |         data = payload.get('data')
103 |         assert isinstance(data, dict)
    |         ^^^^^^
104 |         assert 'hits' in data
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:104:9
    |
102 |         data = payload.get('data')
103 |         assert isinstance(data, dict)
104 |         assert 'hits' in data
    |         ^^^^^^
105 |
106 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:109:11
    |
109 | async def test_trends_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
110 |     async def _run(mcp: ClientSession) -> None:
111 |         result = await mcp.call_tool('list_complaint_trends', {'trend_depth': 5})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:113:9
    |
111 |         result = await mcp.call_tool('list_complaint_trends', {'trend_depth': 5})
112 |         payload = _tool_payload(result)
113 |         assert isinstance(payload, dict)
    |         ^^^^^^
114 |         data = payload.get('data')
115 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:115:9
    |
113 |         assert isinstance(payload, dict)
114 |         data = payload.get('data')
115 |         assert isinstance(data, dict)
    |         ^^^^^^
116 |
117 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:120:11
    |
120 | async def test_geo_states_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^
121 |     async def _run(mcp: ClientSession) -> None:
122 |         result = await mcp.call_tool('get_state_aggregations', {})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:124:9
    |
122 |         result = await mcp.call_tool('get_state_aggregations', {})
123 |         payload = _tool_payload(result)
124 |         assert isinstance(payload, dict)
    |         ^^^^^^
125 |         data = payload.get('data')
126 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:126:9
    |
124 |         assert isinstance(payload, dict)
125 |         data = payload.get('data')
126 |         assert isinstance(data, dict)
    |         ^^^^^^
127 |
128 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:132:11
    |
131 | @pytest.mark.parametrize('field', ['company', 'zip_code'])
132 | async def test_suggest_smoke(server_url: str, field: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^
133 |     async def _run(mcp: ClientSession) -> None:
134 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:141:9
    |
139 |         if isinstance(payload, str):
140 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
141 |         assert isinstance(payload, list)
    |         ^^^^^^
142 |         assert len(payload) <= 3
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:142:9
    |
140 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
141 |         assert isinstance(payload, list)
142 |         assert len(payload) <= 3
    |         ^^^^^^
143 |
144 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> tests/test_mcp_endpoints.py:142:32
    |
140 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
141 |         assert isinstance(payload, list)
142 |         assert len(payload) <= 3
    |                                ^
143 |
144 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:147:11
    |
147 | async def test_document_round_trip_from_search(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
148 |     async def _run(mcp: ClientSession) -> None:
149 |         search_result = await mcp.call_tool('search_complaints', {'size': 1})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:152:9
    |
150 |         payload = _tool_payload(search_result)
151 |         complaint_id = _extract_complaint_id_from_search_payload(payload)
152 |         assert complaint_id is not None, 'Expected a complaint id from search results'
    |         ^^^^^^
153 |
154 |         doc_result = await mcp.call_tool('get_complaint_document', {'complaint_id': str(complaint_id)})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:156:9
    |
154 |         doc_result = await mcp.call_tool('get_complaint_document', {'complaint_id': str(complaint_id)})
155 |         doc_payload = _tool_payload(doc_result)
156 |         assert isinstance(doc_payload, dict)
    |         ^^^^^^
157 |
158 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:161:11
    |
161 | async def test_signals_overall_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
162 |     async def _run(mcp: ClientSession) -> None:
163 |         date_min, date_max, current_month_prefix = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:169:9
    |
167 |         )
168 |         payload = _tool_payload(result)
169 |         assert isinstance(payload, dict)
    |         ^^^^^^
170 |         overall = (payload.get('signals') or {}).get('overall')
171 |         assert isinstance(overall, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:171:9
    |
169 |         assert isinstance(payload, dict)
170 |         overall = (payload.get('signals') or {}).get('overall')
171 |         assert isinstance(overall, dict)
    |         ^^^^^^
172 |         last_bucket = overall.get('last_bucket')
173 |         assert isinstance(last_bucket, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:173:9
    |
171 |         assert isinstance(overall, dict)
172 |         last_bucket = overall.get('last_bucket')
173 |         assert isinstance(last_bucket, dict)
    |         ^^^^^^
174 |         assert not str(last_bucket.get('label', '')).startswith(current_month_prefix)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:174:9
    |
172 |         last_bucket = overall.get('last_bucket')
173 |         assert isinstance(last_bucket, dict)
174 |         assert not str(last_bucket.get('label', '')).startswith(current_month_prefix)
    |         ^^^^^^
175 |
176 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:180:11
    |
179 | @pytest.mark.parametrize('group', ['product', 'issue'])
180 | async def test_signals_group_smoke(server_url: str, group: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^
181 |     async def _run(mcp: ClientSession) -> None:
182 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:193:9
    |
191 |         )
192 |         payload = _tool_payload(result)
193 |         assert isinstance(payload, dict)
    |         ^^^^^^
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:195:9
    |
193 |         assert isinstance(payload, dict)
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
    |         ^^^^^^
196 |         assert len(results) <= 5
197 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:196:9
    |
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
196 |         assert len(results) <= 5
    |         ^^^^^^
197 |         if results:
198 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:196:32
    |
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
196 |         assert len(results) <= 5
    |                                ^
197 |         if results:
198 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:199:13
    |
197 |         if results:
198 |             row0 = results[0]
199 |             assert isinstance(row0, dict)
    |             ^^^^^^
200 |             assert 'group' in row0
201 |             assert 'signals' in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:200:13
    |
198 |             row0 = results[0]
199 |             assert isinstance(row0, dict)
200 |             assert 'group' in row0
    |             ^^^^^^
201 |             assert 'signals' in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:201:13
    |
199 |             assert isinstance(row0, dict)
200 |             assert 'group' in row0
201 |             assert 'signals' in row0
    |             ^^^^^^
202 |
203 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:206:11
    |
206 | async def test_signals_company_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
207 |     async def _run(mcp: ClientSession) -> None:
208 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:218:9
    |
216 |         )
217 |         payload = _tool_payload(result)
218 |         assert isinstance(payload, dict)
    |         ^^^^^^
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:220:9
    |
218 |         assert isinstance(payload, dict)
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
    |         ^^^^^^
221 |         assert len(results) <= 5
222 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:221:9
    |
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
221 |         assert len(results) <= 5
    |         ^^^^^^
222 |         if results:
223 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:221:32
    |
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
221 |         assert len(results) <= 5
    |                                ^
222 |         if results:
223 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:224:13
    |
222 |         if results:
223 |             row0 = results[0]
224 |             assert isinstance(row0, dict)
    |             ^^^^^^
225 |             assert 'company' in row0
226 |             assert 'computed' in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:225:13
    |
223 |             row0 = results[0]
224 |             assert isinstance(row0, dict)
225 |             assert 'company' in row0
    |             ^^^^^^
226 |             assert 'computed' in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:226:13
    |
224 |             assert isinstance(row0, dict)
225 |             assert 'company' in row0
226 |             assert 'computed' in row0
    |             ^^^^^^
227 |
228 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:231:11
    |
231 | async def test_generate_cfpb_dashboard_url(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
232 |     async def _run(mcp: ClientSession) -> None:
233 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:240:9
    |
238 |         if isinstance(payload, dict) and 'result' in payload:
239 |             payload = payload['result']
240 |         assert isinstance(payload, str)
    |         ^^^^^^
241 |         assert payload.startswith('https://www.consumerfinance.gov/data-research/consumer-complaints/search/')
242 |         assert 'searchText=foreclosure' in payload
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:241:9
    |
239 |             payload = payload['result']
240 |         assert isinstance(payload, str)
241 |         assert payload.startswith('https://www.consumerfinance.gov/data-research/consumer-complaints/search/')
    |         ^^^^^^
242 |         assert 'searchText=foreclosure' in payload
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:242:9
    |
240 |         assert isinstance(payload, str)
241 |         assert payload.startswith('https://www.consumerfinance.gov/data-research/consumer-complaints/search/')
242 |         assert 'searchText=foreclosure' in payload
    |         ^^^^^^
243 |
244 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:247:11
    |
247 | async def test_capture_cfpb_chart_screenshot(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
248 |     async def _run(mcp: ClientSession) -> None:
249 |         try:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:263:9
    |
261 |         if isinstance(payload, dict) and 'result' in payload:
262 |             payload = payload['result']
263 |         assert isinstance(payload, str)
    |         ^^^^^^
264 |         assert len(payload) > 1000
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:264:9
    |
262 |             payload = payload['result']
263 |         assert isinstance(payload, str)
264 |         assert len(payload) > 1000
    |         ^^^^^^
265 |
266 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `1000` with a constant variable
   --> tests/test_mcp_endpoints.py:264:31
    |
262 |             payload = payload['result']
263 |         assert isinstance(payload, str)
264 |         assert len(payload) > 1000
    |                               ^^^^
265 |
266 |     await _with_mcp(server_url, _run)
    |

INP001 File `tests/transport/http/test_http_transport.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/transport/http/test_http_transport.py:1:1

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/transport/http/test_http_transport.py:12:5
   |
10 |       """Verify that the Streamable HTTP endpoint (POST /mcp) works."""
11 |       url = f'{server_url}/mcp'
12 | /     async with streamable_http_client(url) as (read_stream, write_stream, _):
13 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
14 |               await mcp.initialize()
15 |               tools = await mcp.list_tools()
   |
help: Combine `with` statements

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:17:13
   |
15 |             tools = await mcp.list_tools()
16 |             tool_names = {tool.name for tool in tools.tools}
17 |             assert 'search_complaints' in tool_names
   |             ^^^^^^
   |

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:25:9
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |         ^^^^^^
   |

PLR2004 Magic value used in comparison, consider replacing `405` with a constant variable
  --> tests/transport/http/test_http_transport.py:25:40
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |                                        ^^^
   |

INP001 File `tests/unit/test_params.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/unit/test_params.py:1:1

D103 Missing docstring in public function
 --> tests/unit/test_params.py:6:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |     assert prune_params({'a': None, 'b': '', 'c': '  ', 'd': 'ok'}) == {'d': 'ok'}
  |

S101 Use of `assert` detected
 --> tests/unit/test_params.py:7:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
7 |     assert prune_params({'a': None, 'b': '', 'c': '  ', 'd': 'ok'}) == {'d': 'ok'}
  |     ^^^^^^
  |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:10:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     assert prune_params({'a': [], 'b': [''], 'c': [' ', None], 'd': ['x', '', 'y']}) == {'d': ['x', 'y']}
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:11:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
11 |     assert prune_params({'a': [], 'b': [''], 'c': [' ', None], 'd': ['x', '', 'y']}) == {'d': ['x', 'y']}
   |     ^^^^^^
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:14:5
   |
14 | def test_prune_params_keeps_non_string_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     assert prune_params({'a': 0, 'b': False, 'c': True, 'd': 3.14}) == {
16 |         'a': 0,
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:15:5
   |
14 | def test_prune_params_keeps_non_string_values() -> None:
15 |     assert prune_params({'a': 0, 'b': False, 'c': True, 'd': 3.14}) == {
   |     ^^^^^^
16 |         'a': 0,
17 |         'b': 'false',
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:23:5
   |
23 | def test_prune_params_normalizes_boolean_like_strings() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
24 |     assert prune_params({'a': 'True', 'b': 'false', 'c': ['FALSE', 'ok']}) == {
25 |         'a': 'true',
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:24:5
   |
23 | def test_prune_params_normalizes_boolean_like_strings() -> None:
24 |     assert prune_params({'a': 'True', 'b': 'false', 'c': ['FALSE', 'ok']}) == {
   |     ^^^^^^
25 |         'a': 'true',
26 |         'b': 'false',
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:31:5
   |
31 | def test_build_params_filters_empty_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
32 |     params = build_params(
33 |         search_term='',
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:42:5
   |
41 |     # build_params returns already-pruned params
42 |     assert 'search_term' not in params
   |     ^^^^^^
43 |     assert 'field' not in params
44 |     assert params['company'] == ['Acme Bank']
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:43:5
   |
41 |     # build_params returns already-pruned params
42 |     assert 'search_term' not in params
43 |     assert 'field' not in params
   |     ^^^^^^
44 |     assert params['company'] == ['Acme Bank']
45 |     assert params['issue'] == ['Fees']
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:44:5
   |
42 |     assert 'search_term' not in params
43 |     assert 'field' not in params
44 |     assert params['company'] == ['Acme Bank']
   |     ^^^^^^
45 |     assert params['issue'] == ['Fees']
46 |     assert 'state' not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:45:5
   |
43 |     assert 'field' not in params
44 |     assert params['company'] == ['Acme Bank']
45 |     assert params['issue'] == ['Fees']
   |     ^^^^^^
46 |     assert 'state' not in params
47 |     assert 'tags' not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:46:5
   |
44 |     assert params['company'] == ['Acme Bank']
45 |     assert params['issue'] == ['Fees']
46 |     assert 'state' not in params
   |     ^^^^^^
47 |     assert 'tags' not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:47:5
   |
45 |     assert params['issue'] == ['Fees']
46 |     assert 'state' not in params
47 |     assert 'tags' not in params
   |     ^^^^^^
   |

PT006 Wrong type passed to first argument of `pytest.mark.parametrize`; expected `tuple`
  --> tests/unit/test_params.py:51:5
   |
50 | @pytest.mark.parametrize(
51 |     'raw,expected',
   |     ^^^^^^^^^^^^^^
52 |     [
53 |         ({'x': 'y'}, {'x': 'y'}),
   |
help: Use a `tuple` for the first argument

D103 Missing docstring in public function
  --> tests/unit/test_params.py:58:5
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `raw`
  --> tests/unit/test_params.py:58:29
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                             ^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `expected`
  --> tests/unit/test_params.py:58:34
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                                  ^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:59:5
   |
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
59 |     assert prune_params(raw) == expected
   |     ^^^^^^
   |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> utils/deeplink_mapping.py:4:29
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                             ^^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> utils/deeplink_mapping.py:4:39
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                                       ^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

D101 Missing docstring in public class
   --> utils/deeplink_mapping.py:119:7
    |
118 | @dataclass(frozen=True)
119 | class ValidationResult:
    |       ^^^^^^^^^^^^^^^^
120 |     unknown_keys: tuple[str, ...]
121 |     allowed_keys: tuple[str, ...]
    |

PLR0911 Too many return statements (8 > 6)
   --> utils/deeplink_mapping.py:124:5
    |
124 | def _clean_value(value: Any) -> Any | None:
    |     ^^^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:124:25
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                         ^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `_clean_value`
   --> utils/deeplink_mapping.py:124:33
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                                 ^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:150:23
    |
150 | def _parse_int(value: Any) -> int | None:
    |                       ^^^
151 |     if value is None:
152 |         return None
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:175:5
    |
175 | def normalize_api_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^
176 |     normalized: dict[str, Any] = {}
177 |     for key, raw_value in api_params.items():
    |

DTZ011 `datetime.date.today()` used
   --> utils/deeplink_mapping.py:191:23
    |
189 | def _default_end_date(today: date | None = None) -> str:
190 |     """Return the last day of the month before (today - 30 days)."""
191 |     anchor = today or date.today()
    |                       ^^^^^^^^^^^^
192 |     cutoff = anchor - timedelta(days=30)
193 |     first_of_cutoff_month = cutoff.replace(day=1)
    |
help: Use `datetime.datetime.now(tz=...).date()` instead

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:210:5
    |
210 | def validate_api_params(api_params: Mapping[str, Any], allowed_keys: Iterable[str]) -> ValidationResult:
    |     ^^^^^^^^^^^^^^^^^^^
211 |     allowed = set(allowed_keys)
212 |     unknown = tuple(sorted(key for key in api_params if key not in allowed))
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:216:5
    |
216 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
217 |     url_params: dict[str, Any] = {}
218 |     normalized = normalize_api_params(api_params)
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:243:5
    |
243 | def build_deeplink_url(
    |     ^^^^^^^^^^^^^^^^^^
244 |     api_params: Mapping[str, Any],
245 |     *,
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:263:5
    |
263 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
264 |     api_params: dict[str, Any] = {}
265 |     for key, raw_value in url_params.items():
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:287:5
    |
287 | def url_to_api_params(url: str) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^
288 |     parsed = urlparse(url)
289 |     query = parse_qs(parsed.query)
    |

Found 273 errors.
No fixes available (26 hidden fixes can be enabled with the `--unsafe-fixes` option).

=== pyright (pylance engine) ===
cmd: /Users/jim/cfpb-mcp/.venv/bin/python -m pyright /Users/jim/cfpb-mcp
exit_code: 1
--- stderr ---
/Users/jim/cfpb-mcp/.venv/bin/python: No module named pyright
--- stdout ---
(no output)

