timestamp_utc: 2025-12-21T23:14:39.464641+00:00
python: /Users/jim/cfpb-mcp/.venv/bin/python
=== ruff check . ===
cmd: ruff check .
exit_code: 1
--- stdout ---
I001 [*] Import block is un-sorted or un-formatted
  --> citations_mapping.py:3:1
   |
 1 |   """Compatibility wrapper for the deeplink mapping helpers."""
 2 |
 3 | / from utils.deeplink_mapping import (  # noqa: F401
 4 | |     UI_BASE_URL,
 5 | |     apply_default_dates,
 6 | |     api_params_to_url_params,
 7 | |     build_deeplink_url,
 8 | |     normalize_api_params,
 9 | |     url_params_to_api_params,
10 | |     url_to_api_params,
11 | | )
   | |_^
   |
help: Organize imports

ANN201 Missing return type annotation for public function `map_api_params_to_url_params`
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |
help: Add return type annotation

D103 Missing docstring in public function
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN001 Missing type annotation for function argument `api_params`
  --> citations_mapping.py:14:34
   |
14 | def map_api_params_to_url_params(api_params):
   |                                  ^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN201 Missing return type annotation for public function `demo_url_generation`
  --> scripts/demo_cfpb_ui.py:10:5
   |
10 | def demo_url_generation():
   |     ^^^^^^^^^^^^^^^^^^^
11 |     """Demonstrate URL generation for the official CFPB dashboard."""
12 |     print("=" * 70)
   |
help: Add return type annotation: `None`

INP001 File `scripts/run_tests.py` is part of an implicit namespace package. Add an `__init__.py`.
--> scripts/run_tests.py:1:1

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:17
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:33
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH100 `os.path.abspath()` should be replaced by `Path.resolve()`
  --> scripts/run_tests.py:21:49
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).resolve()`

PLR0911 Too many return statements (7 > 6)
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description="Run pytest suites for this repo (unit/integration/slow/contract/full)."
   |

D103 Missing docstring in public function
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description="Run pytest suites for this repo (unit/integration/slow/contract/full)."
   |

RUF005 Consider `[*default_args, "-m", "unit", *extra]` instead of concatenation
  --> scripts/run_tests.py:56:24
   |
55 |     if ns.suite == "unit":
56 |         return _pytest(default_args + ["-m", "unit"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
57 |
58 |     if ns.suite == "integration":
   |
help: Replace with `[*default_args, "-m", "unit", *extra]`

RUF005 Consider `[*default_args, "-m", "integration", *extra]` instead of concatenation
  --> scripts/run_tests.py:60:24
   |
58 |     if ns.suite == "integration":
59 |         # Includes anything under tests/ except slow/unit/contract.
60 |         return _pytest(default_args + ["-m", "integration"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |     if ns.suite == "slow":
   |
help: Replace with `[*default_args, "-m", "integration", *extra]`

RUF005 Consider `[*default_args, "-m", "slow", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:63:24
   |
62 |     if ns.suite == "slow":
63 |         return _pytest(default_args + ["-m", "slow", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |
65 |     if ns.suite == "contract":
   |
help: Replace with `[*default_args, "-m", "slow", "-rs", *extra]`

RUF005 Consider `[*default_args, "-m", "contract", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:66:24
   |
65 |     if ns.suite == "contract":
66 |         return _pytest(default_args + ["-m", "contract", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     if ns.suite == "full":
   |
help: Replace with `[*default_args, "-m", "contract", "-rs", *extra]`

RUF005 Consider `[*default_args, "-m", "unit", *extra]` instead of concatenation
  --> scripts/run_tests.py:70:22
   |
68 |     if ns.suite == "full":
69 |         # Run unit, then integration, then slow.
70 |         rc = _pytest(default_args + ["-m", "unit"] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
71 |         if rc != 0:
72 |             return rc
   |
help: Replace with `[*default_args, "-m", "unit", *extra]`

RUF005 Consider `[*default_args, "-m", "integration", *extra]` instead of concatenation
  --> scripts/run_tests.py:74:22
   |
72 |             return rc
73 |
74 |         rc = _pytest(default_args + ["-m", "integration"] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
75 |         if rc != 0:
76 |             return rc
   |
help: Replace with `[*default_args, "-m", "integration", *extra]`

RUF005 Consider `[*default_args, "-m", "slow", "-rs", *extra]` instead of concatenation
  --> scripts/run_tests.py:77:24
   |
75 |         if rc != 0:
76 |             return rc
77 |         return _pytest(default_args + ["-m", "slow", "-rs"] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |
79 |     _die(f"Unknown suite: {ns.suite}")
   |
help: Replace with `[*default_args, "-m", "slow", "-rs", *extra]`

INP001 File `tests/conftest.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/conftest.py:1:1

UP035 [*] Import from `collections.abc` instead: `Iterator`
 --> tests/conftest.py:8:1
  |
6 | import time
7 | from contextlib import closing
8 | from typing import Iterator
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^
9 | from urllib.parse import urlparse
  |
help: Import from `collections.abc`

ARG001 Unused function argument: `config`
  --> tests/conftest.py:16:5
   |
15 | def pytest_collection_modifyitems(
16 |     config: pytest.Config, items: list[pytest.Item]
   |     ^^^^^^
17 | ) -> None:  # noqa: ARG001
18 |     """Apply suite markers based on file path.
   |

RUF100 [*] Unused `noqa` directive (unused: `ARG001`)
  --> tests/conftest.py:17:13
   |
15 | def pytest_collection_modifyitems(
16 |     config: pytest.Config, items: list[pytest.Item]
17 | ) -> None:  # noqa: ARG001
   |             ^^^^^^^^^^^^^^
18 |     """Apply suite markers based on file path.
   |
help: Remove unused `noqa` directive

D202 [*] No blank lines allowed after function docstring (found 1)
  --> tests/conftest.py:18:5
   |
16 |       config: pytest.Config, items: list[pytest.Item]
17 |   ) -> None:  # noqa: ARG001
18 | /     """Apply suite markers based on file path.
19 | |
20 | |     - tests/contract/** -> contract
21 | |     - tests/unit/** -> unit
22 | |     - everything else under tests/** -> integration
23 | |
24 | |     This keeps suite selection stable even as the server is refactored.
25 | |     """
   | |_______^
26 |
27 |       for item in items:
   |
help: Remove blank line(s) after function docstring

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/conftest.py:49:29
   |
47 |     try:
48 |         r = httpx.get(f"{url}/", timeout=5)
49 |         if r.status_code != 200:
   |                             ^^^
50 |             return False
51 |         payload = r.json()
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:60:15
   |
58 |     parsed = urlparse(url)
59 |     if parsed.scheme not in {"http", "https"}:
60 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |     if not parsed.hostname or parsed.port is None:
62 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:60:26
   |
58 |     parsed = urlparse(url)
59 |     if parsed.scheme not in {"http", "https"}:
60 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |     if not parsed.hostname or parsed.port is None:
62 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:62:15
   |
60 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
61 |     if not parsed.hostname or parsed.port is None:
62 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
63 |     return str(parsed.hostname), int(parsed.port)
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:62:26
   |
60 |         raise ValueError(f"Unsupported scheme in TEST_SERVER_URL: {url}")
61 |     if not parsed.hostname or parsed.port is None:
62 |         raise ValueError(f"TEST_SERVER_URL must include hostname and port: {url}")
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
63 |     return str(parsed.hostname), int(parsed.port)
   |
help: Assign to variable; remove f-string literal

C901 `server_url` is too complex (16 > 10)
  --> tests/conftest.py:67:5
   |
66 | @pytest.fixture(scope="session")
67 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
68 |     """Start uvicorn in a subprocess and return the base URL."""
   |

PLR0912 Too many branches (17 > 12)
  --> tests/conftest.py:67:5
   |
66 | @pytest.fixture(scope="session")
67 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
68 |     """Start uvicorn in a subprocess and return the base URL."""
   |

PLR0915 Too many statements (55 > 50)
  --> tests/conftest.py:67:5
   |
66 | @pytest.fixture(scope="session")
67 | def server_url() -> Iterator[str]:
   |     ^^^^^^^^^^
68 |     """Start uvicorn in a subprocess and return the base URL."""
   |

D202 [*] No blank lines allowed after function docstring (found 1)
  --> tests/conftest.py:68:5
   |
66 | @pytest.fixture(scope="session")
67 | def server_url() -> Iterator[str]:
68 |     """Start uvicorn in a subprocess and return the base URL."""
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
69 |
70 |     configured_url = os.environ.get("TEST_SERVER_URL")
   |
help: Remove blank line(s) after function docstring

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:88:23
   |
86 |               host, port = _parse_host_port(url)
87 |               if host not in {"127.0.0.1", "localhost"}:
88 |                   raise RuntimeError(
   |  _______________________^
89 | |                     f"TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; "
90 | |                     "refusing to auto-start uvicorn."
91 | |                 )
   | |_________________^
92 |       else:
93 |           port = _pick_free_port()
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:89:21
   |
87 |               if host not in {"127.0.0.1", "localhost"}:
88 |                   raise RuntimeError(
89 | /                     f"TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; "
90 | |                     "refusing to auto-start uvicorn."
   | |_____________________________________________________^
91 |                   )
92 |       else:
   |
help: Assign to variable; remove f-string literal

SIM115 Use a context manager for opening files
   --> tests/conftest.py:107:16
    |
106 |     # Create a log file for the server process to avoid pipe buffer deadlocks
107 |     log_file = open("server_test.log", "w")
    |                ^^^^
108 |
109 |     proc = subprocess.Popen(
    |

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:107:16
    |
106 |     # Create a log file for the server process to avoid pipe buffer deadlocks
107 |     log_file = open("server_test.log", "w")
    |                ^^^^
108 |
109 |     proc = subprocess.Popen(
    |
help: Replace with `Path.open()`

S603 `subprocess` call: check for execution of untrusted input
   --> tests/conftest.py:109:12
    |
107 |     log_file = open("server_test.log", "w")
108 |
109 |     proc = subprocess.Popen(
    |            ^^^^^^^^^^^^^^^^
110 |         [
111 |             sys.executable,
    |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:122:13
    |
120 |             "warning",
121 |         ],
122 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |             ^^^^^^^^^^^^^^^
123 |         env=env,
124 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:122:29
    |
120 |             "warning",
121 |         ],
122 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |                             ^^^^^^^^^^^^^^^
123 |         env=env,
124 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:145:18
    |
143 |             # If it failed, read the log file
144 |             log_file.close()
145 |             with open("server_test.log", "r") as f:
    |                  ^^^^
146 |                 output = f.read()
147 |             raise RuntimeError(
    |
help: Replace with `Path.open()`

UP015 [*] Unnecessary mode argument
   --> tests/conftest.py:145:42
    |
143 |             # If it failed, read the log file
144 |             log_file.close()
145 |             with open("server_test.log", "r") as f:
    |                                          ^^^
146 |                 output = f.read()
147 |             raise RuntimeError(
    |
help: Remove mode argument

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:147:19
    |
145 |               with open("server_test.log", "r") as f:
146 |                   output = f.read()
147 |               raise RuntimeError(
    |  ___________________^
148 | |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
149 | |             )
    | |_____________^
150 |
151 |           # Final readiness check
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:148:17
    |
146 |                 output = f.read()
147 |             raise RuntimeError(
148 |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
149 |             )
    |
help: Assign to variable; remove f-string literal

E501 Line too long (122 > 120)
   --> tests/conftest.py:148:121
    |
146 |                 output = f.read()
147 |             raise RuntimeError(
148 |                 f"Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}"
    |                                                                                                                         ^^
149 |             )
    |

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:153:19
    |
151 |           # Final readiness check
152 |           if not _is_server_ready(url):
153 |               raise RuntimeError(
    |  ___________________^
154 | |                 f"Server failed to become ready on {url}. Last error: {last_err}."
155 | |             )
    | |_____________^
156 |
157 |           yield url
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:154:17
    |
152 |         if not _is_server_ready(url):
153 |             raise RuntimeError(
154 |                 f"Server failed to become ready on {url}. Last error: {last_err}."
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
155 |             )
    |
help: Assign to variable; remove f-string literal

W293 [*] Blank line contains whitespace
   --> tests/conftest.py:168:1
    |
166 |                 proc.kill()
167 |                 proc.wait(timeout=5)
168 |         
    | ^^^^^^^^
169 |         if not log_file.closed:
170 |             log_file.close()
    |
help: Remove whitespace from blank line

PT001 [*] Use `@pytest.fixture` over `@pytest.fixture()`
   --> tests/conftest.py:173:1
    |
173 | @pytest.fixture()
    | ^^^^^^^^^^^^^^^^^
174 | def client(server_url: str) -> Iterator[httpx.Client]:
175 |     with httpx.Client(base_url=server_url, timeout=30) as c:
    |
help: Remove parentheses

D103 Missing docstring in public function
   --> tests/conftest.py:174:5
    |
173 | @pytest.fixture()
174 | def client(server_url: str) -> Iterator[httpx.Client]:
    |     ^^^^^^
175 |     with httpx.Client(base_url=server_url, timeout=30) as c:
176 |         yield c
    |

INP001 File `tests/contract/test_anthropic_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_anthropic_mcp_contract.py:1:1

I001 [*] Import block is un-sorted or un-formatted
  --> tests/contract/test_anthropic_mcp_contract.py:1:1
   |
 1 | / import os
 2 | | import json
 3 | | import re
 4 | | from typing import Any, cast
 5 | |
 6 | | import pytest
 7 | | from anthropic import Anthropic
 8 | | from anthropic.types import (
 9 | |     MessageParam,
10 | |     ToolChoiceParam,
11 | |     ToolResultBlockParam,
12 | |     ToolUseBlock,
13 | | )
14 | | from dotenv import load_dotenv
15 | |
16 | | from mcp.client.session import ClientSession
17 | | from mcp.client.streamable_http import streamable_http_client
   | |_____________________________________________________________^
18 |
19 |   load_dotenv()
   |
help: Organize imports

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_anthropic_mcp_contract.py:23:16
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), ".env")
   |                ^^^^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_anthropic_mcp_contract.py:23:29
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), ".env")
   |                             ^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_anthropic_mcp_contract.py:24:12
   |
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), ".env")
24 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
25 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_anthropic_mcp_contract.py:28:14
   |
27 |     try:
28 |         with open(env_path, "r", encoding="utf-8") as f:
   |              ^^^^
29 |             for raw_line in f:
30 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

UP015 [*] Unnecessary mode argument
  --> tests/contract/test_anthropic_mcp_contract.py:28:29
   |
27 |     try:
28 |         with open(env_path, "r", encoding="utf-8") as f:
   |                             ^^^
29 |             for raw_line in f:
30 |                 line = raw_line.strip()
   |
help: Remove mode argument

ANN001 Missing type annotation for function argument `blocks`
  --> tests/contract/test_anthropic_mcp_contract.py:43:19
   |
43 | def _extract_text(blocks) -> str:
   |                   ^^^^^^
44 |     if not isinstance(blocks, list):
45 |         return str(blocks or "")
   |

B009 [*] Do not call `getattr` with a constant attribute value. It is not any safer than normal property access.
  --> tests/contract/test_anthropic_mcp_contract.py:49:30
   |
47 |     for b in blocks:
48 |         if getattr(b, "type", None) == "text" and hasattr(b, "text"):
49 |             parts.append(str(getattr(b, "text")))
   |                              ^^^^^^^^^^^^^^^^^^
50 |     return "\n".join([p for p in parts if p]).strip()
   |
help: Replace `getattr` with attribute access

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `payload`
  --> tests/contract/test_anthropic_mcp_contract.py:53:32
   |
53 | def _tool_result_text(payload: Any) -> str:
   |                                ^^^
54 |     if payload is None:
55 |         return ""
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:90:5
   |
88 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
89 |     matches = re.findall(r"\b\d{4,9}\b", text or "")
90 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
   |     ^^^^^^
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_anthropic_mcp_contract.py:92:5
   |
90 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:12
   |
90 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |            ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:31
   |
90 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |                               ^
93 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_anthropic_mcp_contract.py:96:5
   |
96 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
97 |     if not isinstance(payload, dict):
98 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:8
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |        ^
121 |         return cid_int
122 |     return None
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:34
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |                                  ^
121 |         return cid_int
122 |     return None
    |

C901 `test_anthropic_mcp_tool_loop_smoke` is too complex (12 > 10)
   --> tests/contract/test_anthropic_mcp_contract.py:127:11
    |
125 | @pytest.mark.fast
126 | @pytest.mark.anyio
127 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (62 > 50)
   --> tests/contract/test_anthropic_mcp_contract.py:127:11
    |
125 | @pytest.mark.fast
126 | @pytest.mark.anyio
127 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_anthropic_mcp_contract.py:127:11
    |
125 | @pytest.mark.fast
126 | @pytest.mark.anyio
127 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:142:121
    |
140 |     user_prompt = (
141 |         "I'm researching CFPB consumer complaints about loan forbearance. "
142 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
143 |         "the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. "
144 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_anthropic_mcp_contract.py:152:5
    |
151 |       # Connect using Streamable HTTP client
152 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
153 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
154 |               await mcp.initialize()
155 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> tests/contract/test_anthropic_mcp_contract.py:186:26
    |
185 |                 messages.append(
186 |                     cast(MessageParam, {"role": "assistant", "content": resp.content})
    |                          ^^^^^^^^^^^^
187 |                 )
    |
help: Add quotes

ERA001 Found commented-out code
   --> tests/contract/test_anthropic_mcp_contract.py:189:17
    |
187 |                 )
188 |
189 |                 # tool_uses = [c for c in resp.content if getattr(c, "type", None) == "tool_use"]
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
190 |                 tool_uses: list[ToolUseBlock] = [
191 |                     c for c in resp.content if isinstance(c, ToolUseBlock)
    |
help: Remove commented-out code

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> tests/contract/test_anthropic_mcp_contract.py:201:29
    |
199 |                     messages.append(
200 |                         cast(
201 |                             MessageParam,
    |                             ^^^^^^^^^^^^
202 |                             {
203 |                                 "role": "user",
    |
help: Add quotes

E501 Line too long (161 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:204:121
    |
202 | …
203 | …
204 | … now (complaint id, company, state if present, and a 2-3 sentence grounded summary).",
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 | …
206 | …
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> tests/contract/test_anthropic_mcp_contract.py:234:25
    |
232 |                     tool_payload = result.structuredContent or result.content
233 |                     tool_block = cast(
234 |                         ToolResultBlockParam,
    |                         ^^^^^^^^^^^^^^^^^^^^
235 |                         {
236 |                             "type": "tool_result",
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> tests/contract/test_anthropic_mcp_contract.py:242:30
    |
240 |                     )
241 |                     messages.append(
242 |                         cast(MessageParam, {"role": "user", "content": [tool_block]})
    |                              ^^^^^^^^^^^^
243 |                     )
    |
help: Add quotes

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:248:13
    |
246 |                 (m for m in reversed(messages) if m.get("role") == "assistant"), None
247 |             )
248 |             assert last_assistant is not None
    |             ^^^^^^
249 |             text = _extract_text(last_assistant.get("content"))
250 |             assert text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:250:13
    |
248 |             assert last_assistant is not None
249 |             text = _extract_text(last_assistant.get("content"))
250 |             assert text
    |             ^^^^^^
251 |             assert "MCP tools unavailable" not in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:251:13
    |
249 |             text = _extract_text(last_assistant.get("content"))
250 |             assert text
251 |             assert "MCP tools unavailable" not in text
    |             ^^^^^^
252 |
253 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:255:13
    |
253 |             final_text = text
254 |
255 |             assert complaint_id_from_tools is not None, (
    |             ^^^^^^
256 |                 "Expected the agent to obtain a complaint id via tools"
257 |             )
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:258:13
    |
256 |                 "Expected the agent to obtain a complaint id via tools"
257 |             )
258 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
259 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:258:20
    |
256 |                 "Expected the agent to obtain a complaint id via tools"
257 |             )
258 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
259 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:258:62
    |
256 |                 "Expected the agent to obtain a complaint id via tools"
257 |             )
258 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
259 |             assert str(complaint_id_from_tools) in text
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:259:13
    |
257 |             )
258 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
259 |             assert str(complaint_id_from_tools) in text
    |             ^^^^^^
260 |
261 |             # Keep the original "must contain a 4-9 digit integer" guard, but validate
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:264:13
    |
262 |             # it matches the tool-derived complaint id for stability.
263 |             complaint_id, _ = _extract_complaint_id_from_text(text)
264 |             assert complaint_id == complaint_id_from_tools
    |             ^^^^^^
265 |
266 |             doc_result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:273:5
    |
271 |             complaint_doc = _coerce_json(doc_payload) or doc_payload
272 |
273 |     assert final_text is not None
    |     ^^^^^^
274 |     assert complaint_id_from_tools is not None
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:274:5
    |
273 |     assert final_text is not None
274 |     assert complaint_id_from_tools is not None
    |     ^^^^^^
275 |
276 |     company = _extract_company_from_document(complaint_doc)
    |

S101 Use of `assert` detected
   --> tests/contract/test_anthropic_mcp_contract.py:282:5
    |
280 |         )
281 |     first_word = company.split()[0].lower()
282 |     assert first_word in final_text.lower()
    |     ^^^^^^
    |

INP001 File `tests/contract/test_openai_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_openai_mcp_contract.py:1:1

I001 [*] Import block is un-sorted or un-formatted
  --> tests/contract/test_openai_mcp_contract.py:1:1
   |
 1 | / import json
 2 | | import os
 3 | | import re
 4 | |
 5 | | from dotenv import load_dotenv
 6 | | import pytest
 7 | | import openai
 8 | | from openai import OpenAI
 9 | |
10 | | from mcp.client.session import ClientSession
11 | | from mcp.client.streamable_http import streamable_http_client
   | |_____________________________________________________________^
12 |
13 |   load_dotenv()
   |
help: Organize imports

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_openai_mcp_contract.py:18:16
   |
16 | def _load_dotenv_if_present() -> None:
17 |     """Load .env for local runs without requiring external tooling."""
18 |     env_path = os.path.join(os.getcwd(), ".env")
   |                ^^^^^^^^^^^^
19 |     if not os.path.exists(env_path):
20 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_openai_mcp_contract.py:18:29
   |
16 | def _load_dotenv_if_present() -> None:
17 |     """Load .env for local runs without requiring external tooling."""
18 |     env_path = os.path.join(os.getcwd(), ".env")
   |                             ^^^^^^^^^
19 |     if not os.path.exists(env_path):
20 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_openai_mcp_contract.py:19:12
   |
17 |     """Load .env for local runs without requiring external tooling."""
18 |     env_path = os.path.join(os.getcwd(), ".env")
19 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
20 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_openai_mcp_contract.py:23:14
   |
22 |     try:
23 |         with open(env_path, "r", encoding="utf-8") as f:
   |              ^^^^
24 |             for raw_line in f:
25 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

UP015 [*] Unnecessary mode argument
  --> tests/contract/test_openai_mcp_contract.py:23:29
   |
22 |     try:
23 |         with open(env_path, "r", encoding="utf-8") as f:
   |                             ^^^
24 |             for raw_line in f:
25 |                 line = raw_line.strip()
   |
help: Remove mode argument

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:40:5
   |
38 | def _extract_complaint_id_from_text(text: str) -> tuple[int, str]:
39 |     matches = re.findall(r"\b\d{4,9}\b", text or "")
40 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
   |     ^^^^^^
41 |     token = max(matches, key=len)
42 |     assert 4 <= len(token) <= 9
   |

S101 Use of `assert` detected
  --> tests/contract/test_openai_mcp_contract.py:42:5
   |
40 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
41 |     token = max(matches, key=len)
42 |     assert 4 <= len(token) <= 9
   |     ^^^^^^
43 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:42:12
   |
40 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
41 |     token = max(matches, key=len)
42 |     assert 4 <= len(token) <= 9
   |            ^
43 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:42:31
   |
40 |     assert matches, "Expected a 4-9 digit integer token in the final response text"
41 |     token = max(matches, key=len)
42 |     assert 4 <= len(token) <= 9
   |                               ^
43 |     return int(token), token
   |

PLR0911 Too many return statements (9 > 6)
  --> tests/contract/test_openai_mcp_contract.py:64:5
   |
64 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
65 |     if not isinstance(payload, dict):
66 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:88:8
   |
86 |     except ValueError:
87 |         return None
88 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
89 |         return cid_int
90 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:88:34
   |
86 |     except ValueError:
87 |         return None
88 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
89 |         return cid_int
90 |     return None
   |

C901 `test_openai_mcp_tool_loop_smoke` is too complex (20 > 10)
   --> tests/contract/test_openai_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

PLR0912 Too many branches (21 > 12)
   --> tests/contract/test_openai_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

PLR0915 Too many statements (82 > 50)
   --> tests/contract/test_openai_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

D103 Missing docstring in public function
   --> tests/contract/test_openai_mcp_contract.py:126:11
    |
124 | @pytest.mark.fast
125 | @pytest.mark.anyio
126 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
127 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_openai_mcp_contract.py:140:121
    |
138 |     prompt = (
139 |         "I'm researching CFPB consumer complaints about loan forbearance. "
140 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
141 |         "the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. "
142 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_openai_mcp_contract.py:150:5
    |
148 |       tool_calls_seen = False
149 |
150 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
151 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
152 |               await mcp.initialize()
153 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:247:13
    |
246 |             text = (resp.output_text or "").strip()
247 |             assert text, "Expected a final answer"
    |             ^^^^^^
248 |             assert "MCP tools unavailable" not in text
249 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:248:13
    |
246 |             text = (resp.output_text or "").strip()
247 |             assert text, "Expected a final answer"
248 |             assert "MCP tools unavailable" not in text
    |             ^^^^^^
249 |             final_text = text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:264:13
    |
262 |                 )
263 |
264 |             assert complaint_id_from_tools is not None, (
    |             ^^^^^^
265 |                 "Expected the agent to obtain a complaint id via tools"
266 |             )
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:267:13
    |
265 |                 "Expected the agent to obtain a complaint id via tools"
266 |             )
267 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |             ^^^^^^
268 |
269 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:267:20
    |
265 |                 "Expected the agent to obtain a complaint id via tools"
266 |             )
267 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
268 |
269 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:267:62
    |
265 |                 "Expected the agent to obtain a complaint id via tools"
266 |             )
267 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
268 |
269 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:272:17
    |
270 |             if str(complaint_id_from_tools) in text:
271 |                 complaint_id_for_validation = complaint_id_from_tools
272 |                 assert complaint_id_from_text == complaint_id_from_tools
    |                 ^^^^^^
273 |             else:
274 |                 complaint_id_for_validation = complaint_id_from_text
    |

S101 Use of `assert` detected
   --> tests/contract/test_openai_mcp_contract.py:286:5
    |
284 |         pytest.skip(f"Complaint {complaint_id_from_tools} document missing company field")
285 |     first_word = company.split()[0].lower()
286 |     assert first_word in (final_text or "").lower()
    |     ^^^^^^
    |

INP001 File `tests/playwright_helpers.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/playwright_helpers.py:1:1

ANN201 Missing return type annotation for public function `fast_playwright_context`
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |
help: Add return type annotation

D103 Missing docstring in public function
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |

PLC0415 `import` should be at the top-level of a file
  --> tests/playwright_helpers.py:9:9
   |
 7 | async def fast_playwright_context():
 8 |     try:
 9 |         from playwright.async_api import async_playwright
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/playwright_helpers.py:11:15
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/playwright_helpers.py:11:28
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f"Playwright unavailable for UI verification: {exc}") from exc
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |
help: Assign to variable; remove f-string literal

ANN202 Missing return type annotation for private function `_block_heavy_assets`
  --> tests/playwright_helpers.py:17:19
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                   ^^^^^^^^^^^^^^^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |
help: Add return type annotation: `None`

ANN001 Missing type annotation for function argument `route`
  --> tests/playwright_helpers.py:17:39
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                       ^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |

ANN001 Missing type annotation for function argument `request`
  --> tests/playwright_helpers.py:17:46
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                              ^^^^^^^
18 |             if request.resource_type in {"image", "media", "font"}:
19 |                 await route.abort()
   |

INP001 File `tests/test_citations.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_citations.py:1:1

I001 [*] Import block is un-sorted or un-formatted
  --> tests/test_citations.py:1:1
   |
 1 | / from __future__ import annotations
 2 | |
 3 | | import asyncio
 4 | | from datetime import date
 5 | | import re
 6 | | from typing import Any, Dict, Mapping
 7 | | from urllib.parse import parse_qs, urlparse
 8 | |
 9 | | import httpx
10 | | import pytest
11 | |
12 | | from citations_mapping import build_deeplink_url, map_api_params_to_url_params
13 | | from utils.deeplink_mapping import (
14 | |     TRENDS_ENDPOINT_KEYS,
15 | |     apply_default_dates,
16 | |     validate_api_params,
17 | | )
18 | | from tests.playwright_helpers import fast_playwright_context
19 | | from server import BASE_URL
   | |___________________________^
20 |
21 |   FAST_URL_CASES = [
   |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> tests/test_citations.py:6:1
  |
4 | from datetime import date
5 | import re
6 | from typing import Any, Dict, Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 | from urllib.parse import parse_qs, urlparse
  |
help: Import from `collections.abc`

UP035 `typing.Dict` is deprecated, use `dict` instead
 --> tests/test_citations.py:6:1
  |
4 | from datetime import date
5 | import re
6 | from typing import Any, Dict, Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 | from urllib.parse import parse_qs, urlparse
  |

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> tests/test_citations.py:122:31
    |
122 | def _parse_query(url: str) -> Dict[str, list[str]]:
    |                               ^^^^
123 |     parsed = urlparse(url)
124 |     return parse_qs(parsed.query)
    |
help: Replace with `dict`

TRY003 Avoid specifying long messages outside the exception class
   --> tests/test_citations.py:132:11
    |
130 |         if match:
131 |             return int(match.group(1).replace(",", ""))
132 |     raise ValueError("Unable to locate matches-out-of count in UI text.")
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |

EM101 Exception must not use a string literal, assign to variable first
   --> tests/test_citations.py:132:22
    |
130 |         if match:
131 |             return int(match.group(1).replace(",", ""))
132 |     raise ValueError("Unable to locate matches-out-of count in UI text.")
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
help: Assign to variable; remove string literal

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
   --> tests/test_citations.py:139:32
    |
137 | ) -> int:
138 |     response = await client.get(BASE_URL, params=api_params)
139 |     if response.status_code != 200:
    |                                ^^^
140 |         pytest.fail(f"API call failed: {response.url} ({response.status_code})")
    |

D103 Missing docstring in public function
   --> tests/test_citations.py:154:11
    |
153 | @pytest.fixture(scope="module")
154 | async def api_client() -> httpx.AsyncClient:
    |           ^^^^^^^^^^
155 |     async with httpx.AsyncClient(timeout=20.0) as client:
156 |         yield client
    |

ANN201 Missing return type annotation for public function `ui_context`
   --> tests/test_citations.py:160:11
    |
159 | @pytest.fixture(scope="module")
160 | async def ui_context():
    |           ^^^^^^^^^^
161 |     try:
162 |         async with fast_playwright_context() as context:
    |
help: Add return type annotation

D103 Missing docstring in public function
   --> tests/test_citations.py:160:11
    |
159 | @pytest.fixture(scope="module")
160 | async def ui_context():
    |           ^^^^^^^^^^
161 |     try:
162 |         async with fast_playwright_context() as context:
    |

ANN201 Missing return type annotation for public function `test_map_api_params_to_url_params_examples`
   --> tests/test_citations.py:169:5
    |
168 | @pytest.mark.fast
169 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
170 |     api_params = {
171 |         "search_term": "mortgage",
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:169:5
    |
168 | @pytest.mark.fast
169 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
170 |     api_params = {
171 |         "search_term": "mortgage",
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:178:5
    |
176 |     }
177 |     mapped = map_api_params_to_url_params(api_params)
178 |     assert mapped["searchText"] == "mortgage"
    |     ^^^^^^
179 |     assert mapped["searchField"] == "all"
180 |     assert mapped["size"] == 25
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:179:5
    |
177 |     mapped = map_api_params_to_url_params(api_params)
178 |     assert mapped["searchText"] == "mortgage"
179 |     assert mapped["searchField"] == "all"
    |     ^^^^^^
180 |     assert mapped["size"] == 25
181 |     assert mapped["sort"] == "created_date_desc"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:180:5
    |
178 |     assert mapped["searchText"] == "mortgage"
179 |     assert mapped["searchField"] == "all"
180 |     assert mapped["size"] == 25
    |     ^^^^^^
181 |     assert mapped["sort"] == "created_date_desc"
    |

PLR2004 Magic value used in comparison, consider replacing `25` with a constant variable
   --> tests/test_citations.py:180:30
    |
178 |     assert mapped["searchText"] == "mortgage"
179 |     assert mapped["searchField"] == "all"
180 |     assert mapped["size"] == 25
    |                              ^^
181 |     assert mapped["sort"] == "created_date_desc"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:181:5
    |
179 |     assert mapped["searchField"] == "all"
180 |     assert mapped["size"] == 25
181 |     assert mapped["sort"] == "created_date_desc"
    |     ^^^^^^
182 |
183 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:185:5
    |
183 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
184 |     query = _parse_query(url)
185 |     assert query["page"] == ["1"]
    |     ^^^^^^
186 |
187 |     api_params = {
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:197:5
    |
195 |     url = build_deeplink_url(api_params, today=FIXED_TODAY)
196 |     query = _parse_query(url)
197 |     assert query["product"] == ["Credit card"]
    |     ^^^^^^
198 |     assert query["state"] == ["CA"]
199 |     assert query["date_received_min"] == ["2023-01-01"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:198:5
    |
196 |     query = _parse_query(url)
197 |     assert query["product"] == ["Credit card"]
198 |     assert query["state"] == ["CA"]
    |     ^^^^^^
199 |     assert query["date_received_min"] == ["2023-01-01"]
200 |     assert query["date_received_max"] == ["2023-12-31"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:199:5
    |
197 |     assert query["product"] == ["Credit card"]
198 |     assert query["state"] == ["CA"]
199 |     assert query["date_received_min"] == ["2023-01-01"]
    |     ^^^^^^
200 |     assert query["date_received_max"] == ["2023-12-31"]
201 |     assert query["page"] == ["2"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:200:5
    |
198 |     assert query["state"] == ["CA"]
199 |     assert query["date_received_min"] == ["2023-01-01"]
200 |     assert query["date_received_max"] == ["2023-12-31"]
    |     ^^^^^^
201 |     assert query["page"] == ["2"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:201:5
    |
199 |     assert query["date_received_min"] == ["2023-01-01"]
200 |     assert query["date_received_max"] == ["2023-12-31"]
201 |     assert query["page"] == ["2"]
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_trend_mapping_defaults`
   --> tests/test_citations.py:205:5
    |
204 | @pytest.mark.fast
205 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
206 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
207 |     query = _parse_query(url)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:205:5
    |
204 | @pytest.mark.fast
205 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
206 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
207 |     query = _parse_query(url)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:208:5
    |
206 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
207 |     query = _parse_query(url)
208 |     assert query["tab"] == ["Trends"]
    |     ^^^^^^
209 |     assert query["lens"] == ["product"]
210 |     assert query["dateInterval"] == ["Month"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:209:5
    |
207 |     query = _parse_query(url)
208 |     assert query["tab"] == ["Trends"]
209 |     assert query["lens"] == ["product"]
    |     ^^^^^^
210 |     assert query["dateInterval"] == ["Month"]
211 |     assert query["trend_depth"] == ["5"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:210:5
    |
208 |     assert query["tab"] == ["Trends"]
209 |     assert query["lens"] == ["product"]
210 |     assert query["dateInterval"] == ["Month"]
    |     ^^^^^^
211 |     assert query["trend_depth"] == ["5"]
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:211:5
    |
209 |     assert query["lens"] == ["product"]
210 |     assert query["dateInterval"] == ["Month"]
211 |     assert query["trend_depth"] == ["5"]
    |     ^^^^^^
212 |
213 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:214:5
    |
213 |     validation = validate_api_params(EXAMPLE_TREND_QUERY, TRENDS_ENDPOINT_KEYS)
214 |     assert not validation.unknown_keys
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_default_date_window`
   --> tests/test_citations.py:218:5
    |
217 | @pytest.mark.fast
218 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
219 |     params = apply_default_dates({}, today=FIXED_TODAY)
220 |     assert params["date_received_min"] == "2011-12-01"
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:218:5
    |
217 | @pytest.mark.fast
218 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
219 |     params = apply_default_dates({}, today=FIXED_TODAY)
220 |     assert params["date_received_min"] == "2011-12-01"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:220:5
    |
218 | def test_default_date_window():
219 |     params = apply_default_dates({}, today=FIXED_TODAY)
220 |     assert params["date_received_min"] == "2011-12-01"
    |     ^^^^^^
221 |     assert params["date_received_max"] == "2025-10-31"
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:221:5
    |
219 |     params = apply_default_dates({}, today=FIXED_TODAY)
220 |     assert params["date_received_min"] == "2011-12-01"
221 |     assert params["date_received_max"] == "2025-10-31"
    |     ^^^^^^
    |

ANN201 Missing return type annotation for public function `test_ui_vs_api_counts`
   --> tests/test_citations.py:228:11
    |
226 | @pytest.mark.anyio
227 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
228 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
229 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
230 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:228:11
    |
226 | @pytest.mark.anyio
227 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
228 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
229 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
230 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_params`
   --> tests/test_citations.py:228:33
    |
226 | @pytest.mark.anyio
227 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
228 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                 ^^^^^^^^^^
229 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
230 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_client`
   --> tests/test_citations.py:228:45
    |
226 | @pytest.mark.anyio
227 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
228 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                             ^^^^^^^^^^
229 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
230 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `ui_context`
   --> tests/test_citations.py:228:57
    |
226 | @pytest.mark.anyio
227 | @pytest.mark.parametrize("api_params", EXAMPLE_API_QUERIES)
228 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                                         ^^^^^^^^^^
229 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
230 |     url = build_deeplink_url(api_params_with_dates, tab="List", today=FIXED_TODAY)
    |

SIM105 Use `contextlib.suppress(Exception)` instead of `try`-`except`-`pass`
   --> tests/test_citations.py:238:9
    |
236 |       try:
237 |           await page.goto(url, wait_until="domcontentloaded", timeout=60000)
238 | /         try:
239 | |             await page.wait_for_function(
240 | |                 "document.body && /matches out of/i.test(document.body.innerText)",
241 | |                 timeout=20000,
242 | |             )
243 | |         except Exception:
244 | |             pass
    | |________________^
245 |           ui_text = await page.inner_text("body")
246 |       finally:
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(Exception): ...`

S110 `try`-`except`-`pass` detected, consider logging the exception
   --> tests/test_citations.py:243:9
    |
241 |                   timeout=20000,
242 |               )
243 | /         except Exception:
244 | |             pass
    | |________________^
245 |           ui_text = await page.inner_text("body")
246 |       finally:
    |

BLE001 Do not catch blind exception: `Exception`
   --> tests/test_citations.py:243:16
    |
241 |                 timeout=20000,
242 |             )
243 |         except Exception:
    |                ^^^^^^^^^
244 |             pass
245 |         ui_text = await page.inner_text("body")
    |

S101 Use of `assert` detected
   --> tests/test_citations.py:252:5
    |
250 |     ui_matches = _parse_ui_matches(ui_text)
251 |
252 |     assert api_total == ui_matches, (
    |     ^^^^^^
253 |         "API/UI match count mismatch: "
254 |         f"api_total={api_total} ui_matches={ui_matches} url={url}"
    |

INP001 File `tests/test_mcp_auth.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_auth.py:1:1

UP035 [*] Import from `collections.abc` instead: `Iterator`
  --> tests/test_mcp_auth.py:8:1
   |
 6 | import time
 7 | from contextlib import closing
 8 | from typing import Iterator
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^
 9 |
10 | import httpx
   |
help: Import from `collections.abc`

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/test_mcp_auth.py:30:29
   |
28 |     try:
29 |         r = httpx.get(f"{url}/", timeout=5)
30 |         if r.status_code != 200:
   |                             ^^^
31 |             return False
32 |         payload = r.json()
   |

S603 `subprocess` call: check for execution of untrusted input
  --> tests/test_mcp_auth.py:49:35
   |
47 |     env.update(env_overrides)
48 |
49 |     proc: subprocess.Popen[str] = subprocess.Popen(
   |                                   ^^^^^^^^^^^^^^^^
50 |         [
51 |             sys.executable,
   |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:62:13
   |
60 |             "warning",
61 |         ],
62 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |             ^^^^^^^^^^^^^^^
63 |         env=env,
64 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:62:29
   |
60 |             "warning",
61 |         ],
62 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |                             ^^^^^^^^^^^^^^^
63 |         env=env,
64 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

TRY301 Abstract `raise` to an inner function
  --> tests/test_mcp_auth.py:81:9
   |
79 |           if proc.stdout is not None:
80 |               output = proc.stdout.read() or ""
81 | /         raise RuntimeError(
82 | |             f"Auth test server failed to start on {url}. Output:\n{output}"
83 | |         )
   | |_________^
84 |       except Exception:
85 |           if proc.poll() is None:
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/test_mcp_auth.py:81:15
   |
79 |           if proc.stdout is not None:
80 |               output = proc.stdout.read() or ""
81 |           raise RuntimeError(
   |  _______________^
82 | |             f"Auth test server failed to start on {url}. Output:\n{output}"
83 | |         )
   | |_________^
84 |       except Exception:
85 |           if proc.poll() is None:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/test_mcp_auth.py:82:13
   |
80 |             output = proc.stdout.read() or ""
81 |         raise RuntimeError(
82 |             f"Auth test server failed to start on {url}. Output:\n{output}"
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
83 |         )
84 |     except Exception:
   |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
  --> tests/test_mcp_auth.py:96:5
   |
95 | @pytest.fixture(scope="module")
96 | def auth_server_url() -> Iterator[str]:
   |     ^^^^^^^^^^^^^^^
97 |     key = _dev_testing_api_key()
98 |     proc, url = _start_server(env_overrides={"CFPB_MCP_API_KEYS": key})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:112:5
    |
111 | @pytest.fixture(scope="module")
112 | def rate_limited_auth_server_url() -> Iterator[str]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
113 |     key = _dev_testing_api_key()
114 |     proc, url = _start_server(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:133:5
    |
133 | def test_mcp_http_requires_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:136:9
    |
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
    |         ^^^^^^
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:136:33
    |
134 |     with httpx.Client(timeout=5) as client:
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
    |                                 ^^^
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:137:9
    |
135 |         r = client.post(f"{auth_server_url}/mcp", json={})
136 |         assert r.status_code == 401
137 |         assert (r.headers.get("content-type") or "").startswith("application/json")
    |         ^^^^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:140:5
    |
140 | def test_mcp_http_allows_valid_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
141 |     key = _dev_testing_api_key()
142 |     with httpx.Client(timeout=5) as client:
    |

W291 [*] Trailing whitespace
   --> tests/test_mcp_auth.py:144:76
    |
142 |     with httpx.Client(timeout=5) as client:
143 |         # We don't need to stream here, just check that the POST request gets through auth.
144 |         # It might return 200, 400 (bad JSON-RPC), or 406 (Not Acceptable), 
    |                                                                            ^
145 |         # but 401 means auth failed.
146 |         r = client.post(
    |
help: Remove trailing whitespace

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:151:9
    |
149 |             json={"jsonrpc": "2.0", "id": 1, "method": "tools/list"},
150 |         )
151 |         assert r.status_code != 401
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:151:33
    |
149 |             json={"jsonrpc": "2.0", "id": 1, "method": "tools/list"},
150 |         )
151 |         assert r.status_code != 401
    |                                 ^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:154:5
    |
154 | def test_mcp_rate_limit_429(rate_limited_auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
155 |     key = _dev_testing_api_key()
156 |     with httpx.Client(timeout=5) as client:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:162:9
    |
160 |             json={},
161 |         )
162 |         assert r1.status_code != 401
    |         ^^^^^^
163 |         assert r1.status_code != 429
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:162:34
    |
160 |             json={},
161 |         )
162 |         assert r1.status_code != 401
    |                                  ^^^
163 |         assert r1.status_code != 429
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:163:9
    |
161 |         )
162 |         assert r1.status_code != 401
163 |         assert r1.status_code != 429
    |         ^^^^^^
164 |
165 |         r2 = client.post(
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:163:34
    |
161 |         )
162 |         assert r1.status_code != 401
163 |         assert r1.status_code != 429
    |                                  ^^^
164 |
165 |         r2 = client.post(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_auth.py:170:9
    |
168 |             json={},
169 |         )
170 |         assert r2.status_code == 429
    |         ^^^^^^
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:170:34
    |
168 |             json={},
169 |         )
170 |         assert r2.status_code == 429
    |                                  ^^^
    |

INP001 File `tests/test_mcp_endpoints.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_endpoints.py:1:1

UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`
 --> tests/test_mcp_endpoints.py:3:1
  |
1 | import json
2 | from datetime import datetime, timezone
3 | from typing import Awaitable, Callable
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
4 |
5 | import pytest
  |
help: Import from `collections.abc`

UP017 [*] Use `datetime.UTC` alias
  --> tests/test_mcp_endpoints.py:13:24
   |
12 | def _default_date_window() -> tuple[str, str, str]:
13 |     now = datetime.now(timezone.utc)
   |                        ^^^^^^^^^^^^
14 |     month_start = now.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
15 |     date_received_max = month_start.strftime("%Y-%m-%d")
   |
help: Convert to `datetime.UTC` alias

PLR0911 Too many return statements (9 > 6)
  --> tests/test_mcp_endpoints.py:45:5
   |
45 | def _extract_complaint_id_from_search_payload(payload: object) -> int | None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
46 |     if not isinstance(payload, dict):
47 |         return None
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/test_mcp_endpoints.py:69:8
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
70 |         return cid_int
71 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/test_mcp_endpoints.py:69:34
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
70 |         return cid_int
71 |     return None
   |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/test_mcp_endpoints.py:78:5
   |
76 |   ) -> None:
77 |       mcp_url = f"{server_url}/mcp"
78 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
79 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
80 |               await mcp.initialize()
81 |               await action(mcp)
   |
help: Combine `with` statements

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:84:11
   |
84 | async def test_tools_list_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^^^^^
85 |     async def _run(mcp: ClientSession) -> None:
86 |         tools = await mcp.list_tools()
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:88:9
   |
86 |         tools = await mcp.list_tools()
87 |         tool_names = {tool.name for tool in tools.tools}
88 |         assert "search_complaints" in tool_names
   |         ^^^^^^
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:89:9
   |
87 |         tool_names = {tool.name for tool in tools.tools}
88 |         assert "search_complaints" in tool_names
89 |         assert "list_complaint_trends" in tool_names
   |         ^^^^^^
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:90:9
   |
88 |         assert "search_complaints" in tool_names
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
   |         ^^^^^^
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:91:9
   |
89 |         assert "list_complaint_trends" in tool_names
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
   |         ^^^^^^
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:92:9
   |
90 |         assert "get_state_aggregations" in tool_names
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
   |         ^^^^^^
93 |         assert "generate_cfpb_dashboard_url" in tool_names
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:93:9
   |
91 |         assert "suggest_filter_values" in tool_names
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
   |         ^^^^^^
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |

S101 Use of `assert` detected
  --> tests/test_mcp_endpoints.py:94:9
   |
92 |         assert "get_complaint_document" in tool_names
93 |         assert "generate_cfpb_dashboard_url" in tool_names
94 |         assert "capture_cfpb_chart_screenshot" in tool_names
   |         ^^^^^^
95 |
96 |     await _with_mcp(server_url, _run)
   |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:99:11
    |
 99 | async def test_search_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
100 |     async def _run(mcp: ClientSession) -> None:
101 |         result = await mcp.call_tool("search_complaints", {"size": 1})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:103:9
    |
101 |         result = await mcp.call_tool("search_complaints", {"size": 1})
102 |         payload = _tool_payload(result)
103 |         assert isinstance(payload, dict)
    |         ^^^^^^
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:105:9
    |
103 |         assert isinstance(payload, dict)
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
    |         ^^^^^^
106 |         assert "hits" in data
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:106:9
    |
104 |         data = payload.get("data")
105 |         assert isinstance(data, dict)
106 |         assert "hits" in data
    |         ^^^^^^
107 |
108 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:111:11
    |
111 | async def test_trends_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
112 |     async def _run(mcp: ClientSession) -> None:
113 |         result = await mcp.call_tool("list_complaint_trends", {"trend_depth": 5})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:115:9
    |
113 |         result = await mcp.call_tool("list_complaint_trends", {"trend_depth": 5})
114 |         payload = _tool_payload(result)
115 |         assert isinstance(payload, dict)
    |         ^^^^^^
116 |         data = payload.get("data")
117 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:117:9
    |
115 |         assert isinstance(payload, dict)
116 |         data = payload.get("data")
117 |         assert isinstance(data, dict)
    |         ^^^^^^
118 |
119 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:122:11
    |
122 | async def test_geo_states_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^
123 |     async def _run(mcp: ClientSession) -> None:
124 |         result = await mcp.call_tool("get_state_aggregations", {})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:126:9
    |
124 |         result = await mcp.call_tool("get_state_aggregations", {})
125 |         payload = _tool_payload(result)
126 |         assert isinstance(payload, dict)
    |         ^^^^^^
127 |         data = payload.get("data")
128 |         assert isinstance(data, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:128:9
    |
126 |         assert isinstance(payload, dict)
127 |         data = payload.get("data")
128 |         assert isinstance(data, dict)
    |         ^^^^^^
129 |
130 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:134:11
    |
133 | @pytest.mark.parametrize("field", ["company", "zip_code"])
134 | async def test_suggest_smoke(server_url: str, field: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^
135 |     async def _run(mcp: ClientSession) -> None:
136 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:143:9
    |
141 |         if isinstance(payload, str):
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
    |         ^^^^^^
144 |         assert len(payload) <= 3
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:144:9
    |
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
144 |         assert len(payload) <= 3
    |         ^^^^^^
145 |
146 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> tests/test_mcp_endpoints.py:144:32
    |
142 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
143 |         assert isinstance(payload, list)
144 |         assert len(payload) <= 3
    |                                ^
145 |
146 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:149:11
    |
149 | async def test_document_round_trip_from_search(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |     async def _run(mcp: ClientSession) -> None:
151 |         search_result = await mcp.call_tool("search_complaints", {"size": 1})
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:154:9
    |
152 |         payload = _tool_payload(search_result)
153 |         complaint_id = _extract_complaint_id_from_search_payload(payload)
154 |         assert complaint_id is not None, "Expected a complaint id from search results"
    |         ^^^^^^
155 |
156 |         doc_result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:160:9
    |
158 |         )
159 |         doc_payload = _tool_payload(doc_result)
160 |         assert isinstance(doc_payload, dict)
    |         ^^^^^^
161 |
162 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:165:11
    |
165 | async def test_signals_overall_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
166 |     async def _run(mcp: ClientSession) -> None:
167 |         date_min, date_max, current_month_prefix = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:173:9
    |
171 |         )
172 |         payload = _tool_payload(result)
173 |         assert isinstance(payload, dict)
    |         ^^^^^^
174 |         overall = (payload.get("signals") or {}).get("overall")
175 |         assert isinstance(overall, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:175:9
    |
173 |         assert isinstance(payload, dict)
174 |         overall = (payload.get("signals") or {}).get("overall")
175 |         assert isinstance(overall, dict)
    |         ^^^^^^
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:177:9
    |
175 |         assert isinstance(overall, dict)
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
    |         ^^^^^^
178 |         assert not str(last_bucket.get("label", "")).startswith(current_month_prefix)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:178:9
    |
176 |         last_bucket = overall.get("last_bucket")
177 |         assert isinstance(last_bucket, dict)
178 |         assert not str(last_bucket.get("label", "")).startswith(current_month_prefix)
    |         ^^^^^^
179 |
180 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:184:11
    |
183 | @pytest.mark.parametrize("group", ["product", "issue"])
184 | async def test_signals_group_smoke(server_url: str, group: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^
185 |     async def _run(mcp: ClientSession) -> None:
186 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:197:9
    |
195 |         )
196 |         payload = _tool_payload(result)
197 |         assert isinstance(payload, dict)
    |         ^^^^^^
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:199:9
    |
197 |         assert isinstance(payload, dict)
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
    |         ^^^^^^
200 |         assert len(results) <= 5
201 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:200:9
    |
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
200 |         assert len(results) <= 5
    |         ^^^^^^
201 |         if results:
202 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:200:32
    |
198 |         results = payload.get("results")
199 |         assert isinstance(results, list)
200 |         assert len(results) <= 5
    |                                ^
201 |         if results:
202 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:203:13
    |
201 |         if results:
202 |             row0 = results[0]
203 |             assert isinstance(row0, dict)
    |             ^^^^^^
204 |             assert "group" in row0
205 |             assert "signals" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:204:13
    |
202 |             row0 = results[0]
203 |             assert isinstance(row0, dict)
204 |             assert "group" in row0
    |             ^^^^^^
205 |             assert "signals" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:205:13
    |
203 |             assert isinstance(row0, dict)
204 |             assert "group" in row0
205 |             assert "signals" in row0
    |             ^^^^^^
206 |
207 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:210:11
    |
210 | async def test_signals_company_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
211 |     async def _run(mcp: ClientSession) -> None:
212 |         date_min, date_max, _ = _default_date_window()
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:222:9
    |
220 |         )
221 |         payload = _tool_payload(result)
222 |         assert isinstance(payload, dict)
    |         ^^^^^^
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:224:9
    |
222 |         assert isinstance(payload, dict)
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
    |         ^^^^^^
225 |         assert len(results) <= 5
226 |         if results:
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:225:9
    |
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
225 |         assert len(results) <= 5
    |         ^^^^^^
226 |         if results:
227 |             row0 = results[0]
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:225:32
    |
223 |         results = payload.get("results")
224 |         assert isinstance(results, list)
225 |         assert len(results) <= 5
    |                                ^
226 |         if results:
227 |             row0 = results[0]
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:228:13
    |
226 |         if results:
227 |             row0 = results[0]
228 |             assert isinstance(row0, dict)
    |             ^^^^^^
229 |             assert "company" in row0
230 |             assert "computed" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:229:13
    |
227 |             row0 = results[0]
228 |             assert isinstance(row0, dict)
229 |             assert "company" in row0
    |             ^^^^^^
230 |             assert "computed" in row0
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:230:13
    |
228 |             assert isinstance(row0, dict)
229 |             assert "company" in row0
230 |             assert "computed" in row0
    |             ^^^^^^
231 |
232 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:235:11
    |
235 | async def test_generate_cfpb_dashboard_url(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     async def _run(mcp: ClientSession) -> None:
237 |         result = await mcp.call_tool(
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:244:9
    |
242 |         if isinstance(payload, dict) and "result" in payload:
243 |             payload = payload["result"]
244 |         assert isinstance(payload, str)
    |         ^^^^^^
245 |         assert payload.startswith(
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:245:9
    |
243 |             payload = payload["result"]
244 |         assert isinstance(payload, str)
245 |         assert payload.startswith(
    |         ^^^^^^
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
247 |         )
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:248:9
    |
246 |             "https://www.consumerfinance.gov/data-research/consumer-complaints/search/"
247 |         )
248 |         assert "searchText=foreclosure" in payload
    |         ^^^^^^
249 |
250 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:253:11
    |
253 | async def test_capture_cfpb_chart_screenshot(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
254 |     async def _run(mcp: ClientSession) -> None:
255 |         try:
    |

RUF100 [*] Unused `noqa` directive (unused: `BLE001`)
   --> tests/test_mcp_endpoints.py:260:35
    |
258 |                 {"search_term": "mortgage", "product": ["Mortgage"]},
259 |             )
260 |         except Exception as exc:  # noqa: BLE001
    |                                   ^^^^^^^^^^^^^^
261 |             message = str(exc).lower()
262 |             if "playwright" in message or "browser unavailable" in message:
    |
help: Remove unused `noqa` directive

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:269:9
    |
267 |         if isinstance(payload, dict) and "result" in payload:
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
    |         ^^^^^^
270 |         assert len(payload) > 1000
    |

S101 Use of `assert` detected
   --> tests/test_mcp_endpoints.py:270:9
    |
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
270 |         assert len(payload) > 1000
    |         ^^^^^^
271 |
272 |     await _with_mcp(server_url, _run)
    |

PLR2004 Magic value used in comparison, consider replacing `1000` with a constant variable
   --> tests/test_mcp_endpoints.py:270:31
    |
268 |             payload = payload["result"]
269 |         assert isinstance(payload, str)
270 |         assert len(payload) > 1000
    |                               ^^^^
271 |
272 |     await _with_mcp(server_url, _run)
    |

INP001 File `tests/transport/http/test_http_transport.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/transport/http/test_http_transport.py:1:1

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/transport/http/test_http_transport.py:12:5
   |
10 |       """Verify that the Streamable HTTP endpoint (POST /mcp) works."""
11 |       url = f"{server_url}/mcp"
12 | /     async with streamable_http_client(url) as (read_stream, write_stream, _):
13 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
14 |               await mcp.initialize()
15 |               tools = await mcp.list_tools()
   |
help: Combine `with` statements

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:17:13
   |
15 |             tools = await mcp.list_tools()
16 |             tool_names = {tool.name for tool in tools.tools}
17 |             assert "search_complaints" in tool_names
   |             ^^^^^^
   |

S101 Use of `assert` detected
  --> tests/transport/http/test_http_transport.py:25:9
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |         ^^^^^^
   |

PLR2004 Magic value used in comparison, consider replacing `405` with a constant variable
  --> tests/transport/http/test_http_transport.py:25:40
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |                                        ^^^
   |

INP001 File `tests/unit/test_params.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/unit/test_params.py:1:1

D103 Missing docstring in public function
 --> tests/unit/test_params.py:6:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |     assert prune_params({"a": None, "b": "", "c": "  ", "d": "ok"}) == {"d": "ok"}
  |

S101 Use of `assert` detected
 --> tests/unit/test_params.py:7:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
7 |     assert prune_params({"a": None, "b": "", "c": "  ", "d": "ok"}) == {"d": "ok"}
  |     ^^^^^^
  |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:10:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     assert prune_params(
12 |         {"a": [], "b": [""], "c": [" ", None], "d": ["x", "", "y"]}
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:11:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
11 |     assert prune_params(
   |     ^^^^^^
12 |         {"a": [], "b": [""], "c": [" ", None], "d": ["x", "", "y"]}
13 |     ) == {"d": ["x", "y"]}
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:16:5
   |
16 | def test_prune_params_keeps_non_string_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
17 |     assert prune_params({"a": 0, "b": False, "c": True, "d": 3.14}) == {
18 |         "a": 0,
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:17:5
   |
16 | def test_prune_params_keeps_non_string_values() -> None:
17 |     assert prune_params({"a": 0, "b": False, "c": True, "d": 3.14}) == {
   |     ^^^^^^
18 |         "a": 0,
19 |         "b": "false",
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:25:5
   |
25 | def test_prune_params_normalizes_boolean_like_strings() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
26 |     assert prune_params({"a": "True", "b": "false", "c": ["FALSE", "ok"]}) == {
27 |         "a": "true",
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:26:5
   |
25 | def test_prune_params_normalizes_boolean_like_strings() -> None:
26 |     assert prune_params({"a": "True", "b": "false", "c": ["FALSE", "ok"]}) == {
   |     ^^^^^^
27 |         "a": "true",
28 |         "b": "false",
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:33:5
   |
33 | def test_build_params_filters_empty_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
34 |     params = build_params(
35 |         search_term="",
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:44:5
   |
43 |     # build_params returns already-pruned params
44 |     assert "search_term" not in params
   |     ^^^^^^
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:45:5
   |
43 |     # build_params returns already-pruned params
44 |     assert "search_term" not in params
45 |     assert "field" not in params
   |     ^^^^^^
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:46:5
   |
44 |     assert "search_term" not in params
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
   |     ^^^^^^
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:47:5
   |
45 |     assert "field" not in params
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
   |     ^^^^^^
48 |     assert "state" not in params
49 |     assert "tags" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:48:5
   |
46 |     assert params["company"] == ["Acme Bank"]
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
   |     ^^^^^^
49 |     assert "tags" not in params
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:49:5
   |
47 |     assert params["issue"] == ["Fees"]
48 |     assert "state" not in params
49 |     assert "tags" not in params
   |     ^^^^^^
   |

PT006 Wrong type passed to first argument of `pytest.mark.parametrize`; expected `tuple`
  --> tests/unit/test_params.py:53:5
   |
52 | @pytest.mark.parametrize(
53 |     "raw,expected",
   |     ^^^^^^^^^^^^^^
54 |     [
55 |         ({"x": "y"}, {"x": "y"}),
   |
help: Use a `tuple` for the first argument

D103 Missing docstring in public function
  --> tests/unit/test_params.py:60:5
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^
61 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `raw`
  --> tests/unit/test_params.py:60:29
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |                             ^^^
61 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `expected`
  --> tests/unit/test_params.py:60:34
   |
58 |     ],
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
   |                                  ^^^^^^^^
61 |     assert prune_params(raw) == expected
   |

S101 Use of `assert` detected
  --> tests/unit/test_params.py:61:5
   |
59 | )
60 | def test_prune_params_smoke(raw, expected) -> None:
61 |     assert prune_params(raw) == expected
   |     ^^^^^^
   |

I001 [*] Import block is un-sorted or un-formatted
 --> utils/deeplink_mapping.py:1:1
  |
1 | / from __future__ import annotations
2 | |
3 | | import re
4 | | from datetime import date, timedelta
5 | | from dataclasses import dataclass
6 | | from typing import Any, Dict, Iterable, Mapping, Optional
7 | | from urllib.parse import parse_qs, urlencode, urlparse
  | |______________________________________________________^
8 |
9 |   UI_BASE_URL = (
  |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Iterable`, `Mapping`
 --> utils/deeplink_mapping.py:6:1
  |
4 | from datetime import date, timedelta
5 | from dataclasses import dataclass
6 | from typing import Any, Dict, Iterable, Mapping, Optional
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 | from urllib.parse import parse_qs, urlencode, urlparse
  |
help: Import from `collections.abc`

UP035 `typing.Dict` is deprecated, use `dict` instead
 --> utils/deeplink_mapping.py:6:1
  |
4 | from datetime import date, timedelta
5 | from dataclasses import dataclass
6 | from typing import Any, Dict, Iterable, Mapping, Optional
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 | from urllib.parse import parse_qs, urlencode, urlparse
  |

D101 Missing docstring in public class
   --> utils/deeplink_mapping.py:120:7
    |
119 | @dataclass(frozen=True)
120 | class ValidationResult:
    |       ^^^^^^^^^^^^^^^^
121 |     unknown_keys: tuple[str, ...]
122 |     allowed_keys: tuple[str, ...]
    |

PLR0911 Too many return statements (8 > 6)
   --> utils/deeplink_mapping.py:125:5
    |
125 | def _clean_value(value: Any) -> Optional[Any]:
    |     ^^^^^^^^^^^^
126 |     if value is None:
127 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:125:25
    |
125 | def _clean_value(value: Any) -> Optional[Any]:
    |                         ^^^
126 |     if value is None:
127 |         return None
    |

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:125:33
    |
125 | def _clean_value(value: Any) -> Optional[Any]:
    |                                 ^^^^^^^^^^^^^
126 |     if value is None:
127 |         return None
    |
help: Convert to `X | None`

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `_clean_value`
   --> utils/deeplink_mapping.py:125:33
    |
125 | def _clean_value(value: Any) -> Optional[Any]:
    |                                 ^^^^^^^^^^^^^
126 |     if value is None:
127 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:151:23
    |
151 | def _parse_int(value: Any) -> Optional[int]:
    |                       ^^^
152 |     if value is None:
153 |         return None
    |

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:151:31
    |
151 | def _parse_int(value: Any) -> Optional[int]:
    |                               ^^^^^^^^^^^^^
152 |     if value is None:
153 |         return None
    |
help: Convert to `X | None`

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:176:5
    |
176 | def normalize_api_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^
177 |     normalized: Dict[str, Any] = {}
178 |     for key, raw_value in api_params.items():
    |

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:176:60
    |
176 | def normalize_api_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
    |                                                            ^^^^
177 |     normalized: Dict[str, Any] = {}
178 |     for key, raw_value in api_params.items():
    |
help: Replace with `dict`

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:177:17
    |
176 | def normalize_api_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
177 |     normalized: Dict[str, Any] = {}
    |                 ^^^^
178 |     for key, raw_value in api_params.items():
179 |         cleaned_value = _clean_value(raw_value)
    |
help: Replace with `dict`

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:190:30
    |
190 | def _default_end_date(today: Optional[date] = None) -> str:
    |                              ^^^^^^^^^^^^^^
191 |     """Return the last day of the month before (today - 30 days)."""
192 |     anchor = today or date.today()
    |
help: Convert to `X | None`

DTZ011 `datetime.date.today()` used
   --> utils/deeplink_mapping.py:192:23
    |
190 | def _default_end_date(today: Optional[date] = None) -> str:
191 |     """Return the last day of the month before (today - 30 days)."""
192 |     anchor = today or date.today()
    |                       ^^^^^^^^^^^^
193 |     cutoff = anchor - timedelta(days=30)
194 |     first_of_cutoff_month = cutoff.replace(day=1)
    |
help: Use `datetime.datetime.now(tz=...).date()` instead

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:200:43
    |
199 | def apply_default_dates(
200 |     api_params: Mapping[str, Any], today: Optional[date] = None
    |                                           ^^^^^^^^^^^^^^
201 | ) -> Dict[str, Any]:
202 |     """Return a copy of params with explicit date_received_min/max defaults."""
    |
help: Convert to `X | None`

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:201:6
    |
199 | def apply_default_dates(
200 |     api_params: Mapping[str, Any], today: Optional[date] = None
201 | ) -> Dict[str, Any]:
    |      ^^^^
202 |     """Return a copy of params with explicit date_received_min/max defaults."""
203 |     params_with_dates = dict(api_params)
    |
help: Replace with `dict`

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:219:5
    |
219 | def validate_api_params(
    |     ^^^^^^^^^^^^^^^^^^^
220 |     api_params: Mapping[str, Any], allowed_keys: Iterable[str]
221 | ) -> ValidationResult:
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:227:5
    |
227 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
228 |     url_params: Dict[str, Any] = {}
229 |     normalized = normalize_api_params(api_params)
    |

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:227:64
    |
227 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
    |                                                                ^^^^
228 |     url_params: Dict[str, Any] = {}
229 |     normalized = normalize_api_params(api_params)
    |
help: Replace with `dict`

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:228:17
    |
227 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> Dict[str, Any]:
228 |     url_params: Dict[str, Any] = {}
    |                 ^^^^
229 |     normalized = normalize_api_params(api_params)
    |
help: Replace with `dict`

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:246:66
    |
246 | def _apply_pagination(api_params: Mapping[str, Any], url_params: Dict[str, Any]) -> None:
    |                                                                  ^^^^
247 |     frm = _parse_int(api_params.get("frm"))
248 |     size = _parse_int(api_params.get("size"))
    |
help: Replace with `dict`

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:254:5
    |
254 | def build_deeplink_url(
    |     ^^^^^^^^^^^^^^^^^^
255 |     api_params: Mapping[str, Any],
256 |     *,
    |

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:257:10
    |
255 |     api_params: Mapping[str, Any],
256 |     *,
257 |     tab: Optional[str] = None,
    |          ^^^^^^^^^^^^^
258 |     today: Optional[date] = None,
259 | ) -> str:
    |
help: Convert to `X | None`

UP045 [*] Use `X | None` for type annotations
   --> utils/deeplink_mapping.py:258:12
    |
256 |     *,
257 |     tab: Optional[str] = None,
258 |     today: Optional[date] = None,
    |            ^^^^^^^^^^^^^^
259 | ) -> str:
260 |     params_with_dates = apply_default_dates(api_params, today=today)
    |
help: Convert to `X | None`

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:274:5
    |
274 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> Dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
275 |     api_params: Dict[str, Any] = {}
276 |     for key, raw_value in url_params.items():
    |

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:274:64
    |
274 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> Dict[str, Any]:
    |                                                                ^^^^
275 |     api_params: Dict[str, Any] = {}
276 |     for key, raw_value in url_params.items():
    |
help: Replace with `dict`

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:275:17
    |
274 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> Dict[str, Any]:
275 |     api_params: Dict[str, Any] = {}
    |                 ^^^^
276 |     for key, raw_value in url_params.items():
277 |         api_key = URL_TO_API_PARAM.get(key, key)
    |
help: Replace with `dict`

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:298:5
    |
298 | def url_to_api_params(url: str) -> Dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^
299 |     parsed = urlparse(url)
300 |     query = parse_qs(parsed.query)
    |

UP006 [*] Use `dict` instead of `Dict` for type annotation
   --> utils/deeplink_mapping.py:298:36
    |
298 | def url_to_api_params(url: str) -> Dict[str, Any]:
    |                                    ^^^^
299 |     parsed = urlparse(url)
300 |     query = parse_qs(parsed.query)
    |
help: Replace with `dict`

Found 314 errors.
[*] 42 fixable with the `--fix` option (23 hidden fixes can be enabled with the `--unsafe-fixes` option).

=== pyright (pylance engine) ===
cmd: /Users/jim/cfpb-mcp/.venv/bin/python -m pyright
exit_code: 1
--- stderr ---
/Users/jim/cfpb-mcp/.venv/bin/python: No module named pyright
--- stdout ---
(no output)

