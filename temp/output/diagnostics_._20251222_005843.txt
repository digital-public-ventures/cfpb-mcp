timestamp_utc: 2025-12-22T00:58:43.312155+00:00
python: /Users/jim/cfpb-mcp/.venv/bin/python3
target: /Users/jim/cfpb-mcp

=== ruff check --fix ===
cmd: ruff check --fix /Users/jim/cfpb-mcp
exit_code: 1
--- stdout ---
ANN201 Missing return type annotation for public function `map_api_params_to_url_params`
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |
help: Add return type annotation

D103 Missing docstring in public function
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN001 Missing type annotation for function argument `api_params`
  --> citations_mapping.py:14:34
   |
14 | def map_api_params_to_url_params(api_params):
   |                                  ^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN201 Missing return type annotation for public function `demo_url_generation`
  --> scripts/demo_cfpb_ui.py:10:5
   |
10 | def demo_url_generation():
   |     ^^^^^^^^^^^^^^^^^^^
11 |     """Demonstrate URL generation for the official CFPB dashboard."""
12 |     print('=' * 70)
   |
help: Add return type annotation: `None`

INP001 File `scripts/run_tests.py` is part of an implicit namespace package. Add an `__init__.py`.
--> scripts/run_tests.py:1:1

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:17
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:33
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH100 `os.path.abspath()` should be replaced by `Path.resolve()`
  --> scripts/run_tests.py:21:49
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).resolve()`

PLR0911 Too many return statements (7 > 6)
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

D103 Missing docstring in public function
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:56:24
   |
55 |     if ns.suite == 'unit':
56 |         return _pytest(default_args + ['-m', 'unit'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
57 |
58 |     if ns.suite == 'integration':
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:60:24
   |
58 |     if ns.suite == 'integration':
59 |         # Includes anything under tests/ except slow/unit/contract.
60 |         return _pytest(default_args + ['-m', 'integration'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |     if ns.suite == 'slow':
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:63:24
   |
62 |     if ns.suite == 'slow':
63 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |
65 |     if ns.suite == 'contract':
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'contract', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:66:24
   |
65 |     if ns.suite == 'contract':
66 |         return _pytest(default_args + ['-m', 'contract', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     if ns.suite == 'full':
   |
help: Replace with `[*default_args, '-m', 'contract', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:70:22
   |
68 |     if ns.suite == 'full':
69 |         # Run unit, then integration, then slow.
70 |         rc = _pytest(default_args + ['-m', 'unit'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
71 |         if rc != 0:
72 |             return rc
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:74:22
   |
72 |             return rc
73 |
74 |         rc = _pytest(default_args + ['-m', 'integration'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
75 |         if rc != 0:
76 |             return rc
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:77:24
   |
75 |         if rc != 0:
76 |             return rc
77 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |
79 |     _die(f'Unknown suite: {ns.suite}')
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

INP001 File `tests/conftest.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/conftest.py:1:1

ARG001 Unused function argument: `config`
  --> tests/conftest.py:15:35
   |
15 | def pytest_collection_modifyitems(config: pytest.Config, items: list[pytest.Item]) -> None:
   |                                   ^^^^^^
16 |     """Apply suite markers based on file path.
   |

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/conftest.py:46:29
   |
44 |     try:
45 |         r = httpx.get(f'{url}/', timeout=5)
46 |         if r.status_code != 200:
   |                             ^^^
47 |             return False
48 |         payload = r.json()
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:57:15
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:57:26
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:59:15
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:59:26
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:84:23
   |
82 |               host, port = _parse_host_port(url)
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
   |  _______________________^
85 | |                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
87 | |                 )
   | |_________________^
88 |       else:
89 |           port = _pick_free_port()
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:85:21
   |
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
85 | /                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
   | |_____________________________________________________^
87 |                   )
88 |       else:
   |
help: Assign to variable; remove f-string literal

SIM115 Use a context manager for opening files
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |
help: Replace with `Path.open()`

S603 `subprocess` call: check for execution of untrusted input
   --> tests/conftest.py:105:12
    |
103 |     log_file = open('server_test.log', 'w')
104 |
105 |     proc = subprocess.Popen(
    |            ^^^^^^^^^^^^^^^^
106 |         [
107 |             sys.executable,
    |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:13
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:29
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |                             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:141:18
    |
139 |             # If it failed, read the log file
140 |             log_file.close()
141 |             with open('server_test.log') as f:
    |                  ^^^^
142 |                 output = f.read()
143 |             raise RuntimeError(
    |
help: Replace with `Path.open()`

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:143:19
    |
141 |               with open('server_test.log') as f:
142 |                   output = f.read()
143 |               raise RuntimeError(
    |  ___________________^
144 | |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
145 | |             )
    | |_____________^
146 |
147 |           # Final readiness check
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:144:17
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
145 |             )
    |
help: Assign to variable; remove f-string literal

E501 Line too long (122 > 120)
   --> tests/conftest.py:144:121
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                                                                                                                         ^^
145 |             )
    |

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:149:19
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:149:32
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
   --> tests/conftest.py:168:5
    |
167 | @pytest.fixture
168 | def client(server_url: str) -> Iterator[httpx.Client]:
    |     ^^^^^^
169 |     with httpx.Client(base_url=server_url, timeout=30) as c:
170 |         yield c
    |

INP001 File `tests/contract/test_anthropic_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_anthropic_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_anthropic_mcp_contract.py:23:16
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_anthropic_mcp_contract.py:23:29
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_anthropic_mcp_contract.py:24:12
   |
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
24 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
25 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_anthropic_mcp_contract.py:28:14
   |
27 |     try:
28 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
29 |             for raw_line in f:
30 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

ANN001 Missing type annotation for function argument `blocks`
  --> tests/contract/test_anthropic_mcp_contract.py:43:19
   |
43 | def _extract_text(blocks) -> str:
   |                   ^^^^^^
44 |     if not isinstance(blocks, list):
45 |         return str(blocks or '')
   |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `payload`
  --> tests/contract/test_anthropic_mcp_contract.py:53:32
   |
53 | def _tool_result_text(payload: Any) -> str:
   |                                ^^^
54 |     if payload is None:
55 |         return ''
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:12
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |            ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:31
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |                               ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:8
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |        ^
121 |         return cid_int
122 |     return None
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:34
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |                                  ^
121 |         return cid_int
122 |     return None
    |

D103 Missing docstring in public function
   --> tests/contract/test_anthropic_mcp_contract.py:128:11
    |
126 | @pytest.mark.fast
127 | @pytest.mark.anyio
128 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:143:121
    |
141 |     user_prompt = (
142 |         "I'm researching CFPB consumer complaints about loan forbearance. "
143 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
144 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
145 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_anthropic_mcp_contract.py:153:5
    |
152 |       # Connect using Streamable HTTP client
153 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
154 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
155 |               await mcp.initialize()
156 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

ERA001 Found commented-out code
   --> tests/contract/test_anthropic_mcp_contract.py:184:17
    |
182 |                 messages.append(cast('MessageParam', {'role': 'assistant', 'content': resp.content}))
183 |
184 |                 # tool_uses = [c for c in resp.content if getattr(c, "type", None) == "tool_use"]
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
185 |                 tool_uses: list[ToolUseBlock] = [c for c in resp.content if isinstance(c, ToolUseBlock)]
    |
help: Remove commented-out code

E501 Line too long (161 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:197:121
    |
195 | …
196 | …
197 | … now (complaint id, company, state if present, and a 2-3 sentence grounded summary).',
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
198 | …
199 | …
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:20
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
244 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:62
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
244 |             assert str(complaint_id_from_tools) in text
    |

INP001 File `tests/contract/test_openai_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_openai_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_openai_mcp_contract.py:17:16
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_openai_mcp_contract.py:17:29
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_openai_mcp_contract.py:18:12
   |
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
18 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
19 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_openai_mcp_contract.py:22:14
   |
21 |     try:
22 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
23 |             for raw_line in f:
24 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:12
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |            ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:31
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |                               ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:8
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
88 |         return cid_int
89 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:34
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
88 |         return cid_int
89 |     return None
   |

D103 Missing docstring in public function
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_openai_mcp_contract.py:139:121
    |
137 |     prompt = (
138 |         "I'm researching CFPB consumer complaints about loan forbearance. "
139 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
140 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
141 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_openai_mcp_contract.py:149:5
    |
147 |       tool_calls_seen = False
148 |
149 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
150 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
151 |               await mcp.initialize()
152 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:20
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:62
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

INP001 File `tests/playwright_helpers.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/playwright_helpers.py:1:1

ANN201 Missing return type annotation for public function `fast_playwright_context`
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |
help: Add return type annotation

D103 Missing docstring in public function
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |

PLC0415 `import` should be at the top-level of a file
  --> tests/playwright_helpers.py:9:9
   |
 7 | async def fast_playwright_context():
 8 |     try:
 9 |         from playwright.async_api import async_playwright
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/playwright_helpers.py:11:15
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/playwright_helpers.py:11:28
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |
help: Assign to variable; remove f-string literal

ANN202 Missing return type annotation for private function `_block_heavy_assets`
  --> tests/playwright_helpers.py:17:19
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                   ^^^^^^^^^^^^^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |
help: Add return type annotation: `None`

ANN001 Missing type annotation for function argument `route`
  --> tests/playwright_helpers.py:17:39
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                       ^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

ANN001 Missing type annotation for function argument `request`
  --> tests/playwright_helpers.py:17:46
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                              ^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

INP001 File `tests/test_citations.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_citations.py:1:1

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> tests/test_citations.py:5:29
  |
3 | import asyncio
4 | import re
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from datetime import date
7 | from typing import Any
  |
help: Move into type-checking block

TRY003 Avoid specifying long messages outside the exception class
   --> tests/test_citations.py:133:11
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |

EM101 Exception must not use a string literal, assign to variable first
   --> tests/test_citations.py:133:22
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
help: Assign to variable; remove string literal

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
   --> tests/test_citations.py:138:32
    |
136 | async def _fetch_api_total(client: httpx.AsyncClient, api_params: Mapping[str, Any]) -> int:
137 |     response = await client.get(BASE_URL, params=api_params)
138 |     if response.status_code != 200:
    |                                ^^^
139 |         pytest.fail(f'API call failed: {response.url} ({response.status_code})')
    |

D103 Missing docstring in public function
   --> tests/test_citations.py:153:11
    |
152 | @pytest.fixture(scope='module')
153 | async def api_client() -> httpx.AsyncClient:
    |           ^^^^^^^^^^
154 |     async with httpx.AsyncClient(timeout=20.0) as client:
155 |         yield client
    |

ANN201 Missing return type annotation for public function `ui_context`
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |
help: Add return type annotation

D103 Missing docstring in public function
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |

ANN201 Missing return type annotation for public function `test_map_api_params_to_url_params_examples`
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |

PLR2004 Magic value used in comparison, consider replacing `25` with a constant variable
   --> tests/test_citations.py:179:30
    |
177 |     assert mapped['searchText'] == 'mortgage'
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
    |                              ^^
180 |     assert mapped['sort'] == 'created_date_desc'
    |

ANN201 Missing return type annotation for public function `test_trend_mapping_defaults`
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |

ANN201 Missing return type annotation for public function `test_default_date_window`
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |

ANN201 Missing return type annotation for public function `test_ui_vs_api_counts`
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_params`
   --> tests/test_citations.py:227:33
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                 ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_client`
   --> tests/test_citations.py:227:45
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                             ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `ui_context`
   --> tests/test_citations.py:227:57
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                                         ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

SIM105 Use `contextlib.suppress(Exception)` instead of `try`-`except`-`pass`
   --> tests/test_citations.py:235:9
    |
233 |       try:
234 |           await page.goto(url, wait_until='domcontentloaded', timeout=60000)
235 | /         try:
236 | |             await page.wait_for_function(
237 | |                 'document.body && /matches out of/i.test(document.body.innerText)',
238 | |                 timeout=20000,
239 | |             )
240 | |         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(Exception): ...`

S110 `try`-`except`-`pass` detected, consider logging the exception
   --> tests/test_citations.py:240:9
    |
238 |                   timeout=20000,
239 |               )
240 | /         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |

BLE001 Do not catch blind exception: `Exception`
   --> tests/test_citations.py:240:16
    |
238 |                 timeout=20000,
239 |             )
240 |         except Exception:
    |                ^^^^^^^^^
241 |             pass
242 |         ui_text = await page.inner_text('body')
    |

INP001 File `tests/test_mcp_auth.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_auth.py:1:1

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/test_mcp_auth.py:30:29
   |
28 |     try:
29 |         r = httpx.get(f'{url}/', timeout=5)
30 |         if r.status_code != 200:
   |                             ^^^
31 |             return False
32 |         payload = r.json()
   |

S603 `subprocess` call: check for execution of untrusted input
  --> tests/test_mcp_auth.py:47:35
   |
45 |     env.update(env_overrides)
46 |
47 |     proc: subprocess.Popen[str] = subprocess.Popen(
   |                                   ^^^^^^^^^^^^^^^^
48 |         [
49 |             sys.executable,
   |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:13
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:29
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |                             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

TRY301 Abstract `raise` to an inner function
  --> tests/test_mcp_auth.py:79:9
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/test_mcp_auth.py:79:15
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/test_mcp_auth.py:79:28
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
  --> tests/test_mcp_auth.py:92:5
   |
91 | @pytest.fixture(scope='module')
92 | def auth_server_url() -> Iterator[str]:
   |     ^^^^^^^^^^^^^^^
93 |     key = _dev_testing_api_key()
94 |     proc, url = _start_server(env_overrides={'CFPB_MCP_API_KEYS': key})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:108:5
    |
107 | @pytest.fixture(scope='module')
108 | def rate_limited_auth_server_url() -> Iterator[str]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
109 |     key = _dev_testing_api_key()
110 |     proc, url = _start_server(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:129:5
    |
129 | def test_mcp_http_requires_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:132:33
    |
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
132 |         assert r.status_code == 401
    |                                 ^^^
133 |         assert (r.headers.get('content-type') or '').startswith('application/json')
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:136:5
    |
136 | def test_mcp_http_allows_valid_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
137 |     key = _dev_testing_api_key()
138 |     with httpx.Client(timeout=5) as client:
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:147:33
    |
145 |             json={'jsonrpc': '2.0', 'id': 1, 'method': 'tools/list'},
146 |         )
147 |         assert r.status_code != 401
    |                                 ^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:150:5
    |
150 | def test_mcp_rate_limit_429(rate_limited_auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
151 |     key = _dev_testing_api_key()
152 |     with httpx.Client(timeout=5) as client:
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:158:34
    |
156 |             json={},
157 |         )
158 |         assert r1.status_code != 401
    |                                  ^^^
159 |         assert r1.status_code != 429
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:159:34
    |
157 |         )
158 |         assert r1.status_code != 401
159 |         assert r1.status_code != 429
    |                                  ^^^
160 |
161 |         r2 = client.post(
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:166:34
    |
164 |             json={},
165 |         )
166 |         assert r2.status_code == 429
    |                                  ^^^
    |

INP001 File `tests/test_mcp_endpoints.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_endpoints.py:1:1

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/test_mcp_endpoints.py:69:8
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
70 |         return cid_int
71 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/test_mcp_endpoints.py:69:34
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
70 |         return cid_int
71 |     return None
   |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/test_mcp_endpoints.py:76:5
   |
74 |   async def _with_mcp(server_url: str, action: Callable[[ClientSession], Awaitable[None]]) -> None:
75 |       mcp_url = f'{server_url}/mcp'
76 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
77 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
78 |               await mcp.initialize()
79 |               await action(mcp)
   |
help: Combine `with` statements

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:82:11
   |
82 | async def test_tools_list_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^^^^^
83 |     async def _run(mcp: ClientSession) -> None:
84 |         tools = await mcp.list_tools()
   |

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:97:11
   |
97 | async def test_search_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^
98 |     async def _run(mcp: ClientSession) -> None:
99 |         result = await mcp.call_tool('search_complaints', {'size': 1})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:109:11
    |
109 | async def test_trends_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
110 |     async def _run(mcp: ClientSession) -> None:
111 |         result = await mcp.call_tool('list_complaint_trends', {'trend_depth': 5})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:120:11
    |
120 | async def test_geo_states_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^
121 |     async def _run(mcp: ClientSession) -> None:
122 |         result = await mcp.call_tool('get_state_aggregations', {})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:132:11
    |
131 | @pytest.mark.parametrize('field', ['company', 'zip_code'])
132 | async def test_suggest_smoke(server_url: str, field: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^
133 |     async def _run(mcp: ClientSession) -> None:
134 |         result = await mcp.call_tool(
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> tests/test_mcp_endpoints.py:142:32
    |
140 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
141 |         assert isinstance(payload, list)
142 |         assert len(payload) <= 3
    |                                ^
143 |
144 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:147:11
    |
147 | async def test_document_round_trip_from_search(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
148 |     async def _run(mcp: ClientSession) -> None:
149 |         search_result = await mcp.call_tool('search_complaints', {'size': 1})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:161:11
    |
161 | async def test_signals_overall_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
162 |     async def _run(mcp: ClientSession) -> None:
163 |         date_min, date_max, current_month_prefix = _default_date_window()
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:180:11
    |
179 | @pytest.mark.parametrize('group', ['product', 'issue'])
180 | async def test_signals_group_smoke(server_url: str, group: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^
181 |     async def _run(mcp: ClientSession) -> None:
182 |         date_min, date_max, _ = _default_date_window()
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:196:32
    |
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
196 |         assert len(results) <= 5
    |                                ^
197 |         if results:
198 |             row0 = results[0]
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:206:11
    |
206 | async def test_signals_company_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
207 |     async def _run(mcp: ClientSession) -> None:
208 |         date_min, date_max, _ = _default_date_window()
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:221:32
    |
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
221 |         assert len(results) <= 5
    |                                ^
222 |         if results:
223 |             row0 = results[0]
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:231:11
    |
231 | async def test_generate_cfpb_dashboard_url(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
232 |     async def _run(mcp: ClientSession) -> None:
233 |         result = await mcp.call_tool(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:247:11
    |
247 | async def test_capture_cfpb_chart_screenshot(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
248 |     async def _run(mcp: ClientSession) -> None:
249 |         try:
    |

PLR2004 Magic value used in comparison, consider replacing `1000` with a constant variable
   --> tests/test_mcp_endpoints.py:264:31
    |
262 |             payload = payload['result']
263 |         assert isinstance(payload, str)
264 |         assert len(payload) > 1000
    |                               ^^^^
265 |
266 |     await _with_mcp(server_url, _run)
    |

INP001 File `tests/transport/http/test_http_transport.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/transport/http/test_http_transport.py:1:1

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/transport/http/test_http_transport.py:12:5
   |
10 |       """Verify that the Streamable HTTP endpoint (POST /mcp) works."""
11 |       url = f'{server_url}/mcp'
12 | /     async with streamable_http_client(url) as (read_stream, write_stream, _):
13 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
14 |               await mcp.initialize()
15 |               tools = await mcp.list_tools()
   |
help: Combine `with` statements

PLR2004 Magic value used in comparison, consider replacing `405` with a constant variable
  --> tests/transport/http/test_http_transport.py:25:40
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |                                        ^^^
   |

INP001 File `tests/unit/test_params.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/unit/test_params.py:1:1

D103 Missing docstring in public function
 --> tests/unit/test_params.py:6:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |     assert prune_params({'a': None, 'b': '', 'c': '  ', 'd': 'ok'}) == {'d': 'ok'}
  |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:10:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     assert prune_params({'a': [], 'b': [''], 'c': [' ', None], 'd': ['x', '', 'y']}) == {'d': ['x', 'y']}
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:14:5
   |
14 | def test_prune_params_keeps_non_string_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     assert prune_params({'a': 0, 'b': False, 'c': True, 'd': 3.14}) == {
16 |         'a': 0,
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:23:5
   |
23 | def test_prune_params_normalizes_boolean_like_strings() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
24 |     assert prune_params({'a': 'True', 'b': 'false', 'c': ['FALSE', 'ok']}) == {
25 |         'a': 'true',
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:31:5
   |
31 | def test_build_params_filters_empty_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
32 |     params = build_params(
33 |         search_term='',
   |

PT006 Wrong type passed to first argument of `pytest.mark.parametrize`; expected `tuple`
  --> tests/unit/test_params.py:51:5
   |
50 | @pytest.mark.parametrize(
51 |     'raw,expected',
   |     ^^^^^^^^^^^^^^
52 |     [
53 |         ({'x': 'y'}, {'x': 'y'}),
   |
help: Use a `tuple` for the first argument

D103 Missing docstring in public function
  --> tests/unit/test_params.py:58:5
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `raw`
  --> tests/unit/test_params.py:58:29
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                             ^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `expected`
  --> tests/unit/test_params.py:58:34
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                                  ^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> utils/deeplink_mapping.py:4:29
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                             ^^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> utils/deeplink_mapping.py:4:39
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                                       ^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

D101 Missing docstring in public class
   --> utils/deeplink_mapping.py:119:7
    |
118 | @dataclass(frozen=True)
119 | class ValidationResult:
    |       ^^^^^^^^^^^^^^^^
120 |     unknown_keys: tuple[str, ...]
121 |     allowed_keys: tuple[str, ...]
    |

PLR0911 Too many return statements (8 > 6)
   --> utils/deeplink_mapping.py:124:5
    |
124 | def _clean_value(value: Any) -> Any | None:
    |     ^^^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:124:25
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                         ^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `_clean_value`
   --> utils/deeplink_mapping.py:124:33
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                                 ^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:150:23
    |
150 | def _parse_int(value: Any) -> int | None:
    |                       ^^^
151 |     if value is None:
152 |         return None
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:175:5
    |
175 | def normalize_api_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^
176 |     normalized: dict[str, Any] = {}
177 |     for key, raw_value in api_params.items():
    |

DTZ011 `datetime.date.today()` used
   --> utils/deeplink_mapping.py:191:23
    |
189 | def _default_end_date(today: date | None = None) -> str:
190 |     """Return the last day of the month before (today - 30 days)."""
191 |     anchor = today or date.today()
    |                       ^^^^^^^^^^^^
192 |     cutoff = anchor - timedelta(days=30)
193 |     first_of_cutoff_month = cutoff.replace(day=1)
    |
help: Use `datetime.datetime.now(tz=...).date()` instead

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:210:5
    |
210 | def validate_api_params(api_params: Mapping[str, Any], allowed_keys: Iterable[str]) -> ValidationResult:
    |     ^^^^^^^^^^^^^^^^^^^
211 |     allowed = set(allowed_keys)
212 |     unknown = tuple(sorted(key for key in api_params if key not in allowed))
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:216:5
    |
216 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
217 |     url_params: dict[str, Any] = {}
218 |     normalized = normalize_api_params(api_params)
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:243:5
    |
243 | def build_deeplink_url(
    |     ^^^^^^^^^^^^^^^^^^
244 |     api_params: Mapping[str, Any],
245 |     *,
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:263:5
    |
263 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
264 |     api_params: dict[str, Any] = {}
265 |     for key, raw_value in url_params.items():
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:287:5
    |
287 | def url_to_api_params(url: str) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^
288 |     parsed = urlparse(url)
289 |     query = parse_qs(parsed.query)
    |

Found 166 errors.
No fixes available (26 hidden fixes can be enabled with the `--unsafe-fixes` option).

=== ruff format ===
cmd: ruff format /Users/jim/cfpb-mcp
exit_code: 0
--- stdout ---
16 files left unchanged

=== ruff check ===
cmd: ruff check /Users/jim/cfpb-mcp
exit_code: 1
--- stdout ---
ANN201 Missing return type annotation for public function `map_api_params_to_url_params`
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |
help: Add return type annotation

D103 Missing docstring in public function
  --> citations_mapping.py:14:5
   |
14 | def map_api_params_to_url_params(api_params):
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN001 Missing type annotation for function argument `api_params`
  --> citations_mapping.py:14:34
   |
14 | def map_api_params_to_url_params(api_params):
   |                                  ^^^^^^^^^^
15 |     return api_params_to_url_params(api_params)
   |

ANN201 Missing return type annotation for public function `demo_url_generation`
  --> scripts/demo_cfpb_ui.py:10:5
   |
10 | def demo_url_generation():
   |     ^^^^^^^^^^^^^^^^^^^
11 |     """Demonstrate URL generation for the official CFPB dashboard."""
12 |     print('=' * 70)
   |
help: Add return type annotation: `None`

INP001 File `scripts/run_tests.py` is part of an implicit namespace package. Add an `__init__.py`.
--> scripts/run_tests.py:1:1

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:17
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> scripts/run_tests.py:21:33
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).parent`

PTH100 `os.path.abspath()` should be replaced by `Path.resolve()`
  --> scripts/run_tests.py:21:49
   |
19 |     # When this script is executed as `python scripts/run_tests.py`, Python sets
20 |     # sys.path[0] to the scripts/ directory, which can break imports like `import server`.
21 |     repo_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
   |                                                 ^^^^^^^^^^^^^^^
22 |     os.chdir(repo_root)
23 |     if repo_root not in sys.path:
   |
help: Replace with `Path(...).resolve()`

PLR0911 Too many return statements (7 > 6)
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

D103 Missing docstring in public function
  --> scripts/run_tests.py:29:5
   |
29 | def main() -> int:
   |     ^^^^
30 |     parser = argparse.ArgumentParser(
31 |         description='Run pytest suites for this repo (unit/integration/slow/contract/full).'
   |

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:56:24
   |
55 |     if ns.suite == 'unit':
56 |         return _pytest(default_args + ['-m', 'unit'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
57 |
58 |     if ns.suite == 'integration':
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:60:24
   |
58 |     if ns.suite == 'integration':
59 |         # Includes anything under tests/ except slow/unit/contract.
60 |         return _pytest(default_args + ['-m', 'integration'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |     if ns.suite == 'slow':
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:63:24
   |
62 |     if ns.suite == 'slow':
63 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |
65 |     if ns.suite == 'contract':
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'contract', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:66:24
   |
65 |     if ns.suite == 'contract':
66 |         return _pytest(default_args + ['-m', 'contract', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     if ns.suite == 'full':
   |
help: Replace with `[*default_args, '-m', 'contract', '-rs', *extra]`

RUF005 Consider `[*default_args, '-m', 'unit', *extra]` instead of concatenation
  --> scripts/run_tests.py:70:22
   |
68 |     if ns.suite == 'full':
69 |         # Run unit, then integration, then slow.
70 |         rc = _pytest(default_args + ['-m', 'unit'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
71 |         if rc != 0:
72 |             return rc
   |
help: Replace with `[*default_args, '-m', 'unit', *extra]`

RUF005 Consider `[*default_args, '-m', 'integration', *extra]` instead of concatenation
  --> scripts/run_tests.py:74:22
   |
72 |             return rc
73 |
74 |         rc = _pytest(default_args + ['-m', 'integration'] + extra)
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
75 |         if rc != 0:
76 |             return rc
   |
help: Replace with `[*default_args, '-m', 'integration', *extra]`

RUF005 Consider `[*default_args, '-m', 'slow', '-rs', *extra]` instead of concatenation
  --> scripts/run_tests.py:77:24
   |
75 |         if rc != 0:
76 |             return rc
77 |         return _pytest(default_args + ['-m', 'slow', '-rs'] + extra)
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
78 |
79 |     _die(f'Unknown suite: {ns.suite}')
   |
help: Replace with `[*default_args, '-m', 'slow', '-rs', *extra]`

INP001 File `tests/conftest.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/conftest.py:1:1

ARG001 Unused function argument: `config`
  --> tests/conftest.py:15:35
   |
15 | def pytest_collection_modifyitems(config: pytest.Config, items: list[pytest.Item]) -> None:
   |                                   ^^^^^^
16 |     """Apply suite markers based on file path.
   |

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/conftest.py:46:29
   |
44 |     try:
45 |         r = httpx.get(f'{url}/', timeout=5)
46 |         if r.status_code != 200:
   |                             ^^^
47 |             return False
48 |         payload = r.json()
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:57:15
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:57:26
   |
55 |     parsed = urlparse(url)
56 |     if parsed.scheme not in {'http', 'https'}:
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:59:15
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:59:26
   |
57 |         raise ValueError(f'Unsupported scheme in TEST_SERVER_URL: {url}')
58 |     if not parsed.hostname or parsed.port is None:
59 |         raise ValueError(f'TEST_SERVER_URL must include hostname and port: {url}')
   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
60 |     return str(parsed.hostname), int(parsed.port)
   |
help: Assign to variable; remove f-string literal

TRY003 Avoid specifying long messages outside the exception class
  --> tests/conftest.py:84:23
   |
82 |               host, port = _parse_host_port(url)
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
   |  _______________________^
85 | |                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
87 | |                 )
   | |_________________^
88 |       else:
89 |           port = _pick_free_port()
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/conftest.py:85:21
   |
83 |               if host not in {'127.0.0.1', 'localhost'}:
84 |                   raise RuntimeError(
85 | /                     f'TEST_SERVER_URL was set to {url} but it is not reachable, and the host is not local; '
86 | |                     'refusing to auto-start uvicorn.'
   | |_____________________________________________________^
87 |                   )
88 |       else:
   |
help: Assign to variable; remove f-string literal

SIM115 Use a context manager for opening files
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:103:16
    |
102 |     # Create a log file for the server process to avoid pipe buffer deadlocks
103 |     log_file = open('server_test.log', 'w')
    |                ^^^^
104 |
105 |     proc = subprocess.Popen(
    |
help: Replace with `Path.open()`

S603 `subprocess` call: check for execution of untrusted input
   --> tests/conftest.py:105:12
    |
103 |     log_file = open('server_test.log', 'w')
104 |
105 |     proc = subprocess.Popen(
    |            ^^^^^^^^^^^^^^^^
106 |         [
107 |             sys.executable,
    |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:13
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
   --> tests/conftest.py:118:29
    |
116 |             'warning',
117 |         ],
118 |         cwd=os.path.dirname(os.path.dirname(__file__)),
    |                             ^^^^^^^^^^^^^^^
119 |         env=env,
120 |         stdout=log_file,
    |
help: Replace with `Path(...).parent`

PTH123 `open()` should be replaced by `Path.open()`
   --> tests/conftest.py:141:18
    |
139 |             # If it failed, read the log file
140 |             log_file.close()
141 |             with open('server_test.log') as f:
    |                  ^^^^
142 |                 output = f.read()
143 |             raise RuntimeError(
    |
help: Replace with `Path.open()`

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:143:19
    |
141 |               with open('server_test.log') as f:
142 |                   output = f.read()
143 |               raise RuntimeError(
    |  ___________________^
144 | |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
145 | |             )
    | |_____________^
146 |
147 |           # Final readiness check
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:144:17
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
145 |             )
    |
help: Assign to variable; remove f-string literal

E501 Line too long (122 > 120)
   --> tests/conftest.py:144:121
    |
142 |                 output = f.read()
143 |             raise RuntimeError(
144 |                 f'Server process exited early while starting on {url}. Last error: {last_err}.\nProcess output:\n{output}'
    |                                                                                                                         ^^
145 |             )
    |

TRY003 Avoid specifying long messages outside the exception class
   --> tests/conftest.py:149:19
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |

EM102 Exception must not use an f-string literal, assign to variable first
   --> tests/conftest.py:149:32
    |
147 |         # Final readiness check
148 |         if not _is_server_ready(url):
149 |             raise RuntimeError(f'Server failed to become ready on {url}. Last error: {last_err}.')
    |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         yield url
    |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
   --> tests/conftest.py:168:5
    |
167 | @pytest.fixture
168 | def client(server_url: str) -> Iterator[httpx.Client]:
    |     ^^^^^^
169 |     with httpx.Client(base_url=server_url, timeout=30) as c:
170 |         yield c
    |

INP001 File `tests/contract/test_anthropic_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_anthropic_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_anthropic_mcp_contract.py:23:16
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_anthropic_mcp_contract.py:23:29
   |
21 | def _load_dotenv_if_present() -> None:
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
24 |     if not os.path.exists(env_path):
25 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_anthropic_mcp_contract.py:24:12
   |
22 |     """Load .env for local runs without requiring external tooling."""
23 |     env_path = os.path.join(os.getcwd(), '.env')
24 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
25 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_anthropic_mcp_contract.py:28:14
   |
27 |     try:
28 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
29 |             for raw_line in f:
30 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

ANN001 Missing type annotation for function argument `blocks`
  --> tests/contract/test_anthropic_mcp_contract.py:43:19
   |
43 | def _extract_text(blocks) -> str:
   |                   ^^^^^^
44 |     if not isinstance(blocks, list):
45 |         return str(blocks or '')
   |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `payload`
  --> tests/contract/test_anthropic_mcp_contract.py:53:32
   |
53 | def _tool_result_text(payload: Any) -> str:
   |                                ^^^
54 |     if payload is None:
55 |         return ''
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:12
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |            ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_anthropic_mcp_contract.py:92:31
   |
90 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
91 |     token = max(matches, key=len)
92 |     assert 4 <= len(token) <= 9
   |                               ^
93 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:8
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |        ^
121 |         return cid_int
122 |     return None
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:120:34
    |
118 |     except ValueError:
119 |         return None
120 |     if 4 <= len(str(cid_int)) <= 9:
    |                                  ^
121 |         return cid_int
122 |     return None
    |

D103 Missing docstring in public function
   --> tests/contract/test_anthropic_mcp_contract.py:128:11
    |
126 | @pytest.mark.fast
127 | @pytest.mark.anyio
128 | async def test_anthropic_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:143:121
    |
141 |     user_prompt = (
142 |         "I'm researching CFPB consumer complaints about loan forbearance. "
143 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
144 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
145 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_anthropic_mcp_contract.py:153:5
    |
152 |       # Connect using Streamable HTTP client
153 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
154 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
155 |               await mcp.initialize()
156 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

ERA001 Found commented-out code
   --> tests/contract/test_anthropic_mcp_contract.py:184:17
    |
182 |                 messages.append(cast('MessageParam', {'role': 'assistant', 'content': resp.content}))
183 |
184 |                 # tool_uses = [c for c in resp.content if getattr(c, "type", None) == "tool_use"]
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
185 |                 tool_uses: list[ToolUseBlock] = [c for c in resp.content if isinstance(c, ToolUseBlock)]
    |
help: Remove commented-out code

E501 Line too long (161 > 120)
   --> tests/contract/test_anthropic_mcp_contract.py:197:121
    |
195 | …
196 | …
197 | … now (complaint id, company, state if present, and a 2-3 sentence grounded summary).',
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
198 | …
199 | …
    |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:20
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
244 |             assert str(complaint_id_from_tools) in text
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_anthropic_mcp_contract.py:243:62
    |
242 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
243 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
244 |             assert str(complaint_id_from_tools) in text
    |

INP001 File `tests/contract/test_openai_mcp_contract.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/contract/test_openai_mcp_contract.py:1:1

PTH118 `os.path.join()` should be replaced by `Path` with `/` operator
  --> tests/contract/test_openai_mcp_contract.py:17:16
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                ^^^^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |

PTH109 `os.getcwd()` should be replaced by `Path.cwd()`
  --> tests/contract/test_openai_mcp_contract.py:17:29
   |
15 | def _load_dotenv_if_present() -> None:
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
   |                             ^^^^^^^^^
18 |     if not os.path.exists(env_path):
19 |         return
   |
help: Replace with `Path.cwd()`

PTH110 `os.path.exists()` should be replaced by `Path.exists()`
  --> tests/contract/test_openai_mcp_contract.py:18:12
   |
16 |     """Load .env for local runs without requiring external tooling."""
17 |     env_path = os.path.join(os.getcwd(), '.env')
18 |     if not os.path.exists(env_path):
   |            ^^^^^^^^^^^^^^
19 |         return
   |
help: Replace with `Path(...).exists()`

PTH123 `open()` should be replaced by `Path.open()`
  --> tests/contract/test_openai_mcp_contract.py:22:14
   |
21 |     try:
22 |         with open(env_path, encoding='utf-8') as f:
   |              ^^^^
23 |             for raw_line in f:
24 |                 line = raw_line.strip()
   |
help: Replace with `Path.open()`

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:12
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |            ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:41:31
   |
39 |     assert matches, 'Expected a 4-9 digit integer token in the final response text'
40 |     token = max(matches, key=len)
41 |     assert 4 <= len(token) <= 9
   |                               ^
42 |     return int(token), token
   |

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:8
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
88 |         return cid_int
89 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/contract/test_openai_mcp_contract.py:87:34
   |
85 |     except ValueError:
86 |         return None
87 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
88 |         return cid_int
89 |     return None
   |

D103 Missing docstring in public function
   --> tests/contract/test_openai_mcp_contract.py:125:11
    |
123 | @pytest.mark.fast
124 | @pytest.mark.anyio
125 | async def test_openai_mcp_tool_loop_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |     _load_dotenv_if_present()
    |

E501 Line too long (125 > 120)
   --> tests/contract/test_openai_mcp_contract.py:139:121
    |
137 |     prompt = (
138 |         "I'm researching CFPB consumer complaints about loan forbearance. "
139 |         "Please find a complaint mentioning 'forbearance' where the company name is present, then tell me the complaint id, "
    |                                                                                                                         ^^^^^
140 |         'the company (if present), the state (if present), and a short 2-3 sentence summary grounded in the complaint. '
141 |         "If you can't use tools, say 'MCP tools unavailable'."
    |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
   --> tests/contract/test_openai_mcp_contract.py:149:5
    |
147 |       tool_calls_seen = False
148 |
149 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
150 | |         async with ClientSession(read_stream, write_stream) as mcp:
    | |___________________________________________________________________^
151 |               await mcp.initialize()
152 |               tool_list = await mcp.list_tools()
    |
help: Combine `with` statements

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:20
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                    ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
   --> tests/contract/test_openai_mcp_contract.py:262:62
    |
261 |             assert complaint_id_from_tools is not None, 'Expected the agent to obtain a complaint id via tools'
262 |             assert 4 <= len(str(complaint_id_from_tools)) <= 9
    |                                                              ^
263 |
264 |             complaint_id_from_text, _ = _extract_complaint_id_from_text(text)
    |

INP001 File `tests/playwright_helpers.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/playwright_helpers.py:1:1

ANN201 Missing return type annotation for public function `fast_playwright_context`
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |
help: Add return type annotation

D103 Missing docstring in public function
 --> tests/playwright_helpers.py:7:11
  |
6 | @asynccontextmanager
7 | async def fast_playwright_context():
  |           ^^^^^^^^^^^^^^^^^^^^^^^
8 |     try:
9 |         from playwright.async_api import async_playwright
  |

PLC0415 `import` should be at the top-level of a file
  --> tests/playwright_helpers.py:9:9
   |
 7 | async def fast_playwright_context():
 8 |     try:
 9 |         from playwright.async_api import async_playwright
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/playwright_helpers.py:11:15
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/playwright_helpers.py:11:28
   |
 9 |         from playwright.async_api import async_playwright
10 |     except Exception as exc:
11 |         raise RuntimeError(f'Playwright unavailable for UI verification: {exc}') from exc
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 |     async with async_playwright() as p:
   |
help: Assign to variable; remove f-string literal

ANN202 Missing return type annotation for private function `_block_heavy_assets`
  --> tests/playwright_helpers.py:17:19
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                   ^^^^^^^^^^^^^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |
help: Add return type annotation: `None`

ANN001 Missing type annotation for function argument `route`
  --> tests/playwright_helpers.py:17:39
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                       ^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

ANN001 Missing type annotation for function argument `request`
  --> tests/playwright_helpers.py:17:46
   |
15 |         context = await browser.new_context()
16 |
17 |         async def _block_heavy_assets(route, request):
   |                                              ^^^^^^^
18 |             if request.resource_type in {'image', 'media', 'font'}:
19 |                 await route.abort()
   |

INP001 File `tests/test_citations.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_citations.py:1:1

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> tests/test_citations.py:5:29
  |
3 | import asyncio
4 | import re
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from datetime import date
7 | from typing import Any
  |
help: Move into type-checking block

TRY003 Avoid specifying long messages outside the exception class
   --> tests/test_citations.py:133:11
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |

EM101 Exception must not use a string literal, assign to variable first
   --> tests/test_citations.py:133:22
    |
131 |         if match:
132 |             return int(match.group(1).replace(',', ''))
133 |     raise ValueError('Unable to locate matches-out-of count in UI text.')
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
help: Assign to variable; remove string literal

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
   --> tests/test_citations.py:138:32
    |
136 | async def _fetch_api_total(client: httpx.AsyncClient, api_params: Mapping[str, Any]) -> int:
137 |     response = await client.get(BASE_URL, params=api_params)
138 |     if response.status_code != 200:
    |                                ^^^
139 |         pytest.fail(f'API call failed: {response.url} ({response.status_code})')
    |

D103 Missing docstring in public function
   --> tests/test_citations.py:153:11
    |
152 | @pytest.fixture(scope='module')
153 | async def api_client() -> httpx.AsyncClient:
    |           ^^^^^^^^^^
154 |     async with httpx.AsyncClient(timeout=20.0) as client:
155 |         yield client
    |

ANN201 Missing return type annotation for public function `ui_context`
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |
help: Add return type annotation

D103 Missing docstring in public function
   --> tests/test_citations.py:159:11
    |
158 | @pytest.fixture(scope='module')
159 | async def ui_context():
    |           ^^^^^^^^^^
160 |     try:
161 |         async with fast_playwright_context() as context:
    |

ANN201 Missing return type annotation for public function `test_map_api_params_to_url_params_examples`
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:168:5
    |
167 | @pytest.mark.fast
168 | def test_map_api_params_to_url_params_examples():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
169 |     api_params = {
170 |         'search_term': 'mortgage',
    |

PLR2004 Magic value used in comparison, consider replacing `25` with a constant variable
   --> tests/test_citations.py:179:30
    |
177 |     assert mapped['searchText'] == 'mortgage'
178 |     assert mapped['searchField'] == 'all'
179 |     assert mapped['size'] == 25
    |                              ^^
180 |     assert mapped['sort'] == 'created_date_desc'
    |

ANN201 Missing return type annotation for public function `test_trend_mapping_defaults`
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:204:5
    |
203 | @pytest.mark.fast
204 | def test_trend_mapping_defaults():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
205 |     url = build_deeplink_url(EXAMPLE_TREND_QUERY, today=FIXED_TODAY)
206 |     query = _parse_query(url)
    |

ANN201 Missing return type annotation for public function `test_default_date_window`
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:217:5
    |
216 | @pytest.mark.fast
217 | def test_default_date_window():
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
218 |     params = apply_default_dates({}, today=FIXED_TODAY)
219 |     assert params['date_received_min'] == '2011-12-01'
    |

ANN201 Missing return type annotation for public function `test_ui_vs_api_counts`
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |
help: Add return type annotation: `None`

D103 Missing docstring in public function
   --> tests/test_citations.py:227:11
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |           ^^^^^^^^^^^^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_params`
   --> tests/test_citations.py:227:33
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                 ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `api_client`
   --> tests/test_citations.py:227:45
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                             ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

ANN001 Missing type annotation for function argument `ui_context`
   --> tests/test_citations.py:227:57
    |
225 | @pytest.mark.anyio
226 | @pytest.mark.parametrize('api_params', EXAMPLE_API_QUERIES)
227 | async def test_ui_vs_api_counts(api_params, api_client, ui_context):
    |                                                         ^^^^^^^^^^
228 |     api_params_with_dates = apply_default_dates(api_params, today=FIXED_TODAY)
229 |     url = build_deeplink_url(api_params_with_dates, tab='List', today=FIXED_TODAY)
    |

SIM105 Use `contextlib.suppress(Exception)` instead of `try`-`except`-`pass`
   --> tests/test_citations.py:235:9
    |
233 |       try:
234 |           await page.goto(url, wait_until='domcontentloaded', timeout=60000)
235 | /         try:
236 | |             await page.wait_for_function(
237 | |                 'document.body && /matches out of/i.test(document.body.innerText)',
238 | |                 timeout=20000,
239 | |             )
240 | |         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(Exception): ...`

S110 `try`-`except`-`pass` detected, consider logging the exception
   --> tests/test_citations.py:240:9
    |
238 |                   timeout=20000,
239 |               )
240 | /         except Exception:
241 | |             pass
    | |________________^
242 |           ui_text = await page.inner_text('body')
243 |       finally:
    |

BLE001 Do not catch blind exception: `Exception`
   --> tests/test_citations.py:240:16
    |
238 |                 timeout=20000,
239 |             )
240 |         except Exception:
    |                ^^^^^^^^^
241 |             pass
242 |         ui_text = await page.inner_text('body')
    |

INP001 File `tests/test_mcp_auth.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_auth.py:1:1

PLR2004 Magic value used in comparison, consider replacing `200` with a constant variable
  --> tests/test_mcp_auth.py:30:29
   |
28 |     try:
29 |         r = httpx.get(f'{url}/', timeout=5)
30 |         if r.status_code != 200:
   |                             ^^^
31 |             return False
32 |         payload = r.json()
   |

S603 `subprocess` call: check for execution of untrusted input
  --> tests/test_mcp_auth.py:47:35
   |
45 |     env.update(env_overrides)
46 |
47 |     proc: subprocess.Popen[str] = subprocess.Popen(
   |                                   ^^^^^^^^^^^^^^^^
48 |         [
49 |             sys.executable,
   |

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:13
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

PTH120 `os.path.dirname()` should be replaced by `Path.parent`
  --> tests/test_mcp_auth.py:60:29
   |
58 |             'warning',
59 |         ],
60 |         cwd=os.path.dirname(os.path.dirname(__file__)),
   |                             ^^^^^^^^^^^^^^^
61 |         env=env,
62 |         stdout=subprocess.PIPE,
   |
help: Replace with `Path(...).parent`

TRY301 Abstract `raise` to an inner function
  --> tests/test_mcp_auth.py:79:9
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

TRY003 Avoid specifying long messages outside the exception class
  --> tests/test_mcp_auth.py:79:15
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |

EM102 Exception must not use an f-string literal, assign to variable first
  --> tests/test_mcp_auth.py:79:28
   |
77 |         if proc.stdout is not None:
78 |             output = proc.stdout.read() or ''
79 |         raise RuntimeError(f'Auth test server failed to start on {url}. Output:\n{output}')
   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
80 |     except Exception:
81 |         if proc.poll() is None:
   |
help: Assign to variable; remove f-string literal

D103 Missing docstring in public function
  --> tests/test_mcp_auth.py:92:5
   |
91 | @pytest.fixture(scope='module')
92 | def auth_server_url() -> Iterator[str]:
   |     ^^^^^^^^^^^^^^^
93 |     key = _dev_testing_api_key()
94 |     proc, url = _start_server(env_overrides={'CFPB_MCP_API_KEYS': key})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:108:5
    |
107 | @pytest.fixture(scope='module')
108 | def rate_limited_auth_server_url() -> Iterator[str]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
109 |     key = _dev_testing_api_key()
110 |     proc, url = _start_server(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:129:5
    |
129 | def test_mcp_http_requires_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:132:33
    |
130 |     with httpx.Client(timeout=5) as client:
131 |         r = client.post(f'{auth_server_url}/mcp', json={})
132 |         assert r.status_code == 401
    |                                 ^^^
133 |         assert (r.headers.get('content-type') or '').startswith('application/json')
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:136:5
    |
136 | def test_mcp_http_allows_valid_api_key(auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
137 |     key = _dev_testing_api_key()
138 |     with httpx.Client(timeout=5) as client:
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:147:33
    |
145 |             json={'jsonrpc': '2.0', 'id': 1, 'method': 'tools/list'},
146 |         )
147 |         assert r.status_code != 401
    |                                 ^^^
    |

D103 Missing docstring in public function
   --> tests/test_mcp_auth.py:150:5
    |
150 | def test_mcp_rate_limit_429(rate_limited_auth_server_url: str) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
151 |     key = _dev_testing_api_key()
152 |     with httpx.Client(timeout=5) as client:
    |

PLR2004 Magic value used in comparison, consider replacing `401` with a constant variable
   --> tests/test_mcp_auth.py:158:34
    |
156 |             json={},
157 |         )
158 |         assert r1.status_code != 401
    |                                  ^^^
159 |         assert r1.status_code != 429
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:159:34
    |
157 |         )
158 |         assert r1.status_code != 401
159 |         assert r1.status_code != 429
    |                                  ^^^
160 |
161 |         r2 = client.post(
    |

PLR2004 Magic value used in comparison, consider replacing `429` with a constant variable
   --> tests/test_mcp_auth.py:166:34
    |
164 |             json={},
165 |         )
166 |         assert r2.status_code == 429
    |                                  ^^^
    |

INP001 File `tests/test_mcp_endpoints.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/test_mcp_endpoints.py:1:1

PLR2004 Magic value used in comparison, consider replacing `4` with a constant variable
  --> tests/test_mcp_endpoints.py:69:8
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |        ^
70 |         return cid_int
71 |     return None
   |

PLR2004 Magic value used in comparison, consider replacing `9` with a constant variable
  --> tests/test_mcp_endpoints.py:69:34
   |
67 |     except ValueError:
68 |         return None
69 |     if 4 <= len(str(cid_int)) <= 9:
   |                                  ^
70 |         return cid_int
71 |     return None
   |

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/test_mcp_endpoints.py:76:5
   |
74 |   async def _with_mcp(server_url: str, action: Callable[[ClientSession], Awaitable[None]]) -> None:
75 |       mcp_url = f'{server_url}/mcp'
76 | /     async with streamable_http_client(mcp_url) as (read_stream, write_stream, _):
77 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
78 |               await mcp.initialize()
79 |               await action(mcp)
   |
help: Combine `with` statements

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:82:11
   |
82 | async def test_tools_list_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^^^^^
83 |     async def _run(mcp: ClientSession) -> None:
84 |         tools = await mcp.list_tools()
   |

D103 Missing docstring in public function
  --> tests/test_mcp_endpoints.py:97:11
   |
97 | async def test_search_smoke(server_url: str) -> None:
   |           ^^^^^^^^^^^^^^^^^
98 |     async def _run(mcp: ClientSession) -> None:
99 |         result = await mcp.call_tool('search_complaints', {'size': 1})
   |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:109:11
    |
109 | async def test_trends_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^
110 |     async def _run(mcp: ClientSession) -> None:
111 |         result = await mcp.call_tool('list_complaint_trends', {'trend_depth': 5})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:120:11
    |
120 | async def test_geo_states_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^
121 |     async def _run(mcp: ClientSession) -> None:
122 |         result = await mcp.call_tool('get_state_aggregations', {})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:132:11
    |
131 | @pytest.mark.parametrize('field', ['company', 'zip_code'])
132 | async def test_suggest_smoke(server_url: str, field: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^
133 |     async def _run(mcp: ClientSession) -> None:
134 |         result = await mcp.call_tool(
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> tests/test_mcp_endpoints.py:142:32
    |
140 |             payload = [line.strip() for line in payload.splitlines() if line.strip()]
141 |         assert isinstance(payload, list)
142 |         assert len(payload) <= 3
    |                                ^
143 |
144 |     await _with_mcp(server_url, _run)
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:147:11
    |
147 | async def test_document_round_trip_from_search(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
148 |     async def _run(mcp: ClientSession) -> None:
149 |         search_result = await mcp.call_tool('search_complaints', {'size': 1})
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:161:11
    |
161 | async def test_signals_overall_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
162 |     async def _run(mcp: ClientSession) -> None:
163 |         date_min, date_max, current_month_prefix = _default_date_window()
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:180:11
    |
179 | @pytest.mark.parametrize('group', ['product', 'issue'])
180 | async def test_signals_group_smoke(server_url: str, group: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^
181 |     async def _run(mcp: ClientSession) -> None:
182 |         date_min, date_max, _ = _default_date_window()
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:196:32
    |
194 |         results = payload.get('results')
195 |         assert isinstance(results, list)
196 |         assert len(results) <= 5
    |                                ^
197 |         if results:
198 |             row0 = results[0]
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:206:11
    |
206 | async def test_signals_company_smoke(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^
207 |     async def _run(mcp: ClientSession) -> None:
208 |         date_min, date_max, _ = _default_date_window()
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> tests/test_mcp_endpoints.py:221:32
    |
219 |         results = payload.get('results')
220 |         assert isinstance(results, list)
221 |         assert len(results) <= 5
    |                                ^
222 |         if results:
223 |             row0 = results[0]
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:231:11
    |
231 | async def test_generate_cfpb_dashboard_url(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
232 |     async def _run(mcp: ClientSession) -> None:
233 |         result = await mcp.call_tool(
    |

D103 Missing docstring in public function
   --> tests/test_mcp_endpoints.py:247:11
    |
247 | async def test_capture_cfpb_chart_screenshot(server_url: str) -> None:
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
248 |     async def _run(mcp: ClientSession) -> None:
249 |         try:
    |

PLR2004 Magic value used in comparison, consider replacing `1000` with a constant variable
   --> tests/test_mcp_endpoints.py:264:31
    |
262 |             payload = payload['result']
263 |         assert isinstance(payload, str)
264 |         assert len(payload) > 1000
    |                               ^^^^
265 |
266 |     await _with_mcp(server_url, _run)
    |

INP001 File `tests/transport/http/test_http_transport.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/transport/http/test_http_transport.py:1:1

SIM117 Use a single `with` statement with multiple contexts instead of nested `with` statements
  --> tests/transport/http/test_http_transport.py:12:5
   |
10 |       """Verify that the Streamable HTTP endpoint (POST /mcp) works."""
11 |       url = f'{server_url}/mcp'
12 | /     async with streamable_http_client(url) as (read_stream, write_stream, _):
13 | |         async with ClientSession(read_stream, write_stream) as mcp:
   | |___________________________________________________________________^
14 |               await mcp.initialize()
15 |               tools = await mcp.list_tools()
   |
help: Combine `with` statements

PLR2004 Magic value used in comparison, consider replacing `405` with a constant variable
  --> tests/transport/http/test_http_transport.py:25:40
   |
23 |     async with httpx.AsyncClient() as client:
24 |         response = await client.get(url)
25 |         assert response.status_code == 405
   |                                        ^^^
   |

INP001 File `tests/unit/test_params.py` is part of an implicit namespace package. Add an `__init__.py`.
--> tests/unit/test_params.py:1:1

D103 Missing docstring in public function
 --> tests/unit/test_params.py:6:5
  |
6 | def test_prune_params_drops_none_and_empty_strings() -> None:
  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |     assert prune_params({'a': None, 'b': '', 'c': '  ', 'd': 'ok'}) == {'d': 'ok'}
  |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:10:5
   |
10 | def test_prune_params_drops_empty_lists_and_empty_list_items() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     assert prune_params({'a': [], 'b': [''], 'c': [' ', None], 'd': ['x', '', 'y']}) == {'d': ['x', 'y']}
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:14:5
   |
14 | def test_prune_params_keeps_non_string_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
15 |     assert prune_params({'a': 0, 'b': False, 'c': True, 'd': 3.14}) == {
16 |         'a': 0,
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:23:5
   |
23 | def test_prune_params_normalizes_boolean_like_strings() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
24 |     assert prune_params({'a': 'True', 'b': 'false', 'c': ['FALSE', 'ok']}) == {
25 |         'a': 'true',
   |

D103 Missing docstring in public function
  --> tests/unit/test_params.py:31:5
   |
31 | def test_build_params_filters_empty_values() -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
32 |     params = build_params(
33 |         search_term='',
   |

PT006 Wrong type passed to first argument of `pytest.mark.parametrize`; expected `tuple`
  --> tests/unit/test_params.py:51:5
   |
50 | @pytest.mark.parametrize(
51 |     'raw,expected',
   |     ^^^^^^^^^^^^^^
52 |     [
53 |         ({'x': 'y'}, {'x': 'y'}),
   |
help: Use a `tuple` for the first argument

D103 Missing docstring in public function
  --> tests/unit/test_params.py:58:5
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |     ^^^^^^^^^^^^^^^^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `raw`
  --> tests/unit/test_params.py:58:29
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                             ^^^
59 |     assert prune_params(raw) == expected
   |

ANN001 Missing type annotation for function argument `expected`
  --> tests/unit/test_params.py:58:34
   |
56 |     ],
57 | )
58 | def test_prune_params_smoke(raw, expected) -> None:
   |                                  ^^^^^^^^
59 |     assert prune_params(raw) == expected
   |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> utils/deeplink_mapping.py:4:29
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                             ^^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> utils/deeplink_mapping.py:4:39
  |
3 | import re
4 | from collections.abc import Iterable, Mapping
  |                                       ^^^^^^^
5 | from dataclasses import dataclass
6 | from datetime import date, timedelta
  |
help: Move into type-checking block

D101 Missing docstring in public class
   --> utils/deeplink_mapping.py:119:7
    |
118 | @dataclass(frozen=True)
119 | class ValidationResult:
    |       ^^^^^^^^^^^^^^^^
120 |     unknown_keys: tuple[str, ...]
121 |     allowed_keys: tuple[str, ...]
    |

PLR0911 Too many return statements (8 > 6)
   --> utils/deeplink_mapping.py:124:5
    |
124 | def _clean_value(value: Any) -> Any | None:
    |     ^^^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:124:25
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                         ^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `_clean_value`
   --> utils/deeplink_mapping.py:124:33
    |
124 | def _clean_value(value: Any) -> Any | None:
    |                                 ^^^^^^^^^^
125 |     if value is None:
126 |         return None
    |

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `value`
   --> utils/deeplink_mapping.py:150:23
    |
150 | def _parse_int(value: Any) -> int | None:
    |                       ^^^
151 |     if value is None:
152 |         return None
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:175:5
    |
175 | def normalize_api_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^
176 |     normalized: dict[str, Any] = {}
177 |     for key, raw_value in api_params.items():
    |

DTZ011 `datetime.date.today()` used
   --> utils/deeplink_mapping.py:191:23
    |
189 | def _default_end_date(today: date | None = None) -> str:
190 |     """Return the last day of the month before (today - 30 days)."""
191 |     anchor = today or date.today()
    |                       ^^^^^^^^^^^^
192 |     cutoff = anchor - timedelta(days=30)
193 |     first_of_cutoff_month = cutoff.replace(day=1)
    |
help: Use `datetime.datetime.now(tz=...).date()` instead

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:210:5
    |
210 | def validate_api_params(api_params: Mapping[str, Any], allowed_keys: Iterable[str]) -> ValidationResult:
    |     ^^^^^^^^^^^^^^^^^^^
211 |     allowed = set(allowed_keys)
212 |     unknown = tuple(sorted(key for key in api_params if key not in allowed))
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:216:5
    |
216 | def api_params_to_url_params(api_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
217 |     url_params: dict[str, Any] = {}
218 |     normalized = normalize_api_params(api_params)
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:243:5
    |
243 | def build_deeplink_url(
    |     ^^^^^^^^^^^^^^^^^^
244 |     api_params: Mapping[str, Any],
245 |     *,
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:263:5
    |
263 | def url_params_to_api_params(url_params: Mapping[str, Any]) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^
264 |     api_params: dict[str, Any] = {}
265 |     for key, raw_value in url_params.items():
    |

D103 Missing docstring in public function
   --> utils/deeplink_mapping.py:287:5
    |
287 | def url_to_api_params(url: str) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^
288 |     parsed = urlparse(url)
289 |     query = parse_qs(parsed.query)
    |

Found 166 errors.
No fixes available (26 hidden fixes can be enabled with the `--unsafe-fixes` option).

=== pyright (pylance engine) ===
cmd: /Users/jim/cfpb-mcp/.venv/bin/python3 -m pyright /Users/jim/cfpb-mcp
exit_code: 1
--- stderr ---
/Users/jim/cfpb-mcp/.venv/bin/python3: No module named pyright
--- stdout ---
(no output)

